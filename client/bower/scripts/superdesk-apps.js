function BaseListController(a,b,c,d,e,f,g,h){var i=this,j={};a.selected={},a.openLightbox=function(){a.selected.view=a.selected.preview},a.closeLightbox=function(){a.selected.view=null},a.$on("$routeUpdate",function(c,d){b.search()._id||(a.selected.preview=null),b.search().fetch&&i.fetchItem(decodeURIComponent(b.search().fetch)).then(function(b){a.selected.preview=null,a.selected.fetch=b}),b.search().fetch||(a.selected.fetch=null)}),this.buildQuery=function(a,b){var c=e.query(a);return b&&(f.active.stage?c.filter({term:{"task.stage":f.active.stage}}):f.active.desk&&c.filter({term:{"task.desk":f.active.desk}})),c.getCriteria()},this.getQuery=function(a,c){_.isEqual(_.omit(a,"page"),_.omit(j,"page"))||b.search("page",null);var d=this.buildQuery(a,c);return j=a,d},this.fetchItems=function(a){console.log("no api defined")},this.fetchItem=function(a){console.log("no api defined")},this.refresh=function(a){var c=i.getQuery(_.omit(b.search(),"_id"),a);i.fetchItems({source:c})}}!function(){"use strict";function a(a,b,c,d,e,f){function g(a){function b(a,b){return a.name.localeCompare(b.name)}var c=a._items||[];return c.sort(b),c}var h;b.initialize().then(function(){a.desks=b.desks,a.deskStages=b.deskStages,b.fetchCurrentUserDesks().then(function(a){h=a._items})}),a.statuses=e.statuses,a.online_users=!1,f("roles").query().then(function(b){a.roles=g(b)}),a.privileges=d.privileges,a.views=["content","tasks","users","sluglines"],a.view=a.views[0],a.setView=function(b){a.view=b},a.changeOnlineUsers=function(b){a.online_users=b},a.isMemberOf=function(a){return _.find(h,{_id:a._id})},a.openDeskView=function(a,d){b.setCurrentDeskId(a._id),c.intent("view",d)},a.$on("desks:refresh:stages",function(c,d){b.refreshStages().then(function(){a.deskStages[d]=b.deskStages[d]})})}function b(a,b,c,d,e,f,g,h,i){return{templateUrl:"scripts/superdesk-desks/views/stage-item-list.html",scope:{stage:"=",total:"=",allowed:"=",showEmpty:"=?",maxItems:"=?",selected:"=?",action:"&",filter:"="},link:function(d,j){function k(){var a="archive";return!d.stage.type||"deskOutput"!==d.stage.type&&"search"!==d.stage.type||(a="search"),a}function l(a){p=e.criteria(d.stage,a),d.loading=!0,d.items=d.total=null,b(k()).query(p).then(function(a){d.items=a._items,d.total=a._meta.total,d.cachePreviousItems=a._items,m(p)})["finally"](function(){d.loading=!1})}function m(a){return a.source.from=d.page*a.source.size,b(k()).query(a).then(function(a){d.cacheNextItems=a._items})}function n(a){h.hash(a),i()}function o(a,b){d.select(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}var p;d.page=1,d.fetching=!1,d.cacheNextItems=[],d.cachePreviousItems=[],d.generateTrackByIdentifier=function(b){return a.generateTrackByIdentifier(b)},d.preview=function(a){c.intent("preview","item",a)},d.edit=function(a){c.intent("edit","item",a).then(null,function(){c.intent("view","item",a)})},d.$watch("filter",l),d.$on("task:stage",function(a,b){!d.stage||b.new_stage!==d.stage&&b.old_stage!==d.stage||l()}),d.$on("content:update",function(a,b){e.shouldUpdate(d.stage,b)&&l()}),d.$on("content:expired",l),d.$on("item:lock",function(a,b){_.each(d.items,function(a){a._id===b.item&&(a.lock_user=b.user)})}),d.$on("item:unlock",function(a,b){_.each(d.items,function(a){a._id===b.item&&(a.lock_user=null)})});var q=j[0],r=0;j.bind("scroll",function(){d.$apply(function(){q.scrollTop+q.offsetHeight>=q.scrollHeight-3&&(q.scrollTop=q.scrollTop-3,d.fetchNext()),q.scrollTop<=2&&(r=2-q.scrollTop,q.scrollTop=q.scrollTop+r,d.fetchPrevious())})}),d.fetchNext=function(){return d.fetching?g.when(!1):void(d.cacheNextItems.length>0&&(d.fetching=!0,d.page=d.page+1,p.source.from=d.page*p.source.size,d.loading=!0,d.items.length>p.source.size&&(d.cachePreviousItems=_.slice(d.items,0,p.source.size),d.items.splice(0,p.source.size)),f(function(){_.isEqual(d.items,d.cacheNextItems)||(d.items=d.items.concat(d.cacheNextItems))},100),b(k()).query(p).then(function(a){d.cacheNextItems=a._items,d.fetching=!1},function(){})["finally"](function(){d.loading=!1})))},d.fetchPrevious=function(){return!d.fetching&&d.page>2?(d.fetching=!0,d.page=d.page-1,d.page>2?p.source.from=(d.page-3)*p.source.size:p.source.from=0,d.loading=!0,d.items.length>p.source.size&&(d.cacheNextItems=_.slice(d.items,d.items.length-(d.items.length-p.source.size),d.items.length),d.items.splice(d.items.length-(d.items.length-p.source.size),p.source.size)),f(function(){d.items.unshift.apply(d.items,d.cachePreviousItems),d.items.length>0&&n(d.items[parseInt((d.items.length-1)/2,d.maxItems||10)]._id)},100),b(k()).query(p).then(function(a){d.cachePreviousItems=a._items,d.fetching=!1})["finally"](function(){d.loading=!1}),void 0):g.when(!1)};var s,t=-1,u=1;j.on("keyup",function(a){d.$apply(function(){a.keyCode?s=a.keyCode:a.which&&(s=a.which),38===s&&d.move(t,a),40===s&&(a.preventDefault(),d.move(u,a))})}),d.move=function(a,b){if(null!=d.selected&&d.selected.task.stage===d.stage&&d.items){var c=_.findIndex(d.items,{_id:d.selected._id});-1===c&&o(_.first(d.items),b);var e=_.max([0,_.min([d.items.length-1,c+a])]);0>e&&o(_.last(d.items),b),c!==e?(n(d.items[e]._id),o(d.items[e],b)):b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}},d.select=function(a){this.selected=a}}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-desks/views/task-status-items.html",scope:{status:"=",desk:"=",total:"="},link:function(d,e){d.users=c.userLookup;var f=a.query({});f.filter({and:[{term:{"task.status":d.status}},{term:{"task.desk":d.desk}}]}),f.size(10);var g={source:f.getCriteria()};d.loading=!0,b("archive").query(g).then(function(a){d.loading=!1,d.items=a._items,d.total=a._meta.total},function(){d.loading=!1})}}}function d(a,b){return{templateUrl:"scripts/superdesk-desks/views/user-role-items.html",scope:{role:"=",desk:"=",total:"=",online:"=",privilege:"="},link:function(c,d){c.users=a.deskMembers[c.desk],c.total=0,c.items=[],c.user=null,_.each(c.users,function(a,b){c.role===a.role&&(c.items.push(a),c.total=c.total+1)}),c.isLoggedIn=function(a){return b.isLoggedIn(a)},c.openEditUser=function(a){c.user=a},c.closeEditUser=function(){c.user=null}}}}function e(a){return{templateUrl:"scripts/superdesk-desks/views/slugline-items.html",scope:{desk:"="},link:function(b,c){b.items=[],b.loading=!0,a.get("desks/"+b.desk+"/sluglines").then(function(a){b.items=a._items})["finally"](function(){b.loading=!1})}}}function f(a,b){b.initialize().then(function(){a.desks=b.desks})}function g(a,b,c,d,e,f){a.modalActive=!1,a.numberOfUsers=3,a.step={current:null},a.desk={edit:null},a.openDesk=function(b,c){a.modalActive=!0,a.step.current=b,a.desk.edit=c},a.cancel=function(){a.modalActive=!1,a.step.current=null,a.desk.edit=null},a.remove=function(e){f.confirm(b("Please confirm you want to delete desk.")).then(function(){d.remove(e).then(function(d){_.remove(a.desks._items,function(a){return a.name.toLowerCase()===e.name.toLowerCase()}),c.success(b("Desk deleted."),3e3)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("Unknown Error: There was a problem, desk was not deleted."))})})},a.$on("desks:refresh:stages",function(){d.refreshStages()}),a.getDeskStages=function(a){return d.deskStages[a._id]},a.getDeskUsers=function(a){return d.deskMembers[a._id]}}function h(){return{templateUrl:"scripts/superdesk-desks/views/stage-header.html"}}a.$inject=["$scope","desks","superdesk","privileges","tasks","api"],b.$inject=["search","api","superdesk","desks","cards","$timeout","$q","$location","$anchorScroll"],c.$inject=["search","api","desks"],d.$inject=["desks","usersService"],e.$inject=["api"],f.$inject=["$scope","desks"],g.$inject=["$scope","gettext","notify","desks","WizardHandler","modal"];var i=angular.module("superdesk.desks",["superdesk.ui","superdesk.users","superdesk.authoring.widgets","superdesk.aggregate.widgets","superdesk.aggregate"]),j={stage:15,desk:40};return i.config(["superdeskProvider",function(b){b.activity("/desks/",{label:gettext("Master Desk"),description:gettext("Navigate through the newsroom"),templateUrl:"scripts/superdesk-desks/views/main.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:a,priority:-100,adminTools:!1,category:b.MENU_MAIN,privileges:{desks:1}}).activity("/settings/desks",{label:gettext("Desks"),controller:f,templateUrl:"scripts/superdesk-desks/views/settings.html",category:b.MENU_SETTINGS,priority:-800,privileges:{desks:1}})}]).config(["apiProvider",function(a){a.api("desks",{type:"http",backend:{rel:"desks"}})}]).factory("desks",["$q","api","preferencesService","userList","notify","session","$filter",function(a,b,c,d,e,f,g){function h(a){a.active&&a.active.desk===a.activeDeskId&&a.active.stage===a.activeStageId||(a.active={desk:a.activeDeskId,stage:a.activeStageId})}function i(a){return j=null,k=null,m.loading=null,a}var j,k,l=function(a,c,d){return c=c||1,d=d||[],b.query(a,{max_results:200,page:c}).then(function(b){return d=d.concat(b._items),b._links.next?(c++,l(a,c,d)):d})},m={desks:null,users:null,stages:null,deskLookup:{},stageLookup:{},userLookup:{},deskMembers:{},deskStages:{},loading:null,activeDeskId:null,activeStageId:null,active:{desk:null,stage:null},fetchDesks:function(){var a=this;return l("desks").then(function(b){b=g("sortByName")(b),a.desks={_items:b},_.each(b,function(b){a.deskLookup[b._id]=b})})},fetchUsers:function(){var a=this;return d.getAll().then(function(b){a.users={},a.users._items=b,_.each(b,function(b){a.userLookup[b._id]=b})})},fetchStages:function(){var a=this;return l("stages").then(function(b){a.stages={_items:b},_.each(b,function(b){a.stageLookup[b._id]=b})})},fetchDeskStages:function(b){function c(){return d.deskStages[b]}var d=this;return d.deskStages[b]?a.when().then(c):d.fetchStages().then(angular.bind(d,d.generateDeskStages)).then(c)},generateDeskMembers:function(){var b=this;return _.each(this.desks._items,function(a){b.deskMembers[a._id]=[],_.each(a.members,function(c,d){var e=_.find(b.users._items,{_id:c.user});e?b.deskMembers[a._id].push(e):console.error("Desk user not found for desk: %s , user missing: %s",a.name,c.user)})}),a.when()},generateDeskStages:function(){var b=this;return this.deskStages=_.groupBy(b.stages._items,"desk"),a.when()},fetchUserDesks:function(c){return b.get(c._links.self.href+"/desks").then(function(b){return b&&b._items&&(b._items=g("sortByName")(b._items)),a.when(b)})},fetchCurrentUserDesks:function(){var b=this;return b.userDesks?a.when(b.userDesks):this.fetchCurrentDeskId().then(angular.bind(f,f.getIdentity)).then(angular.bind(this,this.fetchUserDesks)).then(angular.bind(this,function(a){return b.userDesks=a,h(this),a}))},fetchCurrentDeskId:function(){var b=this;return b.activeDeskId?a.when(b.activeDeskId):c.get("desk:last_worked").then(function(a){return b.activeDeskId=null,angular.isDefined(a)&&(b.activeDeskId=a),b.activeDeskId})},fetchCurrentStageId:function(){var b=this;return b.activeStageId?a.when(b.activeStageId):c.get("stage:items").then(function(a){angular.isDefined(a)&&(b.activeStageId=angular.isArray(a)?a[0]:a)})},getCurrentDeskId:function(){return this.userDesks&&this.userDesks._items&&0!==this.userDesks._items.length?this.activeDeskId&&_.find(this.userDesks._items,{_id:this.activeDeskId})?this.activeDeskId:this.userDesks._items[0]._id:null},setCurrentDeskId:function(a){this.activeDeskId!==a&&(this.activeDeskId=a,this.activeStageId=null,h(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[]},"desk:last_worked"))},getCurrentStageId:function(){return this.activeStageId},setCurrentStageId:function(a){this.activeStageId!==a&&(this.activeStageId=a,h(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},fetchDeskById:function(a){return b.desks.getById(a)},getCurrentDesk:function(){return this.deskLookup[this.getCurrentDeskId()]||null},setWorkspace:function(a,b){a=a||null,b=b||null,(this.activeDeskId!==a||this.activeStageId!==b)&&(this.activeDeskId=a,this.activeStageId=b,h(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},initialize:function(){return this.loading||(this.fetchCurrentDeskId(),this.fetchCurrentStageId(),this.loading=this.fetchUsers().then(angular.bind(this,this.fetchDesks)).then(angular.bind(this,this.generateDeskMembers)).then(angular.bind(this,this.fetchStages)).then(angular.bind(this,this.generateDeskStages)).then(angular.bind(this,this.initActive))),this.loading},initActive:function(){h(this)},save:function(a,c){return b.save("desks",a,c).then(i)},remove:function(a){return b.remove(a).then(i)},refreshStages:function(){return this.fetchStages().then(angular.bind(this,this.generateDeskStages))},refreshUsers:function(){return this.fetchUsers().then(angular.bind(this,this.generateDeskMembers))},getItemDesk:function(a){return a.task&&a.task.desk?this.deskLookup[a.task.desk]||null:void 0}};return m}]).directive("sdStageItems",b).directive("sdTaskStatusItems",c).directive("sdUserRoleItems",d).directive("sdSluglinesItems",e).directive("sdDeskConfig",function(){return{controller:g}}).directive("sdDeskConfigModal",function(){return{scope:{modalActive:"=active",desk:"=",step:"=",desks:"=",cancel:"&"},require:"^sdDeskConfig",templateUrl:"scripts/superdesk-desks/views/desk-config-modal.html",link:function(a,b,c,d){}}}).directive("sdFocusElement",[function(){return{link:function(a,b,c){b.click(function(){_.defer(function(){angular.element(document.querySelector(c.target)).focus()})})}}}]).directive("sdContentExpiry",[function(){return{templateUrl:"scripts/superdesk-desks/views/content-expiry.html",scope:{item:"=",preview:"=",header:"@"},link:function(a,b,c){function d(a){return Math.floor(a/60)}function e(a){return Math.floor(a%60)}function f(a){return 60*a.Hours+a.Minutes}var g=c.expiryfield;a.ContentExpiry={Hours:0,Minutes:0,Header:"Content Expiry"},a.$watch("item",function(){h(a.item)}),a.$watch("ContentExpiry",function(){a.item||(a.item={}),a.item[g]=f(a.ContentExpiry)},!0);var h=function(b){a.ContentExpiry.Header=a.header,b&&null!=b[g]?(a.ContentExpiry.Hours=d(b[g]),a.ContentExpiry.Minutes=e(b[g])):(a.ContentExpiry.Hours=0,a.ContentExpiry.Minutes=0)}}}}]).directive("sdDeskeditBasic",["gettext","desks","WizardHandler","metadata","$filter","$interpolate","$rootScope",function(a,b,c,d,e,f,g){return{link:function(h,i,k){function l(b){h._error=!0,h._errorMessage=a("There was a problem, desk not created/updated."),b.data&&b.data._issues&&(b.data._issues.name&&b.data._issues.name.unique?h._errorMessage=f(a("Desk with name "+name+" already exists."))({name:h.desk.edit.name}):b.data._issues["validator exception"]&&(h._errorMessage=a(b.data._issues["validator exception"]))),h.message=null}function m(){(h._error||h._errorLimits)&&(h._errorMessage="",h._error=null,h._errorLimits=null)}h.limits=j,h.deskTypes=[],h.$watch("step.current",function(a){"general"===a&&(h.desk.edit&&h.desk.edit._id&&h.edit(h.desk.edit),h.message=null)}),h.edit=function(a){h.desk.edit=_.create(a)},h.save=function(d,f){h.message=a("Saving...");var i=d._id?!1:!0;b.save(h.desk.edit,d).then(function(){if(i)h.edit(h.desk.edit),h.desks._items.unshift(h.desk.edit),g.$broadcast("desks:refresh:stages");else{var a=_.find(h.desks._items,{_id:h.desk.edit._id});_.extend(a,h.desk.edit)}h.desks._items=e("sortByName")(h.desks._items),b.deskLookup[h.desk.edit._id]=h.desk.edit,f?c.wizard("desks").finish():c.wizard("desks").next()},l)},h.handleEdit=function(a){m(),null!=h.desk.edit.name&&(h._errorLimits=h.desk.edit.name.length>h.limits.desk?!0:null)},d.values.desk_types?h.deskTypes=d.values.desk_types:d.fetchMetadataValues().then(function(){h.deskTypes=d.values.desk_types})}}}]).directive("sdDeskeditStages",["gettext","api","WizardHandler","tasks","$rootScope","desks","notify","macros",function(a,b,c,d,e,f,g,h){return{link:function(i,k,l){function m(a){a.data&&a.data._issues?a.data._issues.name&&a.data._issues.name.unique?i._errorUniqueness=!0:a.data._issues["validator exception"]&&g.error(a.data._issues["validator exception"]):i._error=!0,i.message=null}function n(){(i._errorUniqueness||i._error||i._errorLimits)&&(i._errorUniqueness=null,i._error=null,i._errorLimits=null)}function o(a,b){e.$broadcast("desks:refresh:stages",i.desk.edit._id)}var p=null;i.limits=j,i.statuses=d.statuses,i.desk.edit&&i.desk.edit._id&&h.getByDesk(i.desk.edit.name).then(function(a){i.macros=a}),i.$watch("step.current",function(a,b){"stages"===a&&(i.editStage=null,p=null,i.stages=[],i.selected=null,i.message=null,i.getstages(b))}),i.getstages=function(a){i.desk.edit&&i.desk.edit._id?(i.message="loading...",b("stages").query({where:{desk:i.desk.edit._id}}).then(function(a){i.stages=a._items,i.message=null})):c.wizard("desks").goTo(a)},i.next=function(a){a?c.wizard("desks").finish():c.wizard("desks").next()},i.edit=function(a){if(null==a.is_visible&&(a.is_visible=!0),p=a,i.editStage=_.create(a),!i.editStage._id){var b=_.last(i.stages);b&&(i.editStage.task_status=b.task_status)}},i.isActive=function(a){return i.editStage&&i.editStage._id===a._id},i.cancel=function(){i.editStage=null,n()},i.select=function(a){return i.editStage&&i.editStage._id!==a._id?!1:void(i.selected=a)},i.setStatus=function(a){i.editStage.task_status=a._id},i.save=function(){p._id?b("stages").save(p,i.editStage).then(function(a){i.editStage=null,i.message=null,i.select(a),o(),i.getstages(),f.fetchDeskById(a.desk).then(function(a){i.desk.edit=a})},m):(_.extend(i.editStage,{desk:i.desk.edit._id}),b("stages").save({},i.editStage).then(function(a){i.stages.push(a),i.editStage=null,i.select(a),i.message=null,o(),i.getstages(),f.fetchDeskById(a.desk).then(function(a){i.desk.edit=a})},m))},i.handleEdit=function(a){n(),null!=i.editStage.name&&(i._errorLimits=i.editStage.name.length>i.limits.stage?!0:null)},i.enableSave=function(){return i.editStage.name&&i.editStage.name.length>0&&!i._errorLimits},i.remove=function(c){b("stages").remove(c).then(function(){c===i.selected&&(i.selected=null),_.remove(i.stages,c),i.message=null,o(c._id),f.fetchDeskById(c.desk).then(function(a){i.desk.edit=a})},function(b){angular.isDefined(b.data._message)?i.message=a("Error: "+b.data._message):i.message=a("There was a problem, stage was not deleted.")})}}}}]).directive("sdUserSelectList",["$filter","api",function(a,b){return{scope:{exclude:"=",onchoose:"&"},templateUrl:"scripts/superdesk-desks/views/user-select.html",link:function(a,c,d){function e(){return a.selected?_.findIndex(a.users._items,a.selected):-1}function f(){var b=e();b>0&&a.select(a.users._items[_.max([0,b-1])])}function g(){var b=e();a.select(a.users._items[_.min([a.users._items.length-1,b+1])])}var h=38,i=40,j=13;a.selected=null,a.search=null,a.users={},a.exclude=[];var k=function(){return a.users={},b("users").query({where:JSON.stringify({$or:[{username:{$regex:a.search,$options:"-i"}},{first_name:{$regex:a.search,$options:"-i"}},{last_name:{$regex:a.search,$options:"-i"}},{email:{$regex:a.search,$options:"-i"}}]})}).then(function(b){a.users=b,a.users._items=_.filter(a.users._items,function(b){return-1===_.findIndex(a.exclude,{_id:b._id})}),a.selected=null})},l=_.debounce(k,1e3);a.$watch("search",function(){a.search&&l()}),c.bind("keydown keypress",function(b){a.$apply(function(){switch(b.which){case h:b.preventDefault(),f();break;case i:b.preventDefault(),g();break;case j:b.preventDefault(),e()>=0&&a.choose(a.selected)}})}),a.choose=function(b){a.onchoose({user:b}),a.search=null},a.select=function(b){a.selected=b}}}}]).directive("sdDeskeditPeople",["gettext","WizardHandler","desks","$rootScope",function(a,b,c,d){return{link:function(d,e,f){d.$watch("step.current",function(a,e){"people"===a&&(d.search=null,d.deskMembers=[],d.message="loading...",d.desk.edit&&d.desk.edit._id?c.fetchUsers().then(function(a){d.users=c.users._items,d.deskMembers=c.deskMembers[d.desk.edit._id]||[],d.message=null}):b.wizard("desks").goTo(e))}),d.add=function(a){d.deskMembers.unshift(a)},d.remove=function(a){_.remove(d.deskMembers,a)},d.save=function(e){var f=_.map(d.deskMembers,function(a){return{user:a._id}});c.save(d.desk.edit,{members:f}).then(function(a){_.extend(d.desk.edit,a),c.deskMembers[d.desk.edit._id]=d.deskMembers;var f=c.deskLookup[d.desk.edit._id];_.extend(f,d.desk.edit),e?b.wizard("desks").finish():b.wizard("desks").next()},function(b){d.message=a("There was a problem, members not saved.")})}}}}]).directive("sdDeskeditMacros",["macros","WizardHandler",function(a,b){return{link:function(c){c.desk&&c.desk.edit?a.getByDesk(c.desk.edit.name).then(function(a){c.macros=a}):a.get().then(function(a){c.macros=a}),c.save=function(){b.wizard("desks").finish()}}}}]).directive("sdActionPicker",["desks","macros",function(a,b){return{scope:{desk:"=",stage:"=",macro:"="},templateUrl:"scripts/superdesk-desks/views/actionpicker.html",link:function(c,d,e){c.desks=null,c.deskStages=null,c.deskMacros=null,c.$watchGroup(["desk","stage"],function(){c.desks&&c.deskStages?c.desk&&(b.getByDesk(a.deskLookup[c.desk].name).then(function(a){c.deskMacros=a}),-1===_.findIndex(c.deskStages[c.desk],{_id:c.stage})&&(c.stage=null)):a.initialize().then(function(){c.desks=a.desks._items,c.deskStages=a.deskStages})})}}}]).directive("sdStageHeader",h),i}(),function(){"use strict";function a(a,b){return angular.extend(a,_.pick(b,_.keys(w)))}function b(a){var b=["headline","abstract"];_.each(b,function(b){if(angular.isDefined(a[b])){var c=document.createElement("div");c.innerHTML=a[b],a[b]=c.textContent}})}function c(a,b){_.each(w,function(c,d){a[d]?b[d]?a[d]=b[d]:a[d]=c:b[d]&&(a[d]=b[d])})}function d(b,c,d){var e="archive_autosave",f=3e3,g={};this.open=function(a){return a._locked||!a._editable?b.when(a):d.find(e,a._id).then(function(b){return a._autosave=b,a},function(b){return a})},this.save=function(b){return b._editable&&!b._locked?(this.stop(b),g[b._id]=c(function(){var c=a({_id:b._id},b);return d.save(e,{},c).then(function(c){a(b,c);var d=Object.getPrototypeOf(b);d._autosave=c})},f),g[b._id]):void 0},this.stop=function(a){g[a._id]&&(c.cancel(g[a._id]),g[a._id]=null)},this.drop=function(a){this.stop(a),angular.isDefined(a._autosave)&&null!==a._autosave&&d(e).remove(a._autosave),a._autosave=null}}function e(c,d,e,f,g,h,i,j){var k=this;this.limits={slugline:24,headline:64,"abstract":160},this.userDesks=[],this.getContentFieldDefaults=function(){return w},i.fetchCurrentUserDesks().then(function(a){k.userDesks=a._items}),this.open=function(a,b,g){return j.flags.authoring=!0,_.contains(["legal_archive","archived"],g)?d.find(g,a).then(function(a){return a._editable=!1,a}):d.find("archive",a,{embedded:{lock_user:1}}).then(function(a){return!b&&e.isLocked(a)?(a._locked=!0,a._editable=!1,c.when(a)):(a._editable=!b,e.lock(a))}).then(function(a){return f.open(a)})},this.close=function(a,b,d,h){var i=c.when();return this.isEditable(a)&&(d&&(i=_.contains(["published","corrected"],b.state)?c.when("ignore"):g.confirm().then(angular.bind(this,function(){return this.save(b,a)}),function(){return c.when("ignore")})),i=i.then(function(c){return c&&"ignore"===c&&f.drop(b),h?void 0:e.unlock(a)})),i},this.publishConfirmation=function(a,b,d,e){var f=c.when();return this.isEditable(b)&&d&&(f=g.confirmPublish(e).then(angular.bind(this,function(){return!0}),function(){return!1})),f},this.cleanUpdatesBeforePublishing=function(a,c){if(c.publish_schedule||delete c.publish_schedule,this.isPublished(a)&&(delete c.dateline,c.embargo&&delete c.embargo),_.isEqual(a.renditions,c.renditions)&&delete c.renditions,b(c),angular.isDefined(c.body_html)){var d=document.createElement("div");d.innerHTML=c.body_html,""===d.textContent&&(c.body_html="")}},this.publish=function(b,c,f){f=f||"publish",c=a({},c),this.cleanUpdatesBeforePublishing(b,c);var g="archive_"+f;return d.update(g,b,c).then(function(a){return e.unlock(a).then(function(a){return a})},function(a){return a})},this.saveWorkConfirmation=function(a,b,d,e){var f=c.when();return d&&this.isEditable(b)&&(f=g.confirmSaveWork(e).then(angular.bind(this,function(){return this.saveWork(a,b)}),function(a){return c.when()})),f},this.autosave=function(a){return f.save(a)},this.save=function(g,h){var i=a({},h);return angular.isDefined(g)&&angular.forEach(_.keys(i),function(a){_.isEqual(i[a],g[a])&&delete i[a]}),b(i),f.stop(h),_.size(i)>0?d.save("archive",h,i).then(function(a){return h._autosave=null,h._locked=e.isLocked(h),h}):c.when(g)},this.saveWork=function(b,c){var e={type:b.type,version:1,task:{desk:null,stage:null,user:b.task.user}},f=_.omit(c,["unique_name","unique_id","_id","guid"]),g=a(e,f);return d.save("archive",{},g).then(function(a){return a._autosave=null,a})},this.isEditable=function(a){return!!a.lock_user&&!e.isLocked(a)},this.isPublished=function(a){return _.contains(["published","killed","scheduled","corrected"],a.state)},this.unlock=function(a,b,c){f.stop(a),a.lock_session=null,a.lock_user=null,a._locked=!1,g.unlock(b,c)},this.lock=function(a,b){f.stop(a),d.find("users",b).then(function(b){a.lock_user=b},function(c){a.lock_user=b}),a._locked=!0},this.linkItem=function(a,b,c){var e={};return b&&(e.link_id=b),c&&(e.desk=c),d.save("archive_link",{},e,a)},this.itemActions=function(a){var b=a&&angular.isDefined(a.archive_item)?a.archive_item:a,c=h.privileges,d=angular.extend({},x);if(angular.isUndefined(b)||angular.isUndefined(c)||"killed"===b.state||angular.isDefined(b.takes)&&"killed"===b.takes.state||b._type&&"archived"===b._type)return d;var f=_.contains(["spiked","scheduled","killed"],b.state)||angular.isDefined(b.package_type)&&"takes"===b.package_type,g=!e.isLocked(b);d.view=!g;var i=angular.isDefined(b.genre)&&b.genre.length>0&&_.contains(["text","preformatted"],b.type)&&b.genre.some(function(a){return"Broadcast Script"===a.name});if(d.new_take=!f&&"text"===b.type&&!b.embargo&&(this.isPublished(b)||!b.publish_schedule)&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id)&&(angular.isUndefined(b.more_coming)||!b.more_coming)&&!i&&!b.rewritten_by,k.isPublished(b)){if(angular.isDefined(a.archive_item)&&a._current_version!==a.archive_item._current_version||this._versionToFetch&&this._versionToFetch!==a._current_version)return angular.extend({},x);d.view=!0,"scheduled"===b.state?d.deschedule=!0:("published"===b.state||"corrected"===b.state)&&(d.kill=c.kill&&g&&!f,d.correct=c.correct&&g&&!f),d.re_write=_.contains(["published","corrected"],b.state)&&_.contains(["text"],b.type)&&!b.embargo&&!b.rewritten_by&&d.new_take&&(!b.broadcast||!b.broadcast.master_id)}else{if("spiked"===b.state)return d=angular.extend({},x),d.unspike=!0,d;d.save="spiked"!==b.state,d.publish=(!b.flags||!b.flags.marked_for_not_publication)&&b.task&&b.task.desk&&c.publish&&"draft"!==b.state,d.edit=!("composite"===b.type&&"takes"===b.package_type)&&"spiked"!==b.state&&g,d.unspike="spiked"===b.state&&c.unspike,d.spike="spiked"!==b.state&&c.spike&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id),d.send=b._current_version>0&&c.move}if(d.mark_item=b.task&&b.task.desk&&!f&&"takes"!==b.package_type&&c.mark_for_highlights,d.package_item=!_.contains(["spiked","scheduled","killed"],b.state)&&!b.embargo&&"takes"!==b.package_type&&(this.isPublished(b)||!b.publish_schedule),d.create_broadcast=_.contains(["published","corrected"],b.state)&&_.contains(["text","preformatted"],b.type)&&!i&&c.archive_broadcast,d.multi_edit=!f,b.task&&b.task.desk){d.duplicate=c.duplicate&&!_.contains(["spiked","killed"],b.state)&&(angular.isUndefined(b.package_type)||"takes"!==b.package_type),d.add_to_current=!_.contains(["spiked","scheduled","killed"],b.state);var j=_.find(k.userDesks,{_id:b.task.desk});j||(d=angular.extend({},x))}else d.copy=!0,d.view=!1,d.package_item=!1,d.new_take=!1;return d},this.setItemVersion=function(a){this._versionToFetch=a},this.isTakeItem=function(a){return _.contains(["text"],a.type)&&a.takes&&a.takes.sequence>1}}function f(a,b,c,d,e){function f(a){return a.lock_user&&a.lock_user._id||a.lock_user}this.lock=function(d,f){return!d.lock_user&&d._editable||f?b.save("archive_lock",{},{},d).then(function(a){return _.extend(d,a),d._locked=!1,d.lock_user=c.identity._id,d.lock_session=c.sessionId,d},function(a){return e.error(gettext("Failed to get a lock on the item!")),d._locked=!1,d._editable=!1,d}):(d._locked=this.isLocked(d),a.when(d))},this.unlock=function(a){return b("archive_unlock",a).save({}).then(function(b){return _.extend(a,b),a._locked=!0,a},function(b){return a._locked=!0,a})},this.isLocked=function(a){var b=f(a);return b?b!==c.identity._id?!0:a.lock_session&&a.lock_session!==c.sessionId?!0:!1:!1},this.isLockedByMe=function(a){var b=f(a);return b&&b===c.identity._id},this.can_unlock=function(a){return this.isLockedByMe(a)?!0:d.privileges.unlock}}function g(a,b,c,d,e,f,g){this.setupWindow=function(b){a.onbeforeunload=function(){return b.dirty?f("There are unsaved changes. If you navigate away, your changes will be lost."):void b.$on("$destroy",function(){a.onbeforeunload=angular.noop})}},this.confirm=function(){return e.confirm(f("There are some unsaved changes, do you want to save it now?"),f("Save changes?"),f("Save"),f("Ignore"),f("Cancel"))},this.confirmPublish=function(a){return e.confirm(g(f("There are some unsaved changes, do you want to save it and {{ action }} now?"))({action:a}),f("Save changes?"),g(f("Save and {{ action }}"))({action:a}),f("Cancel"))},this.confirmSendTo=function(a){return e.confirm(g(f("There are some unsaved changes, do you want to save it and {{ action }} now?"))({action:a}),f("Save changes?"),g(f("Save and {{ action }}"))({action:a}),f("Cancel"))},this.confirmSaveWork=function(a){return e.confirm(g(f("Configuration has changed, "+a+". Would you like to save story to your workspace?"))({message:a}))},this.confirmSpellcheck=function(a){var b=a>1?"mistakes":"mistake",c="You have {{ message }} spelling {{ mistakes }}. Are you sure you want to continue?";return e.confirm(g(f(c))({message:a,mistakes:b}))},this.unlock=function(a,b){d.find("users",a).then(function(a){var d=b?"Item <b>"+b+"</b>":"This item",g=f(d+" was unlocked by <b>"+a+"</b>.").replace("{{ user }}",c("username")(a));return e.confirm(g,f("Item Unlocked"),f("OK"),!1)})},this.lock=function(a){d.find("users",a).then(function(a){var b=f("This item was locked by <b>"+a+"</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item locked"),f("OK"),!1)})}}function h(a,b,c,d,e){function f(b){var c={},d=a.preview[b];return c.CropLeft=Math.round(Math.min(d.cords.x,d.cords.x2)),c.CropRight=Math.round(Math.max(d.cords.x,d.cords.x2)),c.CropTop=Math.round(Math.min(d.cords.y,d.cords.y2)),c.CropBottom=Math.round(Math.max(d.cords.y,d.cords.y2)),c}function g(b){var c={};c[b]=f(b),_.extend(a.data.cropData,c)}a.data=a.locals.data,a.preview={},a.origPreview={},a.data.cropData={},a.data.isDirty=!1,a.$watch("preview",function(b,c){return b===c?void(a.origPreview=a.preview):Object.keys(b).length===Object.keys(c).length?void(a.data.isDirty=!0):void 0},!0),a.done=function(){_.forEach(a.data.cropsizes,function(a){g(a.name)}),c.success(b("Crop changes have been recorded")),a.resolve(a.data)},a.close=function(){a.data.isDirty?d.confirm(b("You have unsaved changes, do you want to continue?")).then(function(){a.data.isDirty=!1,a.preview=a.origPreview,a.resolve(a.data)}):a.reject()}}function i(a,b,c,d){a.origItem=b,a.action=c||"edit",a.lock=function(){d.intent("author","article",b)}}function j(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,x){return{link:function(b,d,o){function r(a){j.generate_highlights.save({},{"package":a}).then(e.edit,function(a){f.error(g("Error creating highlight."))})}function y(a,c,d,e){var f="";if(a&&!c?f=g(e+" time is invalid!"):c&&!a&&(f=g(e+" date is invalid!")),""===f&&d){var h=new Date(d);_.isDate(h)?h.getTime()?h<_.now()&&("Embargo"!==e||b._isInProductionStates)&&(f=g(e+" cannot be earlier than now!")):f=g(e+" time is invalid!"):f=g(e+" is not a valid date!")}return f}function z(a){if(a.embargo&&a.publish_schedule)return f.error(g("An Item can't have both Embargo and Publish Schedule.")),!1;var b;if((a.embargo_date||a.embargo_time)&&(b=y(a.embargo_date,a.embargo_time,a.embargo,"Embargo"),
""!==b))return f.error(b),!1;if(a.publish_schedule_date||a.publish_schedule_time){if(_.contains(["published","killed","corrected"],a.state))return!0;if(b=y(a.publish_schedule_date,a.publish_schedule_time,a.publish_schedule,"Publish Schedule"),""!==b)return f.error(b),!1}return!0}function A(a,c){var d="edit"===b.action?"publish":b.action;i.publish(a,c,d).then(function(a){if(a)if(angular.isDefined(a.data)&&angular.isDefined(a.data._issues)){if(angular.isDefined(a.data._issues["validator exception"])){for(var d=a.data._issues["validator exception"],h=d.replace(/\[/g,"").replace(/\]/g,"").split(","),j=0;j<h.length;j++)f.error(h[j]);(d.indexOf("9007")>=0||d.indexOf("9009")>=0)&&i.open(c._id,!0).then(function(a){b.origItem=a,b.dirty=!1,b.item=_.create(b.origItem)})}}else 412===a.status?B():(f.success(g("Item published.")),b.item=a,b.dirty=!1,e.close(!0));else f.error(g("Unknown Error: Item not published."))})}function B(){f.error(g("Item has changed since it was opened. Please close and reopen the item to continue. Regrettably, your changes cannot be saved.")),b._editable=!1,b.dirty=!1}function C(){i.open(b.item._id,!0).then(function(a){b.origItem=a,b.dirty=!1,b.closePreview(),b.item._editable=b._editable})}var D;if(b.privileges=m.privileges,b.dirty=!1,b.views={send:!1},b.stage=null,b._editable=!!b.origItem._editable,b.isMediaType=_.contains(["audio","video","picture"],b.origItem.type),b.action=b.action||(b._editable?"edit":"view"),b.itemActions=i.itemActions(b.origItem),b.highlight=!!b.origItem.highlight,b.$watch("origItem",function(a,c){b.itemActions=null,a&&(b.itemActions=i.itemActions(a))},!0),b._isInProductionStates=!i.isPublished(b.origItem),b.origItem.sign_off=b.origItem.sign_off||b.origItem.version_creator,"kill"===b.action){var E=_.union(_.keys(w),["_id","versioncreated"]),F={template_name:"kill",item:_.pick(b.origItem,E)};j.save("content_templates_apply",{},F,{}).then(function(a){F=_.pick(a,_.keys(w)),_.each(F,function(a,c){_.isEmpty(a)||(b.item[c]=a)})},function(a){f.error(g("Failed to apply kill template to the item."))})}b.$watch("item.flags",function(a,c){a!==c&&(b.item.flags=_.clone(b.origItem.flags),b.item.flags=a,b.origItem.flags=c,b.dirty=!0)},!0),b.proofread=!1,b.referrerUrl=p.getReferrerUrl(),b.origItem.task&&b.origItem.task.stage&&(v.isLegal(b.origItem)?(b.deskName=b.origItem.task.desk,b.stage=b.origItem.task.stage):(j("stages").getById(b.origItem.task.stage).then(function(a){b.stage=a}),h.fetchDeskById(b.origItem.task.desk).then(function(a){b.deskName=a.name}))),b.edit=function(){v.isPublished(b.origItem)?e.view(b.origItem):e.edit(b.origItem)},b.save=function(){return i.save(b.origItem,b.item).then(function(a){return b.origItem=a,b.dirty=!1,b.item=_.create(b.origItem),a.cropData&&(b.item.hasCrops=!0),f.success(g("Item updated.")),b.origItem},function(a){angular.isDefined(a.data._issues)?angular.isDefined(a.data._issues.unique_name)&&1===a.data._issues.unique_name.unique?f.error(g("Error: Unique Name is not unique.")):angular.isDefined(a.data._issues["validator exception"])&&f.error(g("Error: "+a.data._issues["validator exception"])):412===a.status?B():f.error(g("Error. Item not updated."))})},b.exportHighlight=function(a){b.save_enabled()?u.confirm(g("You have unsaved changes, do you want to continue.")).then(function(){r(a._id)}):r(a._id)},b.publish=function(){if(z(b.item)){var a="publish";b.action&&"edit"!==b.action&&(a=b.action),b.dirty&&"publish"===a?i.publishConfirmation(b.origItem,b.item,b.dirty,a).then(function(a){a&&A(b.origItem,b.item)},function(a){f.error(g("Error. Item not published."))}):A(b.origItem,b.item)}},b.deschedule=function(){return b.item.publish_schedule=null,b.save()},b.close=function(){D=!0,i.close(b.item,b.origItem,b.save_enabled()).then(function(){e.close(!0)})},b.minimize=function(){e.close(!0)},b.closeOpenNew=function(a,c){D=!0,i.close(b.item,b.origItem,b.dirty,!0).then(function(){a(c)})},b.beforeSend=function(a){return b.sending=!0,b.dirty?x.confirmSendTo(a).then(function(){return b.save().then(function(){return l.unlock(b.origItem)})},function(){return s.reject()}):l.unlock(b.origItem)},b.preview=function(a){c(b.item,a),b._editable=!1},b.revert=function(a){return c(b.item,a),b.save()},b.closePreview=function(){b.item=_.create(_.cloneDeep(b.origItem)),a(b.item,b.item._autosave||{}),b._editable="view"!==b.action&&i.isEditable(b.origItem)},b.can_unlock=function(){return b.item._locked&&!b.item.sendTo&&l.can_unlock(b.item)&&(b.itemActions.save||_.contains(["published","scheduled","corrected"],b.item.state))},b.save_enabled=function(){return b.dirty||b.item._autosave},b.unlock=function(){b.unlockClicked=!0,l.unlock(b.item).then(function(a){b.edit(a)})},b.openAction=function(a){"correct"===a?e.correct(b.item):"kill"===a&&e.kill(b.item)},b.isLockedByMe=function(){return l.isLockedByMe(b.item)},b.autosave=function(a){b.dirty=!0;var c=i.autosave(a);return e.addAutosave(),c},b.content=n,b.closePreview(),b.$on("savework",function(a,c){var d=c;i.saveWorkConfirmation(b.origItem,b.item,b.dirty,d).then(function(a){h.setCurrentDeskId(null)})["finally"](function(){t.location.reload(!0)})}),b.$on("item:lock",function(a,c){b.item._id!==c.item||D||k.sessionId===c.lock_session||i.lock(b.item,c.user)}),b.$on("item:unlock",function(a,c){b.item._id!==c.item||D||k.sessionId===c.lock_session&&!l.previewUnlock||(l.previewUnlock?(b.unlock(),l.previewUnlock=!1):(i.unlock(b.item,c.user),b._editable=b.item._editable=!1,b.origItem._locked=b.item._locked=!1,b.origItem.lock_session=b.item.lock_session=null,b.origItem.lock_user=b.item.lock_user=null,c.state&&c.state!==b.item.state&&(b.item.state=c.state,b.origItem.state=c.state)))}),b.$on("item:updated",function(a,c){c.item===b.origItem._id&&"view"===b.action&&C()}),b.$on("item:publish:wrong:format",function(a,c){c.item===b.item._id&&f.error(g("No formatters found for ")+c.formats.join(",")+" while publishing item having story name "+c.unique_name)}),b.$on("item:highlight",function(a,c){b.item._id===c.item_id&&(b.item.highlights?-1===b.item.highlights.indexOf(c.highlight_id)?b.item.highlights=[c.highlight_id].concat(b.item.highlights):b.item.multiSelect||(b.item.highlights=_.without(b.item.highlights,c.highlight_id)):b.item.highlights=[c.highlight_id])}),q.setupShortcuts(b)}}}function k(a){return{templateUrl:"scripts/superdesk-authoring/views/authoring-topbar.html",link:function(b){b.saveDisabled=!1,b.saveTopbar=function(a){return b.saveDisabled=!0,b.save(a)["finally"](function(){b.saveDisabled=!1})},a.bind("ctrl+shift+u",function(a){a.preventDefault(),b.item._locked&&!b.item.sendTo&&b.can_unlock()&&b.itemActions.save&&!b.unlockClicked&&b.unlock()}),a.bind("ctrl+shift+e",function(){b.close()}),a.bind("ctrl+shift+s",function(a){a.preventDefault(),b._editable&&b.itemActions.save&&"edit"===b.action&&!b.saveDisabled&&b.save_enabled()&&b.saveTopbar()})}}}function l(){return{link:function(a,b){var c=b.parent(),d=c.parent().width(),e=parseInt(b.css("margin-left"),10)+parseInt(b.css("margin-right"),10),f=c.outerWidth()+b.outerWidth()+e;d>f&&c.outerWidth(f)}}}function m(){return{scope:{item:"=",limit:"=",html:"@"},template:'<span class="char-count" ng-class="{error: numChars > limit}" translate>{{numChars}}/{{ limit }} characters </span>',link:function(a,b,c){a.html=a.html||!1,a.numChars=0,a.$watch("item",function(){var b=a.item||"";b=a.html?y(b):b,a.numChars=b.length||0})}}}function n(){return{scope:{item:"=",html:"@"},template:'<span class="char-count">{{numWords}} <span translate>words</span></span>',link:function(a,b,c){a.html=a.html||!1,a.numWords=0,a.$watch("item",function(){var b=a.item||"";b=a.html?y(b):b,a.numWords=_.compact(b.split(/\s+/)).length||0})}}}function o(a,b){var c={},d="editor:theme",e="default";return c.availableThemes=[{cssClass:"",label:"Default",key:"default"},{cssClass:"dark-theme",label:"Dark",key:"dark"},{cssClass:"natural-theme",label:"Natural",key:"natural"},{cssClass:"dark-blue-theme",label:"Dark blue",key:"dark-blue"},{cssClass:"dark-turquoise-theme",label:"Dark turquoise",key:"dark-turquoise"},{cssClass:"dark-khaki-theme",label:"Dark khaki",key:"dark-khaki"},{cssClass:"dark-theme-mono",label:"Dark monospace",key:"dark-mono"}],c.save=function(a,c){return b.get().then(function(e){return e[d][a]=c[a].key+(c.large[a]?"-large":""),b.update(e)})},c.get=function(a){return b.get().then(function(b){var c=b[d]&&b[d][a]?b[d][a]:e;return c})},c}function p(a){return{templateUrl:"scripts/superdesk-authoring/views/theme-select.html",scope:{key:"@"},link:function(b,c){function d(a){b.key===a&&angular.element(".page-content-container").children(".theme-container").attr("class",g).addClass(b[a].cssClass).addClass(b.large[a]&&"large-text")}function e(a){return-1!==a.indexOf("-large")?a.slice(0,a.indexOf("-large")):a}function f(a){return-1!==a.indexOf("-large")?!0:!1}var g="main-article theme-container";b.themes=a.availableThemes,b.large={},a.get("theme").then(function(c){var g=_.find(a.availableThemes,{key:e(c)});b.theme=g,b.large.theme=f(c),d("theme")}),a.get("proofreadTheme").then(function(c){var g=_.find(a.availableThemes,{key:e(c)});b.proofreadTheme=g,b.large.proofreadTheme=f(c),d("proofreadTheme")}),b.changeTheme=function(c,e){b[c]=e,a.save(c,b),d(c)},b.changeSize=function(c,e){b.large[c]=e,a.save(c,b),d(c)}}}}function q(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){return{scope:{item:"=",view:"=",_beforeSend:"=beforeSend",_editable:"=editable",_publish:"=publish",_action:"=action",mode:"@"},templateUrl:"scripts/superdesk-authoring/views/send-item.html",link:function(q,r,s){function t(a,b){a!==b&&(q.isActive=!!a,q.item=q.isActive?{}:null,q.multiItems=p.count?p.getItems():null,q.config=a,v())}function u(a){"monitoring"===q.mode&&(f.flags.fetching=!!a),q.isActive=!!a,v()}function v(){q.isActive&&c.initialize().then(D).then(E).then(F).then(G)}function w(a){q.item.sendTo=!0;var b=q.selectedDesk._id,c=q.selectedStage._id||q.selectedDesk.incoming_stage;return"authoring"===q.mode?z(b,c,q.selectedMacro):"archive"===q.mode?B(b,c,q.selectedMacro,a):q.config?(q.destination_last&&q.destination_last.desk!==b&&q.destination_last.stage!==c?A(b,c):A(b,c),q.config.resolve({desk:b,stage:c,macro:q.selectedMacro?q.selectedMacro.name:null,open:a})):"ingest"===q.mode?C(b,c,q.selectedMacro,a):void 0}function x(){var a=q.selectedDesk._id,b=q.selectedStage._id||q.selectedDesk.incoming_stage;return q.item.more_coming=!0,q.item.sendTo=!0,z(a,b,q.selectedMacro,!0).then(function(){var a=null;return q.item.task&&q.item.task.desk&&(a=q.item.task.desk),j.linkItem(q.item,null,a)}).then(function(a){e.close(!1),d.success(gettext("New take created.")),e.edit(a)},function(a){d.error(gettext("Failed to send and continue."))})}function y(b,c){return c?h.call(c,b,!0):a.when(b)}function z(c,f,g,h){var i,j;return h&&(i=a.defer()),y(q.item,g).then(function(a){b.find("tasks",q.item._id).then(function(a){return q.task=a,j=h?"Send & Continue":"Send",q.beforeSend(j)}).then(function(a){return a&&a._etag&&(q.task._etag=a._etag),b.save("move",{},{task:{desk:c,stage:f}},q.item)}).then(function(a){return d.success(gettext("Item sent.")),q.destination_last&&q.destination_last.desk!==c&&q.destination_last.stage!==f?A(c,f):A(c,f),h?i.resolve():void e.close(!0)},function(a){return a&&(angular.isDefined(a.data._message)?d.error(a.data._message):angular.isDefined(a.data._issues["validator exception"])&&d.error(a.data._issues["validator exception"]),h)?i.reject(a):void 0})}),h?i.promise:void 0}function A(a,b){var c={};c[H]={desk:a,stage:b},o.update(c,H)}function B(a,c,e,f){var h;b.save("duplicate",{},{desk:q.item.task.desk},q.item).then(function(a){return b.find("archive",a._id)}).then(function(a){return y(a,e)}).then(function(a){return h=a,b.find("tasks",a._id)}).then(function(d){q.task=d,b.save("tasks",q.task,{task:_.extend(q.task.task,{desk:a,stage:c})})}).then(function(){d.success(gettext("Item sent.")),q.close(),f?g.url("/authoring/"+h._id):i.$broadcast("item:fetch")})}function C(a,b,c,f){return k.oneAs(q.item,{desk:a,stage:b,macro:c?c.name:c}).then(function(a){d.success(gettext("Item fetched.")),f?e.edit(a):i.$broadcast("item:fetch")})}function D(){var a=c.initialize().then(function(){q.desks=c.desks});return q.getLastDestination().then(function(b){b&&(q.destination_last={desk:b.desk,stage:b.stage}),a="ingest"===q.mode?a.then(function(){q.selectDesk(c.getCurrentDesk())}):a.then(function(){var a=c.getItemDesk(q.item);a?q.destination_last&&null!=q.destination_last.desk?q.selectDesk(c.deskLookup[q.destination_last.desk]):q.selectDesk(a):q.destination_last&&null!=q.destination_last.desk?q.selectDesk(c.deskLookup[q.destination_last.desk]):q.selectDesk(c.getCurrentDesk())})}),a}function E(){if(q.selectedDesk){q.stages=c.deskStages[q.selectedDesk._id];var a=null;q.destination_last?a=_.find(q.stages,{_id:q.destination_last.stage}):q.item.task&&q.item.task.stage&&(a=_.find(q.stages,{_id:q.item.task.stage})),a||(a=_.find(q.stages,{_id:q.selectedDesk.incoming_stage})),q.selectedStage=a}}function F(){null!=q.selectedDesk&&h.getByDesk(q.selectedDesk.name).then(function(a){q.macros=a})}function G(){q.itemActions=j.itemActions(q.item)}q.mode=q.mode||"authoring",q.desks=null,q.stages=null,q.macros=null,q.task=null,q.selectedDesk=null,q.selectedStage=null,q.selectedMacro=null,q.beforeSend=q._beforeSend||a.when,q.destination_last=null;var H="destination:active";q.$watch("item",u),q.$watch(k.getConfig,t),q.getLastDestination=function(){return o.get(H).then(function(a){return a})},q.close=function(){"monitoring"===q.mode&&(f.flags.fetching=!1),q.$parent.views?q.$parent.views.send=!1:q.item=null,g.search("fetch",null),q.config&&q.config.reject()},q.selectDesk=function(a){q.selectedDesk=_.cloneDeep(a),q.selectedStage=null,E(),F()},q.selectStage=function(a){q.selectedStage=a},q.selectMacro=function(a){q.selectedMacro===a?q.selectedMacro=null:q.selectedMacro=a},q.send=function(a){return l.countErrors().then(function(b){return"authoring"===q.mode&&b>0?void m.confirmSpellcheck(b).then(angular.bind(this,function(){return w(a)}),function(a){return!1}):w(a)})},q.showSendButtonAndDestination=function(){return q.itemActions?"ingest"===q.mode||"monitoring"===q.mode||"authoring"===q.mode&&q.isSendEnabled()&&q.itemActions.send:void 0},q.disableSendButton=function(){return q.item&&q.item.task?!q.selectedDesk||"ingest"!==q.mode&&q.selectedStage._id===q.item.task.stage:void 0},q.disableFetchAndOpenButton=function(){var a=_.isEmpty(_.find(c.userDesks._items,{_id:q.selectedDesk._id}));return a},q.showPublishSchedule=function(){return q.item&&"ingest"!==n.getType(q.item)&&"composite"!==q.item.type&&!q.item.embargo_date&&!q.item.embargo_time&&!j.isTakeItem(q.item)&&-1===["published","killed","corrected"].indexOf(q.item.state)},q.showEmbargo=function(){var a=q.item&&"ingest"!==n.getType(q.item)&&"composite"!==q.item.type&&!q.item.publish_schedule_date&&!q.item.publish_schedule_time&&!j.isTakeItem(q.item);return a&&j.isPublished(q.item)?q.item.embargo:a},q.isEmbargoEditable=function(){return q.item&&q.item._editable&&!j.isPublished(q.item)},q.canSendAndContinue=function(){return!j.isPublished(q.item)&&_.contains(["text"],q.item.type)},q.isSendEnabled=function(){return!j.isPublished(q.item)},q.sendAndContinue=function(){return q.item&&q.item.publish_schedule?void d.error(gettext("Takes cannot be scheduled.")):q.item&&q.item.embargo?void d.error(gettext("Takes cannot have Embargo.")):l.countErrors().then(function(a){return a>0?void m.confirmSpellcheck(a).then(angular.bind(this,function(){return x()}),function(a){return!1}):x()})},q.canSendItem=function(){var a,b=[];return q.multiItems&&(angular.forEach(q.multiItems,function(a){b[a._type]=1}),a=Object.keys(b),b=1===a.length?a[0]:null),"authoring"===q.mode||"archive"===b}}}}function r(a,b,c,d,e){return{templateUrl:"scripts/superdesk-authoring/views/article-edit.html",link:function(f,g){var h=4/3;f.limits=b.limits,f.toggleDetails=!0,f.errorMessage=null;var i=f.$parent.$parent;f.monthNames={Jan:"0",Feb:"1",Mar:"2",Apr:"3",May:"4",Jun:"5",Jul:"6",Aug:"7",Sept:"8",Oct:"9",Nov:"10",Dec:"11"},f.datelineMonth="",f.datelineDay="",f.$watch("item",function(a){if(a&&a.dateline){var b={dateline:{}};if(b.dateline=_.pick(a.dateline,["source","date","located","text"]),a.dateline.located){var c=d("formatDatelineToMMDD")(a.dateline.date,a.dateline.located);f.datelineMonth=c.month,f.datelineDay=c.day,f.resetNumberOfDays(!1)}_.extend(a,b)}}),c.initialize().then(function(){f.metadata=c.values,"picture"===f.item.type&&(f.item.hasCrops=!1,f.item.hasCrops=f.metadata.crop_sizes.some(function(a){return f.item.renditions&&f.item.renditions[a.name]}))}),f.updateDateline=function(a,b){if(""===b)a.dateline.located=null,a.dateline.text="",f.datelineMonth="",f.datelineDay="";else{var c=d("formatDatelineToMMDD")(a.dateline.date,a.dateline.located);f.datelineMonth=c.month,f.datelineDay=c.day,f.resetNumberOfDays(!1),a.dateline.text=d("formatDatelineToLocMMMDDSrc")(a.dateline.located,_.findKey(f.monthNames,function(a){return a===f.datelineMonth}),f.datelineDay,a.dateline.source)}},f.resetNumberOfDays=function(a,b){""!==f.datelineMonth?(f.daysInMonth=d("daysInAMonth")(parseInt(f.datelineMonth)),a&&(b&&(f.datelineMonth=b),f.modifyDatelineDate(f.datelineDay))):(f.daysInMonth=[],f.datelineDay="")},f.modifyDatelineDate=function(b){""!==f.datelineMonth&&""!==f.datelineDay&&(b&&(f.datelineDay=b),f.item.dateline.date=d("relativeUTCTimestamp")(f.item.dateline.located,parseInt(f.datelineMonth),parseInt(f.datelineDay)),f.item.dateline.text=d("formatDatelineToLocMMMDDSrc")(f.item.dateline.located,_.findKey(f.monthNames,function(a){return a===f.datelineMonth}),f.datelineDay,f.item.dateline.source),a.save(f.item))},f.evalAspectRatio=function(a){var b=a.split("-").map(_.partial(parseInt,_,10)),c=b[0]/b[1];return isNaN(c)||!isFinite(c)?(f.errorMessage="Error: Given Aspect ratio was not valid, using default: "+h,h):(f.errorMessage=null,c)},f.applyCrop=function(){var a={};f.item.cropsizes=f.metadata.crop_sizes,_.forEach(f.item.cropsizes,function(b){a={aspectRatio:f.evalAspectRatio(b.name)},_.extend(_.filter(f.item.cropsizes,{name:b.name})[0],a)}),e.intent("edit","crop",f.item).then(function(a){i.dirty||(i.dirty=a.isDirty);var b=_.create(a.renditions),c=a.cropData;f.item.renditions=_.merge(b,c)})},f.addHelplineToFooter=function(){var b=document.createElement("div");b.innerHTML=f.item.body_footer,f.item.body_footer&&""!==b.textContent||(f.item.body_footer=""),f.item.body_footer_value&&(f.item.body_footer=f.item.body_footer+f.item.body_footer_value.value,a.save(f.item)),_.defer(function(){var a=g.find("#helplines");a[0].options[0].selected=!0})}}}}function s(a,b){function c(){var a=this;this.state={},this.edit=function(b,c){a.item=b,a.action=c,a.state.opened=!!b}}return{controller:c,controllerAs:"authoring",templateUrl:"scripts/superdesk-authoring/views/authoring-container.html",scope:{},require:"sdAuthoringContainer",link:function(a,c,d,e){a.$watch(b.getState,function(b){b&&(e.edit(null,null),a.$applyAsync(function(){e.edit(b.item,b.action)}))})}}}function t(){return{templateUrl:"scripts/superdesk-authoring/views/authoring.html",scope:{origItem:"=item",action:"="}}}function u(a,b,c,d,e){return{templateUrl:"scripts/superdesk-authoring/views/authoring-header.html",require:"^sdAuthoringWidgets",link:function(f,g,h,i){f.shouldDisplayCompanyCodes=function(){if(!e.values.company_codes)return!1;var a,b=f.item.company_codes&&f.item.company_codes.length>0;return!b&&f.item.anpa_category&&(a=_.find(f.item.anpa_category,{qcode:"f"}),b=!_.isUndefined(a)&&!_.isNull(a)),!b&&f.item.subject&&(a=_.find(f.item.subject,function(a){return"04000000"===a.qcode||"04006018"===a.qcode||"04019000"===a.qcode?a:void 0}),b=!_.isUndefined(a)&&!_.isNull(a)),b},f.$watch("item",function(e){if(e&&(f.loaded=!0,!d.isLegal(f.item))){f.item.slugline&&d.getRelatedItems(f.item.slugline).then(function(a){f.relatedItems=a});var g=_.filter(b,function(a){return"related-item"===a._id});f.activateWidget=function(){i.activate(g[0])},f.previewMasterStory=function(){var b=e.broadcast.takes_package_id?e.broadcast.takes_package_id:e.broadcast.master_id;return a.find("archive",b).then(function(a){c.$broadcast("broadcast:preview",{item:a})})}}})}}}function v(a,b,c,d){function e(){a.search("item",h.item?h.item._id:null),a.search("action",h.action),b.flags.authoring=!!h.item,h.state={item:h.item,action:h.action}}function f(){a.search().item&&a.search().action in h&&g(a.search().item,a.search().action)}function g(a,b,d){return c.open(a,"view"===b,d).then(function(a){h.item=a,h.action="view"!==b&&a._editable?b:"view"}).then(e)}this.item=null,this.action=null,this.state=null;var h=this;this.edit=function(a,b){a?g(a._id,b||"edit",a._type||null):h.close()},this.view=function(a){c.setItemVersion(a._current_version),h.edit(a,"view")},this.close=function(a){h.item=null,h.action=null,a&&b.flags.hideMonitoring&&(b.flags.hideMonitoring=!1),e()},this.kill=function(a){h.edit(a,"kill")},this.correct=function(a){h.edit(a,"correct")},this.getItem=function(){return h.item},this.getAction=function(){return h.action},this.getState=function(){return h.state},this.addAutosave=function(){h.item&&(h.item._autosaved=!0)},f()}var w=Object.freeze({headline:"",slugline:"",body_html:null,"abstract":null,anpa_take_key:null,byline:null,urgency:null,priority:null,subject:[],anpa_category:[],genre:[],groups:[],usageterms:null,ednote:null,place:[],located:null,dateline:null,language:null,unique_name:"",keywords:[],description:null,sign_off:null,publish_schedule:null,flags:null,pubstatus:null,more_coming:!1,targeted_for:[],embargo:null,renditions:null,body_footer:null,company_codes:[]}),x=Object.freeze({publish:!1,correct:!1,kill:!1,deschedule:!1,new_take:!1,re_write:!1,save:!1,edit:!1,mark_item:!1,duplicate:!1,copy:!1,view:!0,spike:!1,unspike:!1,package_item:!1,multi_edit:!1,send:!1,create_broadcast:!1,add_to_current:!1});d.$inject=["$q","$timeout","api"],e.$inject=["$q","api","lock","autosave","confirm","privileges","desks","superdeskFlags"],f.$inject=["$q","api","session","privileges","notify"],g.$inject=["$window","$q","$filter","api","modal","gettext","$interpolate"],h.$inject=["$scope","gettext","notify","modal","$q"],i.$inject=["$scope","item","action","superdesk"],j.$inject=["superdesk","superdeskFlags","authoringWorkspace","notify","gettext","desks","authoring","api","session","lock","privileges","content","$location","referrer","macros","$timeout","$q","$window","modal","archiveService","confirm"],k.$inject=["keyboardManager"];var y=function(a){return a.replace(/<br[^>]*>/gi,"&nbsp;").replace(/<\/?[^>]+><\/?[^>]+>/gi," ").replace(/<\/?[^>]+>/gi,"").trim().replace(/&nbsp;/g," ")};m.$inject=[],n.$inject=[],o.$inject=["storage","preferencesService"],p.$inject=["authThemes"],q.$inject=["$q","api","desks","notify","authoringWorkspace","superdeskFlags","$location","macros","$rootScope","authoring","send","editor","confirm","archiveService","preferencesService","multi"],r.$inject=["autosave","authoring","metadata","$filter","superdesk"],angular.module("superdesk.authoring",["superdesk.menu","superdesk.editor","superdesk.activity","superdesk.authoring.widgets","superdesk.authoring.metadata","superdesk.authoring.comments","superdesk.authoring.versioning","superdesk.authoring.versioning.versions","superdesk.authoring.versioning.history","superdesk.authoring.workqueue","superdesk.authoring.packages","superdesk.authoring.find-replace","superdesk.authoring.macros","superdesk.desks"]).service("authoring",e).service("autosave",d).service("confirm",g).service("lock",f).service("authThemes",o).service("authoringWorkspace",v).directive("sdDashboardCard",l).directive("sdSendItem",q).directive("sdCharacterCount",m).directive("sdWordCount",n).directive("sdThemeSelect",p).directive("sdArticleEdit",r).directive("sdAuthoring",j).directive("sdAuthoringTopbar",k).directive("sdAuthoringContainer",s).directive("sdAuthoringEmbedded",t).directive("sdAuthoringHeader",u).config(["superdeskProvider",function(a){a.activity("authoring",{category:"/authoring",href:"/authoring/:_id",when:"/authoring/:_id",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:i,filters:[{action:"author",type:"article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}],action:[function(){return"edit"}]},authoring:!0}).activity("edit.item",{label:gettext("Edit"),priority:10,icon:"pencil",keyboardShortcut:"ctrl+e",controller:["data","authoringWorkspace",function(a,b){b.edit(a.item?a.item:a)}],filters:[{action:"list",type:"archive"},{action:"edit",type:"item"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).edit}]}).activity("kill.text",{label:gettext("Kill item"),priority:100,icon:"kill",group:"corrections",controller:["data","authoringWorkspace","api",function(a,b,c){"archived"===a.item._type?a.item._initiateKill=!0:b.kill(a.item)}],filters:[{action:"list",type:"archive"},{action:"list",type:"archived"}],additionalCondition:["authoring","item","privileges",function(a,b,c){return"archived"===b._type?c.privileges.archived:a.itemActions(b).kill}],privileges:{kill:1}}).activity("correct.text",{label:gettext("Correct item"),priority:100,icon:"edit-line",group:"corrections",controller:["data","authoringWorkspace",function(a,b){b.correct(a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).correct}],privileges:{correct:1}}).activity("view.item",{label:gettext("Open"),priority:2e3,icon:"external",keyboardShortcut:"ctrl+o",controller:["data","authoringWorkspace",function(a,b){b.view(a.item||a)}],filters:[{action:"list",type:"archive"},{action:"list",type:"archived"},{action:"list",type:"legal_archive"},{action:"view",type:"item"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).view}]}).activity("edit.crop",{label:gettext("EDIT CROP"),modal:!0,cssClass:"upload-avatar modal-static modal-responsive",controller:h,templateUrl:"scripts/superdesk-authoring/views/change-image.html",filters:[{action:"edit",type:"crop"}]})}]).config(["apiProvider",function(a){a.api("move",{type:"http",backend:{rel:"move"}})}]).config(["apiProvider",function(a){a.api("content_templates_apply",{type:"http",backend:{rel:"content_templates_apply"}})}]).run(["keyboardManager","gettext",function(a,b){a.register("Authoring","ctrl + shift + u",b("Unlocks current item")),a.register("Authoring","ctrl + shift + e",b("Closes current item")),a.register("Authoring","ctrl + shift + s",b("Saves current item"))}]),s.$inject=["authoring","authoringWorkspace"],t.$inject=[],u.$inject=["api","authoringWidgets","$rootScope","archiveService","metadata"],v.$inject=["$location","superdeskFlags","authoring","lock"]}(),function(){"use strict";function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c,d,e,f){a.active=null,a.$watch("item",function(b){if(!b)return void(a.widgets=null);var g;g=d.isLegal(b)?"legalArchive":d.isArchived(b)?"archived":"composite"===b.type?"packages":"killed"===b.state?"killedItem":"authoring",a.widgets=c.filter(function(a){return!!a.display[g]}),angular.forEach(_.sortBy(a.widgets,"order"),function(b,c){e.bind("ctrl+"+(c+1),function(){a.activate(b)},{inputDisabled:!1}),f.search()[b._id]&&a.activate(b)})}),a.isLocked=function(b){return b.needUnlock&&a.item._locked||b.needEditable&&!a.item._editable},a.activate=function(b){a.isLocked(b)||(a.active=a.active===b?null:b)},this.activate=function(b){a.activate(b)},a.closeWidget=function(b){a.active=null},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)}),a.$watch("item._locked",function(){if(a.active){var b=a.active;a.closeWidget(b),a.activate(b)}})}function c(a){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0,link:function(b,c){function d(){e.scrollTop()>5?f.addClass("authoring-sticky--fixed"):f.removeClass("authoring-sticky--fixed")}b.userLookup=a.userLookup;var e=c.find(".page-content-container"),f=c.find(".authoring-sticky");e.on("scroll",_.debounce(d,100))}}}b.$inject=["$scope","$routeParams","authoringWidgets","archiveService","keyboardManager","$location"],c.$inject=["desks"],angular.module("superdesk.authoring.widgets",["superdesk.keyboard"]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c).run(["keyboardManager","gettext",function(a,b){a.register("Authoring","ctrl + #",b("Toggles widget #"))}])}(),function(){"use strict";function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c,e,f){function g(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function h(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",g),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(g))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&g()}),a.$on("$locationChangeSuccess",h),h()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))});var g=e.match(/\#([a-zA-Z0-9-_.]\w+)/g);_.each(g,function(a){var c=a.substring(1,a.length);b.comment.mentioned_desks&&b.comment.mentioned_desks[c]&&(e=e.replace(a,'<a href="">'+a+"</a>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio","superdesk.api","superdesk.keyboard"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html",order:3,side:"right",display:{authoring:!0,packages:!0,killedItem:!0,legalArchive:!1,archived:!1}})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){"use strict";angular.module("superdesk.authoring.versioning",[]).config(["authoringWidgetsProvider",function(a){a.widget("versioning",{icon:"revision",label:gettext("Versioning"),removeHeader:!0,template:"scripts/superdesk-authoring/versioning/views/versioning.html",order:4,side:"right",display:{authoring:!0,packages:!0,killedItem:!0,legalArchive:!0,archived:!1}})}])}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){f.initialize().then(function(){a.desks=f.desks,a.stages=f.deskStages,a.users=f.users,g.getVersionHistory(a.item,f,"versions").then(function(c){a.versions=c,a.last=g.lastVersion(a.item,a.versions),g.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.canRevert=!1,a.desks=null,a.stages=null,a.openAutosave=function(){a.selected=a.item._autosave,a.closePreview()},a.openVersion=function(b){a.item._editable&&(a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview())},a.revert=function(b){a.$parent.revert(b).then(h)},a.$watchGroup(["item._id","item._latest_version"],h)}function b(){
return{templateUrl:"scripts/superdesk-authoring/versioning/versions/views/versions.html"}}a.$inject=["$scope","authoring","api","notify","lock","desks","archiveService"],b.$inject=[],angular.module("superdesk.authoring.versioning.versions",[]).directive("sdVersioningVersion",b).controller("VersioningWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){e.initialize().then(function(){a.desks=e.desks,a.stages=e.deskStages,a.users=e.users,f.getVersionHistory(a.item,e,"operations").then(function(c){a.versions=c,a.last=f.lastVersion(a.item,a.versions),f.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.desks=null,a.stages=null,a.openVersion=function(b){a.item._editable&&(a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview())},a.$watchGroup(["item._id","item._latest_version"],g)}function b(){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/history.html"}}function c(a,b){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/publish_queue.html",scope:{item:"="},link:function(c){c.transmitted_item=null,c.show_transmission_details=!1,c.showFormattedItem=function(a){c.transmitted_item=a.formatted_item},c.hideFormattedItem=function(){c.transmitted_item=null},c.showOrHideTransmissionDetails=function(){if(c.show_transmission_details=!c.show_transmission_details,c.show_transmission_details){var d={max_results:20};d.where=JSON.stringify({$and:[{item_id:c.item._id},{item_version:c.item._current_version}]});var e;e=b.isLegal(c.item)?a.legal_publish_queue.query(d):a.publish_queue.query(d),e.then(function(a){_.each(a._items,function(a){angular.isUndefined(a.completed_at)&&(a.completed_at=a._updated)}),c.queuedItems=a._items})}}}}}a.$inject=["$scope","authoring","api","notify","desks","archiveService"],b.$inject=[],c.$inject=["api","archiveService"],angular.module("superdesk.authoring.versioning.history",[]).directive("sdVersioningHistory",b).directive("sdTransmissionDetails",c).controller("HistoryWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(b){var d,e,f,g,h={};d=c.values.categories||[],g=b["categories:preferred"].selected||{},f=a.item.anpa_category||[],f.forEach(function(a){h[a.qcode]=!0}),e=_.filter(d,function(a){return g[a.qcode]&&!h[a.qcode]}),a.availableCategories=_.sortBy(e,"name")}function j(b,c){b!==c&&(a.item.publish_schedule_date&&a.item.publish_schedule_time?a.item.publish_schedule=f.mergeDateTime(a.item.publish_schedule_date,a.item.publish_schedule_time).format():a.item.publish_schedule=null,a.autosave(a.item))}function k(b,c){b!==c&&(a.item.embargo_date&&a.item.embargo_time?a.item.embargo=f.mergeDateTime(a.item.embargo_date,a.item.embargo_time).format():a.item.embargo=null,a.autosave(a.item))}function l(){if(a.item.embargo){var b=new Date(Date.parse(a.item.embargo));a.item.embargo_date=d("formatDateTimeString")(b,"MM/DD/YYYY"),a.item.embargo_time=d("formatDateTimeString")(b,"HH:mm:ss")}if(a.item.publish_schedule){var c=new Date(Date.parse(a.item.publish_schedule));a.item.publish_schedule_date=d("formatDateTimeString")(c,"MM/DD/YYYY"),a.item.publish_schedule_time=d("formatDateTimeString")(c,"HH:mm:ss")}}b.initialize().then(function(){a.deskLookup=b.deskLookup,a.userLookup=b.userLookup}),c.initialize().then(function(){return a.metadata=c.values,g.get()}).then(i),a.processGenre=function(){a.item.genre=_.map(a.item.genre,function(a){return _.pick(a,"name")})},a.disableAddingTargetedFor=function(){return!a.item._editable||angular.isUndefined(a.item.targeted_for_value)||""===a.item.targeted_for_value},a.addTargeted=function(){if(angular.isUndefined(a.item.targeted_for)&&(a.item.targeted_for=[]),!angular.isUndefined(a.item.targeted_for_value)&&""!==a.item.targeted_for_value){var b={name:a.item.targeted_for_value};angular.isUndefined(_.find(a.item.targeted_for,b))&&(b.allow=angular.isUndefined(a.item.negation)?!0:!a.item.negation,a.item.targeted_for.push(b),a.autosave(a.item))}},a.removeTargeted=function(b){angular.isDefined(_.find(a.item.targeted_for,b))&&(a.item.targeted_for=_.without(a.item.targeted_for,b),a.autosave(a.item))},a.$watch("item.publish_schedule_date",function(a,b){j(a,b)}),a.$watch("item.publish_schedule_time",function(a,b){j(a,b)}),a.$watch("item.embargo_date",function(a,b){k(a,b)}),a.$watch("item.embargo_time",function(a,b){k(a,b)}),a.unique_name_editable=Boolean(e.privileges.metadata_uniquename),l()}function b(a,b){return{require:"dropdown",link:function(a,c,d,e){a.$watch(e.isOpen,function(a){a?_.defer(function(){var a={inputDisabled:!1},d=c.find(".dropdown-menu button");d.length>0&&d[0].focus(),b.push("up",function(){if(d.length>0){var a=c.find("button:focus")[0],b=_.findIndex(d,function(b){return b===a});b>0&&b<d.length&&d[b-1].focus()}},a),b.push("down",function(){if(d.length>0){var a=c.find("button:focus")[0],b=_.findIndex(d,function(b){return b===a});b<d.length-1&&d[b+1].focus()}},a)}):a===!1&&(b.pop("down"),b.pop("up"))})}}}function c(a,b,c){return{scope:{list:"=",disabled:"=ngDisabled",item:"=",field:"@",icon:"@",label:"@",change:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-dropdown.html",link:function(c,d){c.select=function(a){var b={};angular.isDefined(a)?b[c.field]="place"===c.field||"genre"===c.field?[a]:a.value:b[c.field]=null,_.extend(c.item,b),c.change({item:c.item}),_.defer(function(){d.find(".dropdown-toggle").focus()})},a(function(){c.list&&("place"===c.field?c.places=_.groupBy(c.list,"group"):"genre"===c.field&&(c.list=b("sortByName")(c.list)))})}}}function d(a){return{scope:{item:"=",field:"@",disabled:"=",list:"=",change:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-words-list.html",link:function(b,c){b.words=[],b.selectedTerm="",a(function(){c.find("input, select").addClass("line-input"),b.list&&(b.words=b.list)}),b.search=function(a){return a?b.words=_.filter(b.list,function(b){return-1!==b.name.toLowerCase().indexOf(a.toLowerCase())}):b.words=b.list,b.selectedTerm=a,b.words},b.select=function(a){var c=a?a.value:b.selectedTerm,d=_.clone(b.item[b.field])||[],e=_.findIndex(d,function(a){return a.toLowerCase()===c.toLowerCase()});if(0>e){d.push(c.toUpperCase());var f={};f[b.field]=d,_.extend(b.item,f),b.change({item:b.item})}b.selectedTerm=""},b.removeTerm=function(a){var c=_.without(b.item[b.field],a),d={};d[b.field]=c,_.extend(b.item,d),b.change({item:b.item})}}}}function e(a,b){return{scope:{item:"=",field:"@",disabled:"=ngDisabled",list:"=",unique:"=",postprocessing:"&",change:"&",header:"@",reloadList:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-terms.html",link:function(c,d){a.subjectScope=c;var e="true"===c.reloadList?!0:!1;c.combinedList=[],c.$watch("unique",function(a){c.uniqueField=a||"qcode"}),c.$watch("list",function(a){if(a&&0!==a.length){var b={};angular.forEach(a,function(a){var c=a.parent||null;b.hasOwnProperty(c)?b[c].push(a):b[c]=[a]}),c.terms=a,c.tree=b,c.activeTree=b[null],c.item[c.field]&&(c.combinedList=_.union(c.list,c.item[c.field]))}}),c.$on("$destroy",function(){a.subjectScope=null}),c.openParent=function(a,b){var d=_.find(c.list,{qcode:a.parent});c.openTree(d,b)},c.openTree=function(a,b){c.activeTerm=a,c.activeTree=c.tree[a?a.qcode:null],b.stopPropagation(),_.defer(function(){d.find("button:not([disabled]):not(.dropdown-toggle)")[0].focus()})},c.activeList=!1,c.selectedTerm="",c.searchTerms=function(a){if(a){var b=e?c.list:c.combinedList;c.terms=_.filter(b,function(b){var d={};return d[c.uniqueField]=b[c.uniqueField],-1!==b.name.toLowerCase().indexOf(a.toLowerCase())&&!_.find(c.item[c.field],d)}),c.activeList=!0}else c.terms=c.list,c.activeList=!1;return c.terms},c.selectTerm=function(a){if(a){if(!_.find(c.item[c.field],function(b){return b.qcode===a.qcode})){var b=_.clone(c.item[c.field])||[];b.push(a);var f={};f[c.field]=b,_.extend(c.item,f)}c.selectedTerm="",e||(c.terms=_.without(c.terms,a),c.activeTree=_.without(c.activeTree,a)),c.postprocessing(),c.change({item:c.item}),_.defer(function(){d.find(".dropdown-toggle").focus(),e?(c.activeTerm=null,c.searchTerms(null),c.activeTree=c.tree[null]):c.terms=_.clone(c.activeTree)||[]})}},c.removeTerm=function(a){var d={},f=c.item[c.field],g=_.without(f,a);f&&g.length===f.length&&_.remove(g,{name:a}),d[c.field]=g,_.extend(c.item,d),e||(c.terms.push(a),c.activeTree.push(a),c.activeTree=b("sortByName")(c.activeTree)),c.terms=b("sortByName")(c.terms),c.change({item:c.item})}}}}function f(a){return{scope:{item:"=",fieldprefix:"@",field:"@",disabled:"=ngDisabled",list:"=",change:"&",postprocessing:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-locators.html",link:function(b,c){b.selectedTerm="",a(function(){b.item&&(b.fieldprefix&&b.item[b.fieldprefix]&&b.item[b.fieldprefix][b.field]?b.selectedTerm=b.item[b.fieldprefix][b.field].city:b.item[b.field]&&(b.selectedTerm=b.item[b.field].city)),b.list&&(b.locators=b.list)}),b.searchLocator=function(a){return a?b.locators=_.filter(b.list,function(b){return-1!==b.city.toLowerCase().indexOf(a.toLowerCase())}):b.locators=b.list,b.selectedTerm=a,b.locators},b.selectLocator=function(a){var c={};if(!a&&b.selectedTerm){var d=b.fieldprefix?b.item[b.fieldprefix][b.field]:b.item[b.field];a=b.selectedTerm===d.city?d:{city:b.selectedTerm,city_code:b.selectedTerm,tz:"UTC",dateline:"city",country:"",country_code:"",state_code:"",state:""}}a&&(angular.isDefined(b.fieldprefix)?(angular.isDefined(b.item[b.fieldprefix])||_.extend(b.item,{dateline:{}}),c[b.fieldprefix]=b.item[b.fieldprefix],c[b.fieldprefix][b.field]=a):c[b.field]=a,b.selectedTerm=a.city,_.extend(b.item,c));var e={item:b.item,city:b.selectedTerm};b.postprocessing(e),b.change(e)}}}}function g(a,b){var c={values:{},subjectScope:null,loaded:null,fetchMetadataValues:function(){var b=this;return a("vocabularies").query().then(function(a){_.each(a._items,function(a){b.values[a._id]=a.items}),b.values.targeted_for=_.sortBy(_.union(b.values.geographical_restrictions,b.values.subscriber_types),function(a){return"all"===a.value.toLowerCase()?"":a.name})})},fetchSubjectcodes:function(b){var c=this;return a.get("/subjectcodes").then(function(a){c.values.subjectcodes=a._items})},removeSubjectTerm:function(a){var b=this,c={},d=b.subjectScope.item[b.subjectScope.field],e=_.without(d,a);e.length===d.length&&_.remove(e,{name:a}),c[b.subjectScope.field]=e,_.extend(b.subjectScope.item,c),b.subjectScope.change({item:b.subjectScope.item})},fetchCities:function(){var b=this;return a.get("/cities").then(function(a){b.values.cities=a._items})},initialize:function(){return this.loaded||(this.loaded=this.fetchMetadataValues().then(angular.bind(this,this.fetchSubjectcodes)).then(angular.bind(this,this.fetchCities))),this.loaded}};return c}a.$inject=["$scope","desks","metadata","$filter","privileges","datetimeHelper","preferencesService","archiveService"],b.$inject=["$timeout","keyboardManager"],c.$inject=["$timeout","$filter","keyboardManager"],d.$inject=["$timeout"],e.$inject=["metadata","$filter"],f.$inject=["$timeout"],g.$inject=["api","$q"],angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),removeHeader:!0,template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1,side:"right",display:{authoring:!0,packages:!0,killedItem:!0,legalArchive:!0,archived:!0}})}]).controller("MetadataWidgetCtrl",a).service("metadata",g).directive("sdMetaTerms",e).directive("sdMetaDropdown",c).directive("sdMetaWordsList",d).directive("sdMetadropdownFocus",b).directive("sdMetaLocators",f)}(),function(){"use strict";function a(a,b){this.items=[],this.fetch=function(){return a.getIdentity().then(angular.bind(this,function(a){return b.query("archive",{source:{filter:{term:{lock_user:a._id}}}}).then(angular.bind(this,function(a){return this.items=null,this.items=a._items||[],this.items}))}))},this.updateItem=function(a){var c=_.find(this.items,{_id:a});return c?b.find("archive",a).then(function(a){return angular.extend(c,a)}):void 0}}function b(a,b,c,d,e,f,g,h,i,j){function k(){c.fetch().then(function(){var d=b.current||{_id:null,params:{}};a.isMultiedit="multiedit"===d._id,a.active=null,d.params.item&&(a.active=_.find(c.items,{_id:d.params.item}))})}a.active=null,a.workqueue=c,a.multiEdit=e,a.$on("$locationChangeSuccess",k),a.$on("content:update",k),a.$on("item:lock",k),a.$on("item:unlock",function(b,e){var f=_.find(c.items,{_id:e.item});f&&i.sessionId!==e.lock_session&&a.active!==f&&j.unlock(f,e.user,f.headline),f&&f.linked_in_packages&&_.each(f.linked_in_packages,function(a){var b=_.find(c.items,{_id:a["package"]});b&&d.edit(b)}),k()}),a.$on("media_archive",function(a,b){c.updateItem(b.item)}),k(),a.openDashboard=function(){f.intent("author","dashboard")},a.closeItem=function(b){g.unlock(b),d.item&&b._id===d.item._id&&d.close(!0),e.items=_.without(e.items,_.find(e.items,{article:b._id})),0===e.items.length&&a.redirectOnCloseMulti()},a.openMulti=function(){a.isMultiedit=!0,k(),e.open()},a.closeMulti=function(){e.exit(),a.redirectOnCloseMulti()},a.redirectOnCloseMulti=function(){this.isMultiedit&&(this.isMultiedit=!1,h.url("/workspace/monitoring"))}}function c(a,b,c){return{templateUrl:"scripts/superdesk-authoring/views/opened-articles.html",controller:"Workqueue",scope:{},link:function(c){c.edit=function(a,d){d.ctrlKey||(c.active=a,b.edit(a),c.redirectOnCloseMulti(),d.preventDefault())},c.link=function(b){return b?a.link("authoring",b):void 0}}}}function d(){return{templateUrl:"scripts/superdesk-authoring/views/dashboard-articles.html",controller:"Workqueue"}}a.$inject=["session","api"],b.$inject=["$scope","$route","workqueue","authoringWorkspace","multiEdit","superdesk","lock","$location","session","authoring"],c.$inject=["$rootScope","authoringWorkspace","$location"],angular.module("superdesk.authoring.workqueue",["superdesk.activity","superdesk.notification","superdesk.authoring.multiedit"]).service("workqueue",a).controller("Workqueue",b).directive("sdWorkqueue",c).directive("sdDashboardArticles",d)}(),function(){"use strict";function a(a,b,c,d,e){function f(){var b=e.query();b.clear_filters();var c=[];_.forEach(a.item.linked_in_packages,function(a){c.push(a["package"])}),b.size(25).filter({terms:{guid:c}}),d.archive.query(b.getCriteria(!0)).then(function(b){a.contentItems=b._items})}a.contentItems=[],a.openPackage=function(a){c.intent("edit","item",a)},a.item&&a.item.linked_in_packages&&a.item.linked_in_packages.length>0&&f()}return a.$inject=["$scope","$location","superdesk","api","search"],angular.module("superdesk.authoring.packages",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("packages",{icon:"package",label:gettext("Packages"),template:"scripts/superdesk-authoring/packages/views/packages-widget.html",order:5,side:"right",display:{authoring:!0,packages:!0,killedItem:!0,legalArchive:!1,archived:!1}})}]).controller("PackagesWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c){return{link:function(a,b){a.to="",a.from="",a.caseSensitive=!0,a.next=function(){c.selectNext()},a.prev=function(){c.selectPrev()},a.replace=function(){c.replace(a.to||""),c.selectNext()},a.replaceAll=function(){c.replaceAll(a.to||"")},a.$watch("from",function(b){var d=document.getElementById("find-replace-what"),e=d.selectionStart,f=d.selectionEnd;c.setSettings({findreplace:{needle:b,caseSensitive:a.caseSensitive}}),c.render(),c.selectNext(),d.setSelectionRange(e,f)}),a.$watch("caseSensitive",function(b){c.setSettings({findreplace:{needle:a.from,caseSensitive:b}}),c.render(),c.selectNext()}),a.$on("$destroy",function(){c.setSettings({findreplace:null}),c.render()})}}}a.$inject=["$timeout","$rootScope","editor"],angular.module("superdesk.authoring.find-replace",["superdesk.editor","superdesk.authoring.widgets"]).directive("sdFindReplace",a).config(["authoringWidgetsProvider",function(a){a.widget("find-replace",{icon:"find-replace",label:gettext("Find and Replace"),template:"scripts/superdesk-authoring/editor/views/find-replace.html",order:2,side:"right",needEditable:!0,needUnlock:!0,display:{authoring:!0,packages:!1,killedItem:!1,legalArchive:!1,archived:!1}})}])}(),function(){"use strict";function a(a,b,c){function d(a){return{article:a}}var e=2,f="multiedit",g=a.getItem(f);this.items=null===g?[]:g,this.minBoards=function(){return e},this.create=function(a){var b=this;if(b.items=[],a&&_.each(a,function(a){b.items.push(d(a))}),b.items.length<e)for(var c=0;c<e-b.items.length;c++)b.items.push(d(null));b.updateItems(),b.open()},this.exit=function(a){this.items=[],this.updateItems()},this.open=function(){c.getState()&&c.close(!0),b.intent("author","multiedit")},this.updateItems=function(){a.setItem(f,this.items)},this.edit=function(a,b){this.items[b]?this.items[b].article=a:this.items[b]=d(a),this.updateItems()},this.remove=function(a){_.extend(_.find(this.items,{article:a}),{article:null}),this.updateItems()},this.close=function(a){this.items.length>e&&(this.items.splice(a,1),this.updateItems())}}function b(a,b,c,d,e){a.$watch(function(){return b.items},function(b){a.boards=b}),a.minBoards=b.minBoards(),a.closeBoard=function(a){b.close(a)},a.closeMulti=function(){b.exit(),c.url("/workspace/monitoring")}}function c(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-dropdown.html",link:function(d){d.current=c.current.params.item,d.queue=[d.current],d.$watch(function(){return a.items},function(a){d.items=a}),d.toggle=function(a){return a===d.current?!1:void(d.selected(a)?d.queue=_.without(d.queue,a):d.queue.push(a))},d.selected=function(a){return-1!==_.indexOf(d.queue,a)},d.open=function(){b.create(d.queue)}}}}function d(a,b){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-inner-dropdown.html",link:function(c,d,e){function f(){c.items=_.filter(g,function(a){return-1===_.indexOf(h,a._id)})}var g=[],h=[];c.$watch(function(){return b.items},function(a){h=_.map(b.items,function(a){return a.article}),f()},!0),c.$watch(function(){return a.items},function(a){g=a,f()}),c.open=function(a){b.edit(a,e.board)}}}}function e(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-article.html",scope:{article:"=",focus:"="},link:function(d,e){function f(){a.open(d.article).then(function(b){d.origItem=b,d.item=_.create(b),d._editable=a.isEditable(b),d.isMediaType=_.contains(["audio","video","picture"],d.item.type),d.focus&&c(function(){e.children().focus()},0,!1)})}d.$watch("article",function(a,b){a&&a!==b&&f()}),f(),d.autosave=function(b){d.dirty=!0,a.autosave(b)},d.save=function(b,c){return a.save(d.origItem,b).then(function(a){return c&&c.$setPristine(),a})},d.remove=function(a){b.remove(a._id)},d.isPublished=function(b){return null!=b?a.isPublished(b):void 0}}}}function f(a){return{link:function(b,c){function d(){f=!1,$("#multiedit-float").hide()}function e(b,c){var d=a.height(),e=a.width(),f={right:e-b};return 400>d-c?(f.bottom=d-c,f.top="auto"):(f.top=c,f.bottom="auto"),f}var f=!1;c.bind("click",function(a){f?$("#multiedit-float").hide():(a.preventDefault(),a.stopPropagation(),$("#multiedit-float").css(e(a.pageX,a.pageY)).show()),f=!f}),a.bind("click",d),b.$on("$destroy",function(){a.unbind("click",d)})}}}a.$inject=["storage","superdesk","authoringWorkspace"],b.$inject=["$scope","multiEdit","$location","lock","workqueue"],c.$inject=["workqueue","multiEdit","$route"],d.$inject=["workqueue","multiEdit"],e.$inject=["authoring","multiEdit","$timeout"],f.$inject=["$document"],angular.module("superdesk.authoring.multiedit",["superdesk.activity","superdesk.authoring"]).service("multiEdit",a).directive("sdMultieditDropdown",c).directive("sdMultieditInnerDropdown",d).directive("sdMultieditArticle",e).directive("sdMultieditFloatMenu",f).config(["superdeskProvider",function(a){a.activity("multiedit",{category:"/authoring",href:"/multiedit",when:"/multiedit",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/multiedit/views/multiedit.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:b,filters:[{action:"author",type:"multiedit"}]})}])}(),function(){"use strict";function a(a,b,c){function d(d,e,f){return a.save("macros",{macro:d.name,item:_.omit(e),commit:!!f}).then(function(a){return angular.extend(e,a.item),f||b.save(e),e},function(a){angular.isDefined(a.data._message)&&c.error(gettext("Error: "+a.data._message))})}this.get=function(){return a.query("macros").then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.getByDesk=function(b){return a.query("macros",{desk:b}).then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.setupShortcuts=function(a){this.get().then(function(b){angular.forEach(b,function(b){b.shortcut&&a.$on("key:ctrl:"+b.shortcut,function(){d(b,a.item)})})})},this.call=d}function b(a,b,c){b.get().then(function(){var d=c.getCurrentDeskId();null!==d?b.getByDesk(c.getCurrentDesk().name).then(function(b){a.macros=b}):a.macros=b.macros}),a.call=function(c){return b.call(c,a.item)}}a.$inject=["api","autosave","notify"],b.$inject=["$scope","macros","desks"],angular.module("superdesk.authoring.macros",[]).service("macros",a).controller("Macros",b).config(["authoringWidgetsProvider",function(a){a.widget("macros",{icon:"macros",label:gettext("Macros"),template:"scripts/superdesk-authoring/macros/views/macros-widget.html",order:6,needEditable:!0,side:"right",display:{authoring:!0,packages:!0,killedItem:!1,legalArchive:!1,archived:!1}})}])}(),function(){"use strict";function a(a,b){function c(){var b=(a.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(j,{field:b[0]}),{dir:b[1]})}function e(a){var b=_.find(j,{field:a});g(b.field,b.defaultDir||"desc")}function f(){var a=c(),b="asc"===a.dir?"desc":"asc";g(a.field,b)}function g(b,c){a.search("sort",b+":"+c),a.search("page",null)}function h(a,b){_.each(d,function(c,d){if(b[d]){var e;switch(d){case"from_desk":e=b[d].split("-"),2===e.length&&("authoring"===e[1]?a.push({term:{"task.last_authoring_desk":e[0]}}):a.push({term:{"task.last_production_desk":e[0]}}));break;case"to_desk":if(e=b[d].split("-"),2===e.length&&(a.push({term:{"task.desk":e[0]}}),!b.from_desk)){var f="authoring"===e[1]?"task.last_production_desk":"task.last_authoring_desk";a.push({exists:{field:f}})}break;default:var g={term:{}};g.term[d]=b[d],a.push(g)}}})}function i(a){function b(a,b){if(a.beforefirstcreated||a.afterfirstcreated){var c={firstcreated:{}};a.beforefirstcreated&&(c.firstcreated.lte=a.beforefirstcreated),a.afterfirstcreated&&(c.firstcreated.gte=a.afterfirstcreated),b.post_filter({range:c})}if(a.beforeversioncreated||a.afterversioncreated){var d={versioncreated:{}};a.beforeversioncreated&&(d.versioncreated.lte=a.beforeversioncreated),a.afterversioncreated&&(d.versioncreated.gte=a.afterversioncreated),b.post_filter({range:d})}if(a.after){var e={firstcreated:{}};e.firstcreated.gte=a.after,b.post_filter({range:e})}if(a.type){var f={type:JSON.parse(a.type)};b.post_filter({terms:f})}a.urgency&&b.post_filter({terms:{urgency:JSON.parse(a.urgency)}}),a.priority&&b.post_filter({terms:{priority:JSON.parse(a.priority)}}),a.source&&b.post_filter({terms:{source:JSON.parse(a.source)}}),a.credit&&a.creditqcode&&b.post_filter({terms:{credit:JSON.parse(a.creditqcode)}}),a.category&&b.post_filter({terms:{"anpa_category.name":JSON.parse(a.category)}}),a.keywords&&b.post_filter({terms:{keywords:JSON.parse(a.keywords)}}),a.genre&&b.post_filter({terms:{"genre.name":JSON.parse(a.genre)}}),a.desk&&b.post_filter({terms:{"task.desk":JSON.parse(a.desk)}}),a.stage&&b.post_filter({terms:{"task.stage":JSON.parse(a.stage)}}),a.legal&&b.post_filter({terms:{"flags.marked_for_legal":JSON.parse(a.legal)}})}var d,e=[],f=[];null==a&&(a={}),this.getCriteria=function(b){var d=a,g=c();h(e,a);var i={query:{filtered:{filter:{and:e}}},sort:[_.zipObject([g.field],[g.dir])]};return f.length>0&&(i.post_filter={and:f}),d.q&&(i.query.filtered.query={query_string:{query:d.q.replace(/\//g,"\\/"),lenient:!1,default_operator:"AND"}}),b&&(i={source:i},d.repo&&(i.repo=d.repo)),i},this.filter=function(a){return e.push(a),this},this.post_filter=function(a){return f.push(a),this},this.clear_filters=function(){return e=[],f=[],b({},this),this},this.size=function(a){return d=null!=a?a:d,this},a.spike?this.filter({term:{state:"spiked"}}):this.filter({not:{term:{state:"spiked"}}}),a.ignoreKilled&&this.filter({not:{term:{state:"killed"}}}),a.onlyLastPublished&&this.filter({not:{term:{last_published_version:"false"}}}),a.ignoreDigital&&this.filter({not:{term:{package_type:"takes"}}}),a.ignoreScheduled&&this.filter({not:{term:{state:"scheduled"}}}),this.filter({not:{and:[{term:{_type:"published"}},{term:{package_type:"takes"}},{term:{last_published_version:!1}}]}}),this.filter({not:{and:[{term:{package_type:"takes"}},{term:{_type:"archive"}}]}}),b(a,this)}var j=[{field:"versioncreated",label:b("Updated")},{field:"firstcreated",label:b("Created")},{field:"urgency",label:b("News Value")},{field:"anpa_category.name",label:b("Category")},{field:"slugline.phrase",label:b("Slugline")},{field:"priority",label:b("Priority")},{field:"genre.name",label:b("Genre")}];this.getSubjectCodes=function(b,c){var d=b.selectedParameters,e=[];if(!a.search().q)return e;for(var f=0,g=d.length;g>f;f++){var h=d[f];if(-1!==h.indexOf("subject.qcode")||-1!==h.indexOf("subject.name"))for(var i=h.substring(h.lastIndexOf("(")+1,h.lastIndexOf(")")),j=0,k=c.length;k>j;j++)(c[j].qcode===i||c[j].name===i)&&e.push(c[j])}return e},this.setSort=e,this.getSort=c,this.sortOptions=j,this.toggleSortDir=f,this.query=function(a){return new i(a)},this.generateTrackByIdentifier=function(a){return"ingested"===a.state?a._id:a._id+":"+a._current_version}}function b(a,b,c,e){function f(a){for(l.selectedParameters=[];a.indexOf(":")>0&&a.indexOf(":")<a.indexOf("(",a.indexOf(":"))&&a.indexOf(":")<a.indexOf(")",a.indexOf(":"));){var b=a.indexOf(":"),c=a.substring(a.lastIndexOf(" ",b),a.indexOf(")",b)+1);if(-1!==c.indexOf("subject.qcode")){var d=c.substring(c.indexOf("(")+1,c.lastIndexOf(")")),e=_.result(_.find(m,{qcode:d}),"name");l.selectedParameters.push("subject.name:("+e+")")}else l.selectedParameters.push(c);a=a.replace(c,"")}return a}function g(a){for(l.selectedKeywords=[];a.indexOf("(")>=0&&a.indexOf(")")>0;){for(var b=a.indexOf("("),c=1;c>0&&b<a.length;){var d=a[++b];"("===d?c++:")"===d&&c--}var e=a.substring(a.indexOf("("),b+1);l.selectedKeywords.push(e),a=a.replace(e,"")}}function h(a){_.each(d,function(d,e){if(angular.isDefined(a[e]))switch(e){case"original_creator":c.getUser(a[e]).then(function(a){l.selectedParameters.push(d+":"+a.display_name)},function(a){l.selectedParameters.push(d+":Unknown")});break;case"from_desk":case"to_desk":l.selectedParameters.push(d+":"+b.deskLookup[a[e].split("-")[0]].name);break;default:l.selectedParameters.push(d+":"+a[e])}})}function i(b,c){if(c.indexOf("Last")>=0)j();else{var d=a.search();if(d[b]){var e=JSON.parse(d[b]);e.splice(e.indexOf(c),1),e.length>0?a.search(b,JSON.stringify(e)):a.search(b,null),"credit"===b&&a.search("creditqcode",null)}}}function j(){var b=a.search();b.after&&a.search("after",null)}function k(){return b.initialize().then(function(c){l.selectedFacets={},l.selectedParameters=[],l.selectedKeywords=[],l.currentSearch=a.search();var d=l.currentSearch.q;if(d){var e=f(d);g(e)}return h(l.currentSearch),_.forEach(l.currentSearch,function(a,c){if("q"!==c)if(l.selectedFacets[c]=[],"desk"===c){var d=JSON.parse(a);_.forEach(d,function(a){l.selectedFacets[c].push(b.deskLookup[a].name)})}else if("stage"===c){var e=a;_.forEach(b.deskStages[b.getCurrentDeskId()],function(a){a._id===JSON.parse(e)[0]&&l.selectedFacets[c].push(a.name)})}else"after"===c?"now-24H"===a?l.selectedFacets.date=["Last Day"]:"now-1w"===a?l.selectedFacets.date=["Last Week"]:"now-1M"===a&&(l.selectedFacets.date=["Last Month"]):n[c]&&(l.selectedFacets[c]=JSON.parse(a))}),l})}var l={};l.selectedFacets={},l.selectedParameters=[],l.selectedKeywords=[],l.currentSearch={};var m,n={type:1,category:1,keywords:1,urgency:1,priority:1,source:1,credit:1,day:1,week:1,month:1,desk:1,stage:1,genre:1,legal:1};return e.fetchSubjectcodes().then(function(){m=e.values.subjectcodes}),{initSelectedFacets:k,removeFacet:i}}function c(a,b,c,d,e,f,g,h,i){this.send=function(){return d.all(b.getItems())},this.sendAs=function(){return d.allAs(b.getItems())},this.multiedit=function(){c.create(b.getIds()),c.open()},this.createPackage=function(){e.createPackageFromItems(b.getItems()).then(function(a){f.intent("edit","item",a)},function(a){403===a.status&&a.data&&a.data._message&&g.error(gettext(a.data._message),3e3)})},this.addToPackage=function(){a.$broadcast("package:addItems",{items:b.getItems(),group:"main"})},this.spikeItems=function(){h.spikeMultiple(b.getItems()),a.$broadcast("item:spike"),b.reset()},this.unspikeItems=function(){h.unspikeMultiple(b.getItems()),a.$broadcast("item:unspike"),b.reset()},this.canSpikeItems=function(){var a=!0;return b.getItems().forEach(function(b){a=a&&i.itemActions(b).spike&&!b.lock_user}),a},this.canPackageItems=function(){var a=!0;return b.getItems().forEach(function(b){a=a&&"archived"!==b._type&&!_.contains(["ingested","spiked","killed"],b.state)}),a}}var d=Object.freeze({unique_name:"Unique Name",original_creator:"Creator",from_desk:"From Desk",to_desk:"To Desk"});a.$inject=["$location","gettext"],b.$inject=["$location","desks","userList","metadata"],angular.module("superdesk.search",["superdesk.api","superdesk.desks","superdesk.activity","superdesk.list","superdesk.keyboard"]).service("search",a).service("tags",b).controller("MultiActionBar",c).filter("FacetLabels",function(){return function(a){return"URGENCY"===a.toUpperCase()?"News Value":a}}).directive("sdSearchFacets",["$location","desks","privileges","tags","asset",function(a,b,c,d,e){return b.initialize(),{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-facets.html"),scope:{items:"=",desk:"=",repo:"=",context:"="},link:function(e,f,g,h){e.flags=h.flags,e.sTab=!0,e.editingSearch=!1,e.showSaveSearch=!1,e.aggregations={},e.privileges=c.privileges,e.$on("edit:search",function(a,b){e.sTab=!0}),e.changeTab=function(){e.sTab=!e.sTab},e.resetEditingSearch=function(){e.editingSearch=!1};var i=function(){e.aggregations={type:{},desk:{},stage:{},date:{},source:{},credit:{},category:{},keywords:{},urgency:{},priority:{},genre:{},legal:{}}};i(),e.$watch("items",function(){d.initSelectedFacets().then(function(a){e.tags=a,e.items&&void 0!==e.items._aggregations&&(angular.isDefined(e.items._aggregations.type)&&_.forEach(e.items._aggregations.type.buckets,function(a){e.aggregations.type[a.key]=a.doc_count}),angular.isDefined(e.items._aggregations.category)&&_.forEach(e.items._aggregations.category.buckets,function(a){""!==a.key&&(e.aggregations.category[a.key]=a.doc_count)}),angular.isDefined(e.items._aggregations.keywords)&&_.forEach(e.items._aggregations.keywords.buckets,function(a){""!==a.key&&(e.aggregations.keywords[a.key]=a.doc_count)}),angular.isDefined(e.items._aggregations.genre)&&_.forEach(e.items._aggregations.genre.buckets,function(a){""!==a.key&&(e.aggregations.genre[a.key]=a.doc_count)}),angular.isDefined(e.items._aggregations.urgency)&&_.forEach(e.items._aggregations.urgency.buckets,function(a){e.aggregations.urgency[a.key]=a.doc_count}),angular.isDefined(e.items._aggregations.priority)&&_.forEach(e.items._aggregations.priority.buckets,function(a){e.aggregations.priority[a.key]=a.doc_count}),angular.isDefined(e.items._aggregations.source)&&_.forEach(e.items._aggregations.source.buckets,function(a){e.aggregations.source[a.key]=a.doc_count;
}),angular.isDefined(e.items._aggregations.credit)&&_.forEach(e.items._aggregations.credit.buckets,function(a){e.aggregations.credit[a.key]={count:a.doc_count,qcode:a.qcode}}),angular.isDefined(e.items._aggregations.day)&&_.forEach(e.items._aggregations.day.buckets,function(a){e.aggregations.date["Last Day"]=a.doc_count}),angular.isDefined(e.items._aggregations.week)&&_.forEach(e.items._aggregations.week.buckets,function(a){e.aggregations.date["Last Week"]=a.doc_count}),_.forEach(e.items._aggregations.month.buckets,function(a){e.aggregations.date["Last Month"]=a.doc_count}),!e.desk&&angular.isDefined(e.items._aggregations.stage)&&_.forEach(e.items._aggregations.desk.buckets,function(a){var c=b.deskLookup[a.key];if("undefined"==typeof c){var d=["Desk (key: ",a.key,") not found in ","deskLookup, probable storage inconsistency."].join("");return void console.warn(d)}e.aggregations.desk[c.name]={count:a.doc_count,id:a.key}}),e.desk&&angular.isDefined(e.items._aggregations.stage)&&_.forEach(e.items._aggregations.stage.buckets,function(a){_.forEach(b.deskStages[e.desk._id],function(b){b._id===a.key&&(e.aggregations.stage[b.name]={count:a.doc_count,id:a.key})})}),angular.isDefined(e.items._aggregations.legal)&&_.forEach(e.items._aggregations.legal.buckets,function(a){"T"===a.key&&a.doc_count>0&&(e.aggregations.legal={count:a.doc_count})}))})}),e.$watch("tags.currentSearch",function(a){e.showSaveSearch=_.isEmpty(a)?!1:!0},!0),e.toggleFilter=function(a,b){e.hasFilter(a,b)?e.removeFilter(a,b):"date"===a?e.setDateFilter(b):e.setFilter(a,b)},e.removeFilter=function(a,b){d.removeFacet(a,b)},e.setFilter=function(b,c){if(!e.isEmpty(b)&&c){var d=a.search()[b];d?(d=JSON.parse(d),d.push(c),a.search(b,JSON.stringify(d))):("credit"===b&&a.search("creditqcode",JSON.stringify([e.aggregations.credit[c].qcode])),a.search(b,JSON.stringify([c])))}else a.search(b,null)},e.setDateFilter=function(b){"Last Day"===b?a.search("after","now-24H"):"Last Week"===b?a.search("after","now-1w"):"Last Month"===b?a.search("after","now-1M"):a.search("after",null)},e.isEmpty=function(a){return _.isEmpty(e.aggregations[a])},e.format=function(a){return a?moment(a).format("YYYY-MM-DD"):null},e.hasFilter=function(a,c){return"desk"===a?e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(b.deskLookup[c].name)>=0:e.tags&&e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(c)>=0}}}}]).directive("sdSearchTags",["$location","$route","tags","asset","metadata",function(a,b,c,e,f){return{scope:{},templateUrl:e.templateUrl("superdesk-search/views/search-tags.html"),link:function(b,e){c.initSelectedFacets().then(function(a){b.tags=a}),b.removeFilter=function(a,b){c.removeFacet(a,b)},f.fetchSubjectcodes().then(function(){b.subjectcodes=f.values.subjectcodes}),b.removeParameter=function(c){var e=a.search();if(e.q)if(-1!==c.indexOf("subject.name:")){var g=c.substring(c.indexOf("(")+1,c.lastIndexOf(")")),h=_.result(_.find(b.subjectcodes,function(a){return a.name===g}),"qcode");e.q=e.q.replace("subject.qcode:("+h+")","").trim(),a.search("q",e.q||null),f.removeSubjectTerm(g)}else e.q=e.q.replace(c,"").trim(),a.search("q",e.q||null);_.each(d,function(b,d){-1!==c.indexOf(b)&&a.search(d,null)})}}}}]).directive("sdSearchResults",["$location","preferencesService","packages","asset","$timeout","api","search","session","moment","gettext","superdesk","workflowService","archiveService","activityService","multi","desks","familyService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};return{require:"^sdSearchContainer",templateUrl:d.templateUrl("superdesk-search/views/search-results.html"),link:function(d,i,j,k){function l(a){return d.rendering?void a.preventDefault():(e.cancel(y),void(y=e(m,100,!1)))}function m(){d.items&&n(A[0])&&!d.rendering&&(d.rendering=!0,q(null,!0))}function n(a){return a.scrollTop+a.offsetHeight+300>=a.scrollHeight}function o(){return z=g.query(a.search()).getCriteria(!0),z.source.size=50,z.source.from=0,d.total=null,d.items=null,d.previewingBroadcast||d.preview(null),f.query(p(z),z).then(function(a){d.total=a._meta.total,d.$applyAsync(function(){q(a)})})}function p(a){var b="search";return a.repo&&-1===a.repo.indexOf(",")&&(b=a.repo),d.repo.search&&"local"!==d.repo.search&&(b=d.repo.search),b}function q(b,c){function e(a){if(d.items)if(c){var b=d.items._items;d.items=angular.extend(a,{_items:b.concat(a._items)})}else d.items=a;else d.items=a;d.$applyAsync(function(){d.rendering=!1})}if(b)e(b);else if(c)z.source.from=(z.source.from||0)+z.source.size,f.query(p(z),z).then(e);else{var h=_.omit(a.search(),"_id");_.isEqual(_.omit(h,"page"),_.omit(B,"page"))||a.search("page",null),z=g.query(a.search()).getCriteria(!0),z.source.from=0,z.source.size=50,f.query(p(z),z).then(e),B=h}}function s(a,b){h.identity._id===b.user&&o()}function t(a){d.view=a||"mgrid",r["archive:view"].view=a||"mgrid",b.update(r,"archive:view")}function u(){var a=d.view===w?v:w;return t(a)}var v="mgrid",w="compact",x=void 0===j.multiSelectable?!1:!0;d.previewingBroadcast=!1;var y,z=g.query(a.search()).getCriteria(!0),A=i.find(".shadow-list-holder"),B=_.omit(a.search(),"_id");d.flags=k.flags,d.selected=d.selected||{},d.rendering=!1,d.repo={ingest:!0,archive:!0,published:!0,archived:!0},d.context="search",d.$on("item:deleted:archived",s),d.$on("item:fetch",o),d.$on("item:spike",o),d.$on("item:unspike",o),d.$on("item:duplicate",o),d.$on("content:expired",o),d.$on("broadcast:preview",function(a,b){d.previewingBroadcast=!0,d.preview(b.item)}),d.$on("broadcast:created",function(a,b){d.previewingBroadcast=!0,o(),d.preview(b.item)}),A.on("scroll",l),d.$watch("selected",function(a,b){!a&&d.previewingBroadcast&&(d.previewingBroadcast=!1)}),d.$watch(function(){return _.omit(a.search(),"_id")},function(a,b){a!==b&&o()},!0),d.preview=function(b){x&&(-1===_.findIndex(d.selectedList,{_id:b._id})?d.selectedList.push(b):_.remove(d.selectedList,{_id:b._id})),d.selected.preview=b,a.search("_id",b?b._id:null)},o(),d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.openSingleItem=function(a){c.fetchItem(a).then(function(a){d.selected.view=a})},d.setview=t;var C;b.get("archive:view").then(function(a){C=a.view,d.view=C&&"undefined"!==C?C:"mgrid"}),d.$on("key:v",u),d.uuid=function(a){return g.generateTrackByIdentifier(a)}}}}]).directive("sdItemsList",["$location","$document","$timeout","packages","asset","api","search","session","moment","gettext","superdesk","workflowService","archiveService","activityService","multi","desks","familyService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){return{controllerAs:"listController",controller:["$q","ingestSources","desks","highlightsService",function(a,b,c,d){var e=this;e.ready=a.all({ingestProvidersById:b.initialize().then(function(){e.ingestProvidersById=b.providersLookup}),desksById:c.initialize().then(function(){e.desksById=c.deskLookup}),highlightsById:d.get().then(function(a){e.highlightsById={},a._items.forEach(function(a){e.highlightsById[a._id]=a})})})}],link:function(d,e){function f(a){return"picture"===a.type&&a.renditions.thumbnail}var g=function(a){var b,c=a.item,d=c.headline||c.slugline||c.type;return f(a.item)&&(b=React.createElement("img",{src:a.item.renditions.thumbnail.href})),React.createElement("div",{className:"media multi"},b?React.createElement("figure",null,b):null,React.createElement("span",{className:"text"},React.createElement("small",{title:d},d.substr(0,90)),React.createElement(r,{item:c,desk:a.desk})),React.createElement(h,{item:c,onMultiSelect:a.onMultiSelect}))},h=React.createClass({toggle:function(a){a.stopPropagation();var b=!this.props.item.selected;this.props.onMultiSelect(this.props.item,b)},render:function(){return React.createElement("div",{className:"selectbox",onClick:this.toggle},React.createElement("span",{className:"sd-checkbox"+(this.props.item.selected?" checked":"")}))}}),r=function(a){var b,c,d=a.item,e=a.desk||null;return"ingest"!==d._type&&(e?(b=j("desk:"),c=e.name):"archive"===d._type?(b=j("location:"),c=j("workspace")):"published"===d._type&&d.allow_post_publish_actions===!1&&(b="",c=j("archived"))),React.createElement("span",{className:"container",title:c?b+" "+c:null},React.createElement("span",{className:"location-desk-label"},b),c)},s=function(a){var b=a.item,c=[];a.ingestProvider&&c.push(React.createElement("dt",{key:1},j("source")),React.createElement("dd",{key:2,className:"provider"},a.ingestProvider.name)),c.push(React.createElement("dt",{key:3},j("updated")),React.createElement("dd",{key:4},i(b.versioncreated).fromNow())),b.is_spiked&&(c.push(React.createElement("dt",{key:5},j("expires"))),c.push(React.createElement("dd",{key:6},i(b.expiry).fromNow())));var d=[],e=b.flags||{};return d.push(React.createElement("h5",{key:1},b.slugline||b.type)),d.push(React.createElement("dl",{key:2},c)),e.marked_for_not_publication&&d.push(React.createElement("div",{key:3,className:"state-label not-for-publication"},j("Not for publication"))),e.marked_for_legal&&d.push(React.createElement("div",{key:4,className:"state-label legal"},j("Legal"))),b.archived&&d.push(React.createElement("div",{className:"fetched-desk",key:5},React.createElement(A,{item:b}))),React.createElement("div",{className:"media-info"},d)},t=function(a){return React.createElement("i",{className:"filetype-icon-"+a.type})},u=function(a){return React.createElement("span",{className:"type-icon"},React.createElement(t,{type:a.item.type}))},v=React.createClass({getInitialState:function(){return{hover:!1}},setHover:function(){this.setState({hover:!0})},unsetHover:function(){this.state.hover&&this.setState({hover:!1})},render:function(){var a=this.state.hover||this.props.item.selected;return React.createElement("div",{className:"list-field type-icon",onMouseEnter:this.setHover,onMouseLeave:this.unsetHover},a?React.createElement(h,{item:this.props.item,onMultiSelect:this.props.onMultiSelect}):React.createElement(t,{type:this.props.item.type}))}}),w=function(a){var b=a.priority||3;return React.createElement("span",{className:"priority-label priority-label--"+b},b)},x=function(a){var b=a.item;return React.createElement("div",{className:"list-field urgency"},b.priority?React.createElement("span",{className:"priority-label priority-label--"+b.priority},b.priority):React.createElement("span",{className:"output-item-label label-"+b.urgency},b.urgency))},y=React.createClass({render:function(){var a=this.props.item.highlights||[];return React.createElement("div",{className:"highlights-box"},a.length?React.createElement("div",{className:"highlights-list dropdown"},React.createElement("button",{className:"dropdown-toggle"},React.createElement("i",{className:classNames({"icon-star red":1===a.length,"icon-multi-star red":a.length>1})}))):null)}}),z=React.createClass({getInitialState:function(){return{open:!1}},toggle:function(a){a.stopPropagation(),this.setState({open:!this.state.open})},render:function(){var a=this.props.desks.map(function(a,b){return React.createElement("li",{key:"desk"+b},React.createElement("a",{disabled:!a.isUserDeskMember,onClick:this.props.openDesk(a)},a.desk.name+" ("+a.count+")"))}.bind(this));return React.createElement("dd",{className:"dropdown dropup more-actions"},React.createElement("button",{className:"dropdown-toggle",onClick:this.toggle},React.createElement("i",{className:"icon-dots"})),React.createElement("div",{className:"dropdown-menu"},React.createElement("ul",{},a)))}}),A=React.createClass({getInitialState:function(){return{desks:[]}},componentDidMount:function(){q.fetchDesks(this.props.item,!1).then(function(a){this.setState({desks:a})}.bind(this))},formatDeskName:function(a){return a.substr(0,10)+(a.length>10?"...":"")},openDesk:function(b){return function(c){c.stopPropagation(),b.isUserDeskMember&&(p.setCurrentDeskId(b.desk._id),a.url("/workspace/monitoring"),1===b.count&&k.intent("edit","item",b.item))}},render:function(){var a=[];if(a.push(React.createElement("dt",{key:"dt",style:{paddingRight:"5px"}},j("fetched in"))),this.state.desks.length){var b=this.state.desks[0],c=this.formatDeskName(b.desk.name);a.push(React.createElement("dd",{key:"dd1"},b.isUserDeskMember?React.createElement("a",{onClick:this.openDesk(b)},c):React.createElement("span",{className:"container"},c))),this.state.desks.length>1&&a.push(React.createElement(z,{key:"dd2",desks:this.state.desks,openDesk:this.openDesk}))}return React.createElement("div",{},React.createElement("dl",{},a))}}),B=function(a){var b=a.item,c=b.flags||{},d=b.anpa_category||{},e=b.broadcast||{},f=a.ingestProvider||{name:null};return React.createElement("div",{className:"item-info"},React.createElement("div",{className:"line"},React.createElement("span",{className:"word-count"},b.word_count),b.slugline?React.createElement("span",{className:"keyword"},b.slugline.substr(0,40)):null,React.createElement(y,{item:b}),React.createElement("span",{className:"item-heading"},b.headline?b.headline.substr(0,90):b.type),React.createElement("time",{},i(b.versioncreated).fromNow())),React.createElement("div",{className:"line"},React.createElement("div",{className:"state-label state-"+b.state},b.state),b.anpa_take_key?React.createElement("div",{className:"takekey"},b.anpa_take_key):null,b.signal?React.createElement("span",{className:"signal"},b.signal):null,e.status?React.createElement("span",{className:"broadcast-status",tooltip:e.status},"!"):null,c.marked_for_not_publication?React.createElement("div",{className:"state-label not-for-publication"},j("Not for Publication")):null,c.marked_for_legal?React.createElement("div",{className:"state-label legal"},j("Legal")):null,d.name?React.createElement("div",{className:"category"},d.name):null,React.createElement("span",{className:"provider"},f.name),b.is_spiked?React.createElement("div",{className:"expires"},j("expires")+" "+i(b.expiry).fromNow()):null,b.archived?React.createElement(A,{item:b}):null,React.createElement(r,{item:b,desk:a.desk})))},C=function(a){var b=a.urgency||3;return React.createElement("span",{className:"urgency-label urgency-label--"+b},b)},D=function(a){var b=a.broadcast||{};return React.createElement("span",{className:"broadcast-status",tooltip:b.status},"!")},E=React.createClass({toggle:function(a){this.setState({open:!this.state.open}),this.stopEvent(a)},stopEvent:function(a){a.stopPropagation()},getInitialState:function(){return{open:!1}},getActions:function(){var a=this.props.item,b=this.getType(),c={action:"list",type:b},d={};return k.findActivities(c,a).forEach(function(b){if(l.isActionAllowed(a,b.action)){var c=b.group||"default";d[c]=d[c]||[],d[c].push(b)}}),d},getType:function(){return m.getType(this.props.item)},groups:[{_id:"default",label:j("Actions")},{_id:"packaging",label:j("Packaging")},{_id:"highlights",label:j("Highlights")},{_id:"corrections",label:j("Corrections")}],render:function(){var a=[],b=this.props.item,c=function(a){return React.createElement(E.Item,{item:b,activity:a,key:a._id})}.bind(this);if(this.state.open){var d=this.getActions();this.groups.map(function(b){d[b._id]&&(a.push(React.createElement(E.Label,{label:b.label,key:"group-label-"+b._id}),React.createElement(E.Divider,{key:"group-divider-"+b._id})),a.push.apply(a,d[b._id].map(c)))})}return React.createElement("div",{className:"item-right toolbox"},React.createElement("div",{className:"item-actions-menu dropdown-big open"},React.createElement("button",{className:"more-activity-toggle condensed dropdown-toggle",onClick:this.toggle,onDblClick:this.stopEvent},React.createElement("i",{className:"icon-dots-vertical"})),React.createElement("ul",{className:"dropdown dropdown-menu more-activity-menu open",style:{top:"66%",left:-160,display:this.state.open?"block":"none",minWidth:200}},a)))}});E.Label=function(a){return React.createElement("li",null,React.createElement("div",{className:"menu-label"},a.label))},E.Divider=function(){return React.createElement("li",{className:"divider"})},E.Item=React.createClass({run:function(a){a.stopPropagation(),n.start(this.props.activity,{data:{item:this.props.item}})},render:function(){var a=this.props.activity;return React.createElement("li",null,React.createElement("a",{title:j(a.label),onClick:this.run},React.createElement("i",{className:"icon-"+a.icon}),React.createElement("span",{style:{display:"inline"}},j(a.label))))}});var F=function(a){return React.createElement("div",{className:"archiving-progress",style:{width:a.completed+"%"}})},G=function(a){return React.createElement("div",{className:"error-box"},React.createElement("p",{className:"message"},j("There was an error archiving this item")),React.createElement("div",{className:"buttons"}))},H=React.createClass({shouldComponentUpdate:function(a,b){return a.item!==this.props.item||a.view!==this.props.view||a.flags.selected!==this.props.flags.selected||b!==this.state},select:function(){this.props.onSelect(this.props.item)},getInitialState:function(){return{hover:!1}},setHoverState:function(){this.setState({hover:!0})},unsetHoverState:function(){this.setState({hover:!1})},render:function(){var a=this.props.item,b=a.broadcast||{},c=["div",{className:classNames("media-box","media-"+a.type,{locked:a.lock_user&&a.lock_session,selected:this.props.flags.selected,archived:a.archived||a.created})}];return a._progress&&c.push(React.createElement(F,{completed:a._progress})),"mgrid"===this.props.view?c.push(a.archiveError?React.createElement(G):null,React.createElement(g,{item:a,desk:this.props.desk,onMultiSelect:this.props.onMultiSelect}),React.createElement(s,{item:a,ingestProvider:this.props.ingestProvider}),React.createElement(u,{item:a}),a.priority?React.createElement(w,{priority:a.priority}):null,a.urgency?React.createElement(C,{urgency:a.urgency}):null,b.status?React.createElement(D,{broadcast:b}):null,this.state.hover?React.createElement(E,{item:a}):null):c.push(React.createElement("span",{className:"state-border"}),React.createElement(v,{item:a,onMultiSelect:this.props.onMultiSelect}),React.createElement(x,{item:a}),React.createElement(B,{item:a,desk:this.props.desk,ingestProvider:this.props.ingestProvider}),this.state.hover?React.createElement(E,{item:a}):null),React.createElement("li",{id:a._id,key:a._id,className:classNames("list-item-view",{active:this.props.flags.selected}),onMouseEnter:this.setHoverState,onMouseLeave:this.unsetHoverState,onClick:this.select},React.createElement.apply(null,c))}}),I=Object.freeze({left:37,up:38,right:39,down:40,enter:13}),J=React.createClass({getInitialState:function(){return{itemsList:[],itemsById:{},selected:null,view:"mgrid"}},multiSelect:function(a,b){var c=angular.extend({},this.state.itemsById);c[a._id]=angular.extend({},a,{selected:b}),this.setState({itemsById:c}),o.toggle(c[a._id])},select:function(a){c.cancel(this.updateTimeout),this.updateTimeout=c(function(){d.$apply(function(){d.preview(a)})},100,!1),this.setState({selected:a._id})},updateItem:function(a,b){var c=this.state.itemsById[a]||null;if(c){var d=angular.extend({},this.state.itemsById);d[a]=angular.extend({},c,b),this.setState({itemsById:d})}},getSelectedItem:function(){var a=this.state.selected;return this.state.itemsById[a]},handleKey:function(a){var b;switch(a.keyCode){case I.right:case I.down:b=1;break;case I.left:case I.up:b=-1;break;case I.enter:return this.state.selected&&this.select(this.getSelectedItem()),void a.stopPropagation()}if(null!=b)if(a.preventDefault(),a.stopPropagation(),this.state.selected){for(var c=0;c<this.state.itemsList.length;c++)if(this.state.itemsList[c]===this.state.selected){var d=Math.min(this.state.itemsList.length-1,Math.max(0,c+b));return void this.select(this.state.itemsById[this.state.itemsList[d]])}}else this.select(this.state.itemsById[this.state.itemsList[0]])},componentDidMount:function(){ReactDOM.findDOMNode(this).focus()},render:function(){var a=function(a){var b=this.state.itemsById[a],c=b.task||{desk:null};return React.createElement(H,{key:b._id,item:b,view:this.state.view,flags:{selected:this.state.selected===b._id},onSelect:this.select,onMultiSelect:this.multiSelect,ingestProvider:this.props.ingestProvidersById[b.ingest_provider]||null,desk:this.props.desksById[c.desk]||null})}.bind(this);return React.createElement("ul",{className:this.state.view+"-view list-view",tabIndex:"0"},this.state.itemsList.map(a))}});d.listController.ready.then(function(){function a(a,b){return a._etag===b._etag&&a._current_version===b._current_version}var c=React.createElement(J,{desksById:d.listController.desksById,highlightsById:d.listController.highlightsById,ingestProvidersById:d.listController.ingestProvidersById}),f=ReactDOM.render(c,e[0]);b.on("keydown",f.handleKey),d.$on("$destroy",function(){b.off("keydown",f.handleKey)}),d.$watch("items",function(b){if(b){var c=[],e={},g=angular.extend({},f.state.itemsById);b._items.forEach(function(b){g[b._id]&&a(g[b._id],b)||(g[b._id]=b),e[b._id]||(e[b._id]=!0,c.push(b._id))}),f.setState({itemsList:c,itemsById:g,view:d.view})}}),d.$watch("view",function(a,b){a!==b&&f.setState({view:a})}),d.$on("item:lock",function(a,b){f.updateItem(b.item,{lock_user:b.user,lock_session:b.lock_session,lock_time:b.lock_time})}),d.$on("item:unlock",function(a,b){f.updateItem(b.item,{lock_user:null,lock_session:null,lock_time:null})}),d.$on("multi:reset",function(a,b){var c=angular.extend({},f.state.itemsById),d=b.ids||[];d.forEach(function(a){c[a]=angular.extend({},c[a],{selected:!1})}),f.setState({itemsById:c})})})}}}]).directive("sdSearchWithin",["$location","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/search-within.html"),link:function(b,c){b.searchWithin=function(){if(b.within){var c=a.search();c.q?b.query=c.q+" ("+b.within+") ":b.query="("+b.within+")",a.search("q",b.query||null),b.within=null}}}}}]).directive("sdSaveSearch",["$location","asset","api","session","notify","gettext",function(a,b,c,d,e,f){return{templateUrl:b.templateUrl("superdesk-search/views/save-search.html"),link:function(b,g){function h(a){return _.forOwn(a,function(b,c){_.contains(["priority","urgency"],c)&&(a[c]=JSON.parse(b))}),a}b.edit=null,b.activateSearchPane=!1,b.$on("edit:search",function(a,c){b.activateSearchPane=!1,b.editingSearch=c,b.edit=_.create(b.editingSearch)||{}}),b.editItem=function(){b.activateSearchPane=!0,b.edit=_.create(b.editingSearch)||{}},b.saveas=function(){b.activateSearchPane=!0,b.edit=_.clone(b.editingSearch)||{},delete b.edit._id,b.edit.name="",b.edit.description=""},b.cancel=function(){b.sTab=b.editingSearch?!1:!0,b.resetEditingSearch(),b.edit=null,b.activateSearchPane=!1},b.clear=function(){b.resetEditingSearch(),b.edit=null,a.url("/search")},b.save=function(g){function i(){e.success(f("Saved search is saved successfully")),b.cancel(),b.sTab=!1,b.edit=null}function j(a){b.edit=null,angular.isDefined(a.data._message)?e.error(a.data._message):e.error(f("Error. Saved search could not be saved."))}var k=h(_.clone(a.search()));g.filter={query:k};var l={};g._id&&(l=b.editingSearch),c("saved_searches",d.identity).save(l,g).then(i,j)}}}}]).directive("sdItemContainer",["$filter","desks","api",function(a,b,c){return{scope:{item:"="},template:'<span class="location-desk-label">{{item.label}}</span> {{item.value}}',link:function(a,c){"ingest"!==a.item._type&&(a.item.task&&a.item.task.desk?b.initialize().then(function(){b.deskLookup[a.item.task.desk]&&(a.item.label="desk:",a.item.value=b.deskLookup[a.item.task.desk].name)}):"archive"===a.item._type?(a.item.label="location:",a.item.value="workspace"):"published"===a.item._type&&a.item.allow_post_publish_actions===!1&&(a.item.label="",a.item.value="archived"))}}}]).directive("sdItemPreview",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-search/views/item-preview.html"),scope:{item:"=",close:"&",openLightbox:"=",openSingleItem:"=",hideActionsMenu:"="},link:function(a){a.tab="content",a.$watch("item",function(b){a.selected={preview:b||null}}),a.$on("item:spike",a.close),a.$on("item:unspike",a.close),a.hideActions=function(){return a.hideActionsMenu}}}}]).directive("sdItemGlobalsearch",["superdesk","session","$location","search","api","notify","gettext","keyboardManager","asset","authoringWorkspace","authoring",function(a,b,c,d,e,f,g,h,i,j,k){return{scope:{repo:"=",context:"="},templateUrl:i.templateUrl("superdesk-search/views/item-globalsearch.html"),link:function(a,c){function d(){a.meta.unique_name=""}function i(b){b.length>0?(d(),a.flags.enabled=!1,k.itemActions(b[0]).edit?j.edit(b[0]):j.view(b[0])):(f.error(g("Item not found...")),a.flags.enabled=!0)}function l(c){var d=e("user_content",b.identity);d.query(c).then(function(a){i(a._items)},function(b){a.message=g("There was a problem, item can not open.")})}function m(){var b=[{not:{term:{state:"spiked"}}},{term:{unique_name:a.meta.unique_name}}],c={repo:"archive",source:{query:{filtered:{filter:{and:b}}}}};e.query("search",c).then(function(b){a.items=b._items,a.items.length>0?(i(a.items),d()):l(c)},function(b){a.message=g("There was a problem, item can not open.")})}function n(){d(),a.flags.enabled=!1}var o=13,p=27;a.meta={},a.flags={enabled:!1},h.bind("ctrl+0",function(){a.flags.enabled=!0},{global:!0}),h.bind("esc",function(){a.flags.enabled=!1},{global:!0}),a.search=function(){m()},a.openOnEnter=function(b){b.keyCode===o&&(a.search(),b.stopPropagation()),b.keyCode===p&&n()},a.close=function(){n()}}}}]).directive("sdItemSearchbar",["$location","$document","asset",function(a,b,c){return{templateUrl:c.templateUrl("superdesk-search/views/item-searchbar.html"),link:function(c,d){function e(){c.$applyAsync(function(){c.focused=!1})}var f=13;c.focused=!1;var g=d.find("#search-input");c.searchOnEnter=function(a){a.keyCode===f&&(c.search(),a.stopPropagation())},c.search=function(){var b=_.uniq(c.query.split(/[\s,]+/)),d="";_.each(b,function(a,b){a&&(d+=0!==b?" ("+a+")":"("+a+")")}),c.query=b.join(" "),a.search("q",d||null)},c.cancel=function(){c.query=null,c.search(),g.focus()};var h=a.search();h.q&&""!==h.q?c.query=h.q.replace(/[()]/g,""):c.query=null,b.bind("click",e),c.$on("$destroy",function(){b.unbind("click",e)})}}}]).directive("sdItemSearch",["$location","$timeout","asset","api","tags","search","metadata","desks","userList","searchProviderService","$filter",function(a,b,c,d,e,f,g,h,i,j,k){return{scope:{repo:"=",context:"="},templateUrl:c.templateUrl("superdesk-search/views/item-search.html"),link:function(c,l){function m(b){var d=a.search();if(c.query=d.q,c.flags=!1,c.meta={},c.fields={},c.searchProviderTypes=j.getProviderTypes(),d.repo){var e=d.repo.split(",");c.repo.archive=e.indexOf("archive")>=0,c.repo.ingest=e.indexOf("ingest")>=0,c.repo.published=e.indexOf("published")>=0,c.repo.archived=e.indexOf("archived")>=0}c.repo?c.repo.archive||c.repo.ingest||c.repo.published||c.repo.archived?c.repo.search="local":c.repo.search=d.repo:c.repo={search:"local"},a.search().unique_name&&(c.fields.unique_name=a.search().unique_name),b?(o(),n(),p()):q()}function n(){i.getAll().then(function(b){c.userList={},_.each(b,function(a){c.userList[a._id]=a}),a.search().original_creator&&(c.fields.original_creator=a.search().original_creator)})}function o(){return d.search_providers.query({max_results:200}).then(function(a){c.providers=k("sortByName")(a._items,"search_provider")})}function p(){c.desks=[],h.initialize().then(function(){c.desks=h.desks,q()})}function q(){c.desks&&c.desks._items&&(r(a.search().from_desk,"from_desk"),r(a.search().to_desk,"to_desk"))}function r(a,b){if(a){var d=a.split("-");2===d.length&&(c.fields[b]=d[0])}}function s(){var a=[];return"local"===c.repo.search?(angular.forEach(c.repo,function(b,c){b&&"local"!==b&&a.push(c)}),a.length?a.join(","):null):c.repo.search}function t(a){for(var b in a)if(a.hasOwnProperty(b))return b}function u(){var b=[];return angular.forEach(c.meta,function(a,c){if(a=a.replace(/[()]/g,""),"_all"===c)b.push(a.join(" "));else if(a)if("string"==typeof a)a&&b.push(c+":("+a+")");else{var d=t(a);a[d]&&b.push(c+"."+d+":("+a[d]+")")}}),angular.forEach(c.fields,function(b,c){"from_desk"===c?a.search("from_desk",w("from_desk")):"to_desk"===c?a.search("to_desk",w("to_desk")):a.search(c,b)}),b.length?c.query?c.query+" "+b.join(" "):b.join(" "):c.query||null}function v(){c.query=a.search().q,a.search("q",u()||null),a.search("repo",s()),c.meta={}}function w(a){var b="";if(c.fields[a]){b=c.fields[a];var d=_.result(_.find(c.desks._items,function(a){return a._id===b}),"desk_type");return b+"-"+d}return null}var x=l.find("#search-input");m(!0),c.$on("$locationChangeSuccess",function(){(c.query!==a.search().q||c.fields.from_desk!==a.search().from_desk||c.fields.to_desk!==a.search().to_desk||c.fields.unique_name!==a.search().unique_name||c.fields.original_creator!==a.search().original_creator)&&m()}),c.isSearchEnabled=function(){return c.repo.search&&("local"!==c.repo.search||c.repo.ingest||c.repo.archive||c.repo.published||c.repo.archived)},c.search=function(){v()},c.$on("key:s",function(){c.$apply(function(){c.flags={extended:!0},b(function(){x.focus()},0,!1)})}),g.fetchSubjectcodes().then(function(){return c.subjectcodes=g.values.subjectcodes,e.initSelectedFacets()}).then(function(a){c.subjectitems={subject:f.getSubjectCodes(a,c.subjectcodes)}}),c.subjectSearch=function(b){e.initSelectedFacets().then(function(d){var e=f.getSubjectCodes(d,c.subjectcodes);if(b.subject.length>e.length){var g="subject.qcode:("+b.subject[b.subject.length-1].qcode+")",h=c.query?c.query+" "+g:g;a.search("q",h)}else{var i=a.search();if(i.q)for(var j=0;j<e.length;j++)if(-1===b.subject.indexOf(e[j])){var k="subject.qcode:("+e[j].qcode+")";i.q=i.q.replace(k,"").trim(),a.search("q",i.q||null)}}})}}}}]).directive("sdItemSortbar",["search","asset","$location",function(a,b,c){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function d(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.canSort=function(){var b=a.query(c.search()).getCriteria(!0);return!(angular.isDefined(b.repo)&&"aapmm"===b.repo)},b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",d),d()}}}]).directive("sdSavedSearchSelect",["api","session",function(a,b){return{link:function(c){a.query("saved_searches",{max_results:200},b.identity).then(function(a){c.searches=a._items})}}}]).directive("sdSavedSearches",["$rootScope","api","session","modal","notify","gettext","asset","$location","desks","privileges",function(a,b,c,d,e,f,g,h,i,j){return{templateUrl:g.templateUrl("superdesk-search/views/saved-searches.html"),scope:{},link:function(g){function k(){m.query({max_results:200}).then(function(a){g.userSavedSearches.length=0,g.globalSavedSearches.length=0,g.searches=a._items,_.forEach(g.searches,function(a){a.user===c.identity._id?g.userSavedSearches.push(l(a)):a.is_global&&g.globalSavedSearches.push(l(a))}),n=_.clone(g.userSavedSearches),o=_.clone(g.globalSavedSearches)})}function l(a){return _.forOwn(a.filter.query,function(b,c){_.contains(["priority","urgency"],c)&&(a.filter.query[c]=JSON.stringify(b))}),a}var m=b("saved_searches",c.identity);g.selected=null,g.searchText=null,g.userSavedSearches=[],g.globalSavedSearches=[],g.privileges=j.privileges;var n=[],o=[];i.initialize().then(function(){g.userLookup=i.userLookup}),k(),g.select=function(a){g.selected=a,h.search(a.filter.query)},g.edit=function(b){g.select(b),a.$broadcast("edit:search",b)},g.filter=function(){g.userSavedSearches=_.clone(n),g.globalSavedSearches=_.clone(o),(g.searchText||""!==g.searchText)&&(g.userSavedSearches=_.filter(n,function(a){return a.name.toUpperCase().indexOf(g.searchText.toUpperCase())>=0}),g.globalSavedSearches=_.filter(o,function(a){return a.name.toUpperCase().indexOf(g.searchText.toUpperCase())>=0}))},g.remove=function(a){d.confirm(f("Are you sure you want to delete saved search?")).then(function(){m.remove(a).then(function(){e.success(f("Saved search removed")),k()},function(){e.error(f("Error. Saved search not deleted."));
})})}}}}]).directive("sdSearchContainer",function(){return{controller:["$scope",function(a){this.flags=a.flags||{}}]}}).directive("sdMultiActionBar",["asset","multi","authoringWorkspace",function(a,b,c){return{controller:"MultiActionBar",controllerAs:"action",templateUrl:a.templateUrl("superdesk-search/views/multi-action-bar.html"),scope:!0,link:function(a){function d(b){var c={},d=[];angular.forEach(b,function(a){c[a._type]=1,d.push(a.state)});var e=Object.keys(c);a.type=1===e.length?e[0]:null,a.state=1===e.length?d[0]:null}a.multi=b,a.$watch(b.getItems,d),a.isOpenItemType=function(a){var b=c.getItem();return b&&b.type===a}}}}]).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/search",{description:gettext("Find live and archived content"),priority:200,label:gettext("Search"),templateUrl:b.templateUrl("superdesk-search/views/search.html"),sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]).run(["keyboardManager","gettext",function(a,b){a.register("Search","ctrl + 0",b("Shows search modal")),a.register("Search","v",b("Toggles search view"))}]),c.$inject=["$rootScope","multi","multiEdit","send","packages","superdesk","notify","spike","authoring"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){var a=(d.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(l,{field:a[0]}),{dir:a[1]})}function g(a){var b=_.find(l,{field:a});j(b.field,b.defaultDir||"desc")}function h(){var a=f(),b="asc"===a.dir?"desc":"asc";j(a.field,b)}function i(a,b){var c="asc"===b?1:-1;return'[("'+encodeURIComponent(a)+'", '+c+")]"}function j(a,b){d.search("sort",a+":"+b),d.search("page",null)}var k=25;this.default_items=Object.freeze({_meta:{max_results:k,page:1,total:1}});var l=[{field:"versioncreated",label:e("Updated")},{field:"firstcreated",label:e("Created")},{field:"urgency",label:e("News Value")},{field:"anpa_category.name",label:e("Category")},{field:"slugline",label:e("Slugline")},{field:"priority",label:e("Priority")}];g("versioncreated"),this.setSort=g,this.getSort=f,this.sortOptions=l,this.toggleSortDir=h,this.getCriteria=function(){var a=d.search(),b={max_results:Number(a.max_results)||k};if(a.q&&(b.where=a.q),a.page&&(b.page=parseInt(a.page,10)),a.sort){var c=a.sort.split(":");b.sort=i(c[0],c[1])}return b},this.updateSearchQuery=function(a){function b(a){return _.trunc(a,{length:a.length-3,omission:""})+"00"}var c=[],e=!1;_.forEach(a,function(a,d){var f=_.trim(a);if(f){var g={};"published_after"===d?g.versioncreated={$gte:b(f)}:"published_before"===d?g.versioncreated={$lte:b(f)}:"_id"===d?(g._id=f,e=!0):g[d]={$regex:f,$options:"-i"},c.push(g)}});var f=null;return e&&1===c.length?f=JSON.stringify(c[0]):c.length>0&&(f=JSON.stringify({$and:c})),d.search("q",f),f},this.query=function(){var a=this.getCriteria();return b.legal_archive.query(a)}}function b(a,b,c,d){function e(){a.loading=!0,a.preview(null),c.query().then(function(b){a.loading=!1,a.items=b})}var f={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};a.criteria={},a.items=c.default_items,a.loading=!1,a.selected={},a.openAdvanceSearch=!1,a.extras={activity:{action:"list"}},a.search=function(){c.updateSearchQuery(a.criteria)},a.preview=function(b){a.selected.preview=b},a.openLightbox=function(){a.selected.view=a.selected.preview},a.closeLightbox=function(){a.selected.view=null},a.clear=function(){c.criteria=a.criteria={},a.search()},a.$watch(function(){return _.omit(b.search(),"_id")},e,!0),a.setview=function(b){a.view=b||"mgrid",f["archive:view"].view=b||"mgrid",d.update(f,"archive:view")},a.search(),d.get("archive:view").then(function(b){var c=b.view;a.view=c&&"undefined"!==c?c:"mgrid"})}a.$inject=["$q","api","notify","$location","gettext"],b.$inject=["$scope","$location","legal","preferencesService"];var c=angular.module("superdesk.legal_archive",["superdesk.activity","superdesk.api"]);return c.service("legal",a).directive("sdLegalItemSortbar",["legal","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function c(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",c),c()}}}]).config(["apiProvider",function(a){a.api("legal_archive",{type:"http",backend:{rel:"legal_archive"}}),a.api("legal_archive_versions",{type:"http",backend:{rel:"legal_archive_versions"}})}]).config(["superdeskProvider",function(a){a.activity("/legal_archive/",{label:gettext("Legal Archive"),description:gettext("Confidential data"),priority:100,category:a.MENU_MAIN,adminTools:!1,controller:b,templateUrl:"scripts/superdesk-legal-archive/views/legal_archive.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",reloadOnSearch:!1,filters:[],privileges:{legal_archive:1}})}]),c}(),function(){"use strict";var a=angular.module("superdesk.stream",["superdesk.activity","superdesk.asset"]);a.controller("StreamController",["$scope","api","$rootScope","desks",function(a,b,c,d){a.desk=null,a.activities=null,a.pageLength=10,a.max_results=a.pageLength,a.loadMore=function(){a.activities._meta.total>a.max_results&&(a.max_results+=a.pageLength,e())},a.showDateHeader=function(b){if(a.currentDate=new Date(a.activities._items[b.index]._created),0===b.index)return!0;var c=new Date(a.activities._items[b.index-1]._created);return c.getYear()!==a.currentDate.getYear()||c.getMonth()!==a.currentDate.getMonth()||c.getDate()!==a.currentDate.getDate()};var e=function(){var c={embedded:{user:1,item:1},max_results:a.max_results};a.desk&&(c.where={desk:a.desk._id}),b("activity").query(c).then(function(b){a.activities=b})};a.$watch("desk",function(){e()}),c.$on("activity",function(a,b){e()})}]).directive("sdActivityStream",["asset",function(a){return{scope:{activities:"=",max_results:"=maxResults",loadMore:"&"},templateUrl:a.templateUrl("superdesk-stream/views/activity-stream.html")}}]).directive("sdActivityMessage",[function(){return{scope:{activity:"="},template:"{{display_message}}",link:function(a,b,c){if("notify"!==a.activity.name){a.display_message=a.activity.message;for(var d in a.activity.data)if(a.activity.data.hasOwnProperty(d)){var e=new RegExp("{{\\s*"+d+"\\s*}}","gi");a.display_message=a.display_message.replace(e,a.activity.data[d])}}}}}]).config(["superdeskProvider","assetProvider","gettext",function(a,b,c){a.activity("/workspace/stream",{label:c("Workspace"),controller:"StreamController",templateUrl:b.templateUrl("superdesk-stream/views/workspace-stream.html"),topTemplateUrl:b.templateUrl("superdesk-dashboard/views/workspace-topnav.html")})}])}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(a,b){var c=[];return a&&c.push({headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{}}),{refs:c,id:b,role:"grpRole:"+b}}function i(a,b){return(angular.isUndefined(b)||!_.isObject(b))&&(b={}),c.addTaskToArticle(b),_.merge(a,b)}var j=this;this.groupList=["main","story","sidebars","fact box"],this.fetch=function(b){return a.find("archive",b).then(function(a){return a})},this.open=function(a,b){return f.open(a,b)},this.createPackageFromItems=function(b,c){var d="main",e=b[0],f={headline:e.headline||e.description||"",slugline:e.slugline||"",description:e.description||"",state:"draft",type:"composite",version:0},j=[{role:"grpRole:NEP",refs:[{idRef:d}],id:"root"},h(null,d)];return f=i(f,c),f.groups=j,f.task&&f.task.desk||(f.task={desk:g.getCurrentDeskId()}),this.addItemsToPackage(f,d,b),a.save("archive",f)},this.createEmptyPackage=function(b,c){c=c||"main";var d={headline:"",slugline:"",description:"",type:"composite",version:0,groups:[{role:"grpRole:NEP",refs:[{idRef:c}],id:"root"},h(null,c)]};return d=i(d,b),d.task&&d.task.desk||(d.task={desk:g.getCurrentDeskId()}),a.save("archive",d)},this.addItemsToPackage=function(a,b,c){var d=_.cloneDeep(a.groups),e=_.find(d,function(a){return a.id.toLowerCase()===b});if(!e){var f=_.find(d,{id:"root"});f.refs.push({idRef:b}),e={id:b,refs:[],role:"grpRole:"+b},d.push(e)}_.each(c,function(a){e.refs.push(j.getReferenceFor(a))}),_.extend(a,{groups:d})},this.isAdded=function(a,b){return a.groups.some(function(a){return a.refs.some(function(a){return a.guid===b._id})})},this.fetchItem=function(b){var c=b.location||"ingest";return a(c).getById(b.residRef).then(function(a){return a},function(a){404===a.status&&console.log("Item not found")})},this.getReferenceFor=function(a){return{headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{},itemClass:a.type?"icls:"+a.type:""}}}function b(a,b,c,d,e,f,g,h){a.origItem=b,a.action="edit",a.lock=function(){h.intent("author","package",b)},a.highlight=!!b.highlight}function c(a,b,c,d){function e(){if(h){var b={};b.q=a.query,b.ignoreKilled=!0,b.ignoreDigital=!0,b.ignoreScheduled=!0,b.onlyLastPublished=!0;var e=d.query(b);e.filter({not:{exists:{field:"embargo"}}}),e.size(25),a.highlight&&e.filter({term:{highlights:a.highlight.toString()}});var f=e.getCriteria(!0);f.repo="archive,published",c.query("search",f).then(function(b){a.contentItems=b._items})}}function f(){var b=[];a.item.groups&&_.each(a.item.groups,function(a){"root"!==a.id&&_.each(a.refs,function(a){b.push(a.residRef)})}),g=b}a.selected=null,a.multiSelected=[],a.query=null,a.highlight=null;var g=null,h=!1;a.groupList=b.groupList,e(),a.$watch("query",function(a){e()}),a.$watch("highlight",function(a){e()}),a.$watch("item",function(b){a.highlight=b.highlight,a.highlight?c("highlights").getById(a.highlight).then(function(b){a.groupList=b.groups,h=!0,e()},function(a){h=!0,e()}):(h=!0,e())}),a.$watch("item.groups",function(){f()},!0),a.addItemToGroup=function(c,d){b.addItemsToPackage(a.item,c,[d]),a.autosave(a.item)},a.preview=function(b){a.selected=b},a.itemInPackage=function(a){return _.indexOf(g,a._id)>-1},a.addToSelected=function(b){b.multi?a.multiSelected.push(b):_.remove(a.multiSelected,b)},a.addMultiItemsToGroup=function(c){b.addItemsToPackage(a.item,c,a.multiSelected),a.autosave(a.item),_.each(a.multiSelected,function(a){a.multi=!1}),a.multiSelected=[]}}function d(){return{link:function(a,b){function c(b){0===$(b.target).closest(".group-select").length&&a.$apply(function(){a.preview(a.pitem)})}b.bind("click",c),a.$on("$destroy",function(){b.unbind("click",c)})}}}function e(a){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-edit.html",link:function(b){b.limits=a.limits,b._editable=b.origItem._editable,b._isInPublishedStates=a.isPublished(b.origItem)}}}function f(a,b){return{scope:!1,require:"ngModel",templateUrl:"scripts/superdesk-packaging/views/sd-package-items-edit.html",link:function(c,d,e,f){function g(){f.$setViewValue({list:c.list}),c.autosave(c.item)}function h(a){return c.list.some(function(b){return b.items.some(function(b){return b.residRef===a._id})})}c.$on("package:addItems",function(d,e){var f=_.findIndex(c.list,{id:e.group});-1===f&&(c.list.push({id:e.group,items:[]}),f=c.list.length-1);for(var i=0;i<e.items.length;i++)h(e.items[i])?b.error(gettext("Item is already in this package.")):c.list[f].items.unshift(a.getReferenceFor(e.items[i]));g()}),f.$render=function(){c.list=f.$viewValue},f.$parsers.unshift(function(a){var b=null;return a&&a.list&&(b=[],b.push({role:"grpRole:NEP",refs:_.map(a.list,function(a){return{idRef:a.id}}),id:"root"}),_.each(a.list,function(a){b.push({id:a.id,role:"grpRole:"+a.id,refs:a.items})})),b}),f.$formatters.unshift(function(a){function b(d){var e=_.find(a,{id:d}),f=[];return _.each(e.refs,function(a){c(a)?f=_.union(f,b(a.idRef)):f.push(a)}),f}function c(a){return angular.isDefined(a.idRef)}var d=_.find(a,{id:"root"}),e=_.map(d.refs,function(a){return{id:a.idRef,items:[]}});return _.each(e,function(a){a.items=b(a.id)}),e}),c.remove=function(a,b){var d=_.find(c.list,{id:a});_.remove(d.items,{residRef:b}),g()},c.reorder=function(a,b){var d=_.find(c.list,{id:a.group}),e=_.find(c.list,{id:b.group});a.index!==b.index||a.group!==b.group?e.items.splice(b.index,0,d.items.splice(a.index,1)[0]):e.items=_.cloneDeep(e.items),g()}}}}function g(){return{link:function(a,b){var c=!1;b.sortable({items:".package-edit-items li",cursor:"move",containment:".package-edit-container",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-40;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item)),b.item.data("start_group",b.item.parent().data("group"))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index"),group:d.item.data("start_group")},f={index:d.item.parent().find("li.sort-item").index(d.item),group:d.item.parent().data("group")};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}function h(a,b,c){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item-preview.html",link:function(d){if(d.data=null,d.error=null,d.item.location){var e="",f="";_.contains(["archive","legal_archive"],d.item.location)?(e=d.item.location+"/"+d.item.residRef,e+=d.item._current_version?"?version="+d.item._current_version:"",f=d.item.location):_.contains("ingest",d.item.location)?(e=d.item.location+"/"+d.item.residRef,f="ingest"):(e=d.item.location+"/"+d.item.residRef+":"+d.item._current_version,f="archived"),a[f].getByUrl(e).then(function(a){d.data=a,d.isLocked=b.isLocked(d.data),d.isPublished="published"===d.data.state},function(a){d.error=!0})}d.$on("item:lock",function(a,c){d.data&&d.data._id===c.item&&d.$applyAsync(function(){d.data.lock_user=c.user,d.isLocked=b.isLocked(d.data)})}),d.$on("item:unlock",function(a,b){d.data&&d.data._id===b.item&&d.$applyAsync(function(){d.data.lock_user=null,d.isLocked=!1})}),d.$on("item:publish",function(a,b){d.data&&d.data._id===b.item&&d.$applyAsync(function(){d.isPublished=!0})}),d.open=function(a){c.intent("view","item",a).then(null,function(){c.intent("edit","item",a)})}}}}function i(){var a=function(b,c){var d={childId:"_items",childData:[]},e=[d];return _.each(b.refs,function(b){b.idRef?e.push({childId:b.idRef,childData:a(_.find(c,{id:b.idRef}),c)}):b.residRef&&d.childData.push(b)}),e};return{templateUrl:"scripts/superdesk-packaging/views/sd-package.html",scope:{item:"=",setitem:"&"},link:function(b,c,d){b.mode=d.mode||"tree",b.$watchGroup(["item","item.groups"],function(){b.item&&b.item.groups&&(b.tree=a(_.find(b.item.groups,{id:"root"}),b.item.groups))})}}}function j(){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item.html",scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(a,b){}}}function k(a){var b='<div sd-package-item data-id="id" data-item="item" data-setitem="setitem({selected: selected})" data-mode="mode"></div>';return{scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(c,d){d.append(a(b)(c))}}}function l(a,b){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-ref.html",scope:{item:"=",setitem:"&"}}}function m(a,b,c,d){return{templateUrl:"scripts/superdesk-packaging/views/sd-add-package-dropdown.html",link:function(e){var f=d.getItem();e.groupList=null,f.highlight&&b("highlights").getById(f.highlight).then(function(a){e.groupList=a.groups}),e.groupList=e.groupList||c.groupList,e.select=function(b){a.$broadcast("package:addItems",{items:[e.item],group:b})}}}}a.$inject=["api","$q","archiveService","lock","autosave","authoring","desks"],b.$inject=["$scope","item","packages","api","modal","notify","gettext","superdesk"],c.$inject=["$scope","packages","api","search"],e.$inject=["authoring"],f.$inject=["packages","notify"],h.$inject=["api","lock","superdesk"],k.$inject=["$compile"],l.$inject=["api","$rootScope"],m.$inject=["$rootScope","api","packages","authoringWorkspace"];var n=angular.module("superdesk.packaging",["superdesk.api","superdesk.activity","superdesk.authoring"]);return n.service("packages",a).directive("sdPackageEdit",e).directive("sdPackageItemsEdit",f).directive("sdSortPackageItems",g).directive("sdPackage",i).directive("sdPackageItem",j).directive("sdPackageItemProxy",k).directive("sdPackageRef",l).directive("sdPackageItemPreview",h).directive("sdWidgetPreventPreview",d).directive("sdAddPackageDropdown",m).config(["superdeskProvider",function(a){a.activity("create.package",{label:gettext("Create package"),controller:["data","packages","authoringWorkspace",function(a,b,c){function d(a){c.edit(a)}if(a&&a.items)b.createPackageFromItems(a.items,a.defaults).then(d);else{var e=a&&a.defaults?a.defaults:{};b.createEmptyPackage(e).then(d)}}],filters:[{action:"create",type:"package"}],condition:function(a){return a?"killed"!==a.state&&"takes"!==a.package_type:!0}}).activity("packageitem",{label:gettext("Create package"),priority:50,icon:"package-create",keyboardShortcut:"ctrl+p",controller:["data","packages","authoringWorkspace","notify","gettext",function(a,b,c,d,e){b.createPackageFromItems([a.item]).then(function(a){c.edit(a)},function(a){403===a.status&&a.data&&a.data._message&&d.error(e(a.data._message),3e3)})}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).package_item}],group:"packaging"}).activity("addtopackage",{label:gettext("Add to current"),priority:5,dropdown:!0,icon:"package-plus",templateUrl:"scripts/superdesk-packaging/views/add-to-package.html",filters:[{action:"list",type:"archive"}],additionalCondition:["authoringWorkspace","item","authoring",function(a,b,c){var d=a.getItem(),e=c.itemActions(b);return d&&"composite"===d.type&&d._id!==b._id&&e.add_to_current}],group:"packaging"}).activity("combineinpackage",{label:gettext("Combine with current"),priority:49,icon:"package-plus",keyboardShortcut:"ctrl+alt+p",controller:["data","packages","authoringWorkspace","notify","gettext",function(a,b,c,d,e){var f=c.getItem();b.createPackageFromItems([a.item,f]).then(function(a){c.edit(a)},function(a){403===a.status&&a.data&&a.data._message&&d.error(e(a.data._message),3e3)})}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoringWorkspace","item","authoring",function(a,b,c){var d=a.getItem(),e=c.itemActions(b);return d&&"composite"!==d.type&&d._id!==b._id&&e.add_to_current}],group:"packaging"})}]).config(["apiProvider",function(a){a.api("archive",{type:"http",backend:{rel:"archive"}})}]).config(["apiProvider",function(a){a.api("archived",{type:"http",backend:{rel:"archived"}})}]).config(["authoringWidgetsProvider",function(a){a.widget("search",{icon:"view",label:gettext("Search"),template:"scripts/superdesk-packaging/views/search.html",order:4,side:"left",extended:!0,display:{authoring:!1,packages:!0,legalArchive:!1,archive:!1}})}]).controller("SearchWidgetCtrl",c),n}(),function(){"use strict";function a(a,b,c,d){var e={},f={},g=c("highlightList");return e.get=function(c){var d="_nodesk",e=c||d,h=g.get(e);if(h)return b.when(h);if(f[e])return f[e];var i={};return c&&(i={where:{$or:[{desks:c},{desks:{$size:0}}]}}),f[e]=a("highlights").query(i).then(function(a){return g.put(e,a),f[e]=null,b.when(a)}),f[e]},e.clearCache=function(){g.removeAll(),f={}},e.markItem=function(b,c){return a.markForHighlights.create({highlights:b,marked_item:c})},e.createEmptyHighlight=function(a){var b={headline:a.name,highlight:a._id},c=null;return a.groups&&a.groups.length>0&&(c=a.groups[0]),a.task&&(b.task=a.task),d.createEmptyPackage(b,c)},e.find=function(b){return a.find("highlights",b)},e}function b(a,b,c){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(d){d.markItem=function(a){d.item.multiSelect=!1,b.markItem(a._id,d.item._id)},d.isMarked=function(a){return d.item&&d.item.highlights&&d.item.highlights.indexOf(a._id)>=0},b.get(a.getCurrentDeskId()).then(function(a){d.highlights=a._items,c(function(){var a=angular.element(".more-activity-menu.open .dropdown-noarrow");a.find("button").length>0&&a.find("button:not([disabled])")[0].focus()})})}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(d){d.markItem=function(a){angular.forEach(c.getItems(),function(c){c.multiSelect=!0,b.markItem(a._id,c._id)}),c.reset()},d.isMarked=function(a){var b=_.find(c.getItems(),function(b){return!b.highlights||-1===b.highlights.indexOf(a._id)});return!b},b.get(a.getCurrentDeskId()).then(function(a){d.highlights=a._items})}}}function d(){return{scope:{item:"=item"},templateUrl:"scripts/superdesk-highlights/views/highlights_info_directive.html"}}function e(a,b){return{scope:{item:"=item"},templateUrl:"scripts/superdesk-highlights/views/highlights_title_directive.html",link:function(c,d){c.toggleClass=function(a){c.open=a},c.$watch("item.highlights",function(b){b&&a.get().then(function(a){c.highlights=_.filter(a._items,function(a){return b.indexOf(a._id)>=0})})});var e,f;d.on({click:function(a){a.preventDefault(),a.stopPropagation()},mouseenter:function(a){f=$(this).find(".highlights-list"),f.not(".open").children(".dropdown-toggle").click(),angular.element(".highlights-list-menu.open").on({mouseenter:function(){b.cancel(e)},mouseleave:function(){f.filter(".open").children(".dropdown-toggle").click()}})},mouseleave:function(){e=b(function(){f.filter(".open").children(".dropdown-toggle").click()},100,!1)}}),c.unmarkHighlight=function(b){a.markItem(b,c.item._id).then(function(){c.item.highlights=_.without(c.item.highlights,b)})}}}}function f(a){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/search_highlights_dropdown_directive.html",link:function(b){b.selectHighlight=function(a){b.highlight_id=null,a&&(b.highlight_id=a._id)},b.hasHighlights=function(){return _.size(b.highlights)>0},a.get().then(function(a){b.highlights=a._items})}}}function g(a,b,c,d){return{scope:!0,templateUrl:"scripts/superdesk-highlights/views/package_highlights_dropdown_directive.html",link:function(e){e.$watch(function(){return a.active},function(a){e.selected=a,b.get(a.desk).then(function(a){e.highlights=a._items,e.hasHighlights=_.size(e.highlights)>0})}),e.listHighlight=function(a){c.url("workspace/highlights?highlight="+a._id),d.reload()}}}}function h(a,b){return{scope:{highlight_id:"=highlight",totalItems:"=total"},template:"<span translate>{{ highlightItem.name }} ({{ totalItems }} items)</span>",link:function(c){b.get(a.getCurrentDeskId()).then(function(a){c.highlightItem=_.find(a._items,{_id:c.highlight_id})})}}}function i(a,b){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/create_highlights_button_directive.html",link:function(c){c.createHighlight=function(){a.find(c.highlight_id).then(a.createEmptyHighlight).then(b.edit)}}}}function j(a,b,c){c.initialize().then(function(){a.desks=c.deskLookup}),b.query("content_templates",{template_type:"highlights"}).then(function(b){a.templates=b._items||[]}),a.hours=_.range(1,25),a.auto={day:"now/d",week:"now/w"}}function k(a,b,c,d,e,f,g){function h(b){return _.map(a.desks,function(a){return{_id:a._id,name:a.name,included:i(b,a._id)}})}function i(a,b){return _.findIndex(a,function(a){return a===b})>-1}function j(){return _.map(_.filter(a.assignedDesks,{included:!0}),function(a){return a._id})}b.get().then(function(b){a.configurations=b}),a.configEdit={},a.modalActive=!1,a.limits=45;var k;a.edit=function(b){a.message=null,a.modalActive=!0,a.configEdit=_.create(b),a.assignedDesks=h(b.desks),a.editingGroup=null,a.selectedGroup=null,k=b,a.configEdit.auto_insert||(a.configEdit.auto_insert="now/d"),a.configEdit.groups||(a.configEdit.groups=[])},a.cancel=function(){a.modalActive=!1},a.save=function(){function c(b){b.data&&b.data._issues&&b.data._issues.name&&b.data._issues.name.unique?a.message=e("Highlight configuration with the same name already exists."):a.message=e("There was a problem while saving highlights configuration")}var f=!k._id;a.configEdit.desks=j(),0===a.configEdit.groups.length?a.configEdit.groups=["main"]:a.configEdit.groups=a.configEdit.groups.slice(0),d.highlights.save(k,a.configEdit).then(function(c){a.message=null,f&&a.configurations._items.unshift(c),b.clearCache(),a.modalActive=!1},function(a){c(a)})},a.remove=function(b){g.confirm(e("Are you sure you want to delete configuration?")).then(function(){d.highlights.remove(b).then(function(){_.remove(a.configurations._items,b),f.success(e("Configuration deleted."),3e3)})})},a.getHourVal=function(a){return"now-"+a+"h"},a.isActiveGroup=function(b){return a.editingGroup&&a.editingGroup.id&&a.configEdit.groups[a.editingGroup.id-1]===b},a.editGroup=function(b){""!==b?a.editingGroup={name:b,id:a.configEdit.groups.indexOf(b)+1}:a.editingGroup={name:"",id:0}},a.removeGroup=function(b){a.configEdit.groups.splice(a.configEdit.groups.indexOf(b),1)},a.cancelGroup=function(){a.editingGroup=null,a.selectedGroup=null},a.saveGroup=function(){0===a.editingGroup.id?a.configEdit.groups.push(a.editingGroup.name):a.editingGroup.id>0&&(a.configEdit.groups[a.editingGroup.id-1]=a.editingGroup.name),a.cancelGroup()},a.handleGroupEdit=function(b){a._errorLimits=null,a.editingGroup&&a.editingGroup.name&&(a._errorLimits=a.editingGroup.name.length>a.limits?!0:null)}}a.$inject=["api","$q","$cacheFactory","packages"],b.$inject=["desks","highlightsService","$timeout"],c.$inject=["desks","highlightsService","multi"],d.$inject=[],e.$inject=["highlightsService","$timeout"],f.$inject=["highlightsService"],g.$inject=["desks","highlightsService","$location","$route"],h.$inject=["desks","highlightsService"],i.$inject=["highlightsService","authoringWorkspace"],j.$inject=["$scope","api","desks"],k.$inject=["$scope","highlightsService","desks","api","gettext","notify","modal"];var l=angular.module("superdesk.highlights",["superdesk.desks","superdesk.packaging","superdesk.activity","superdesk.api"]);return l.service("highlightsService",a).directive("sdCreateHighlightsButton",i).directive("sdMarkHighlightsDropdown",b).directive("sdMultiMarkHighlightsDropdown",c).directive("sdPackageHighlightsDropdown",g).directive("sdHighlightsInfo",d).directive("sdHighlightsTitle",e).directive("sdSearchHighlights",f).directive("sdHighlightsConfig",function(){return{controller:k}}).directive("sdHighlightsConfigModal",function(){return{require:"^sdHighlightsConfig",templateUrl:"scripts/superdesk-highlights/views/highlights_config_modal.html",link:function(a,b,c,d){}}}).directive("sdHighlightLabel",h).config(["superdeskProvider",function(a){a.activity("mark.item",{label:gettext("Mark for highlight"),priority:30,icon:"star",dropdown:!0,keyboardShortcut:"ctrl+shift+d",templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown.html",filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).mark_item}],group:"packaging"}).activity("/settings/highlights",{label:gettext("Highlights"),controller:j,templateUrl:"scripts/superdesk-highlights/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{highlights:1}}).activity("/workspace/highlights",{label:gettext("Highlights View"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/highlights-view.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]).config(["apiProvider",function(a){a.api("highlights",{type:"http",backend:{rel:"highlights"}}),a.api("markForHighlights",{type:"http",backend:{rel:"marked_for_highlights"}}),a.api("generate_highlights",{type:"http",backend:{rel:"generate_highlights"}})}]),l}(),function(){"use strict";function a(a,b){this.productionTestFilter=function(a){return a},this.getFilterConditionParameters=function(){return a.query("filter_conditions/parameters").then(angular.bind(this,function(a){return a._items}))},this.saveFilterCondition=function(b,c){return a.save("filter_conditions",b,c)},this.remove=function(b){return a.remove(b)},this.getAllFilterConditions=function(a,b){return c("filter_conditions",a,b)},this.getFilterSearchResults=function(b){return a.query("subscribers",{filter_condition:b}).then(angular.bind(this,function(a){return a._items}))},this.getAllContentFilters=function(a,b){return c("content_filters",a,b)},this.saveContentFilter=function(b,c){return a.save("content_filters",b,c)},this.testContentFilter=function(b){return a.save("content_filter_tests",{},b)},this.getGlobalContentFilters=function(){return a.query("content_filters",{is_global:!0}).then(function(a){return b("sortByName")(a._items)})};var c=function(b,d,e){return d=d||1,e=e||[],a(b).query({max_results:200,page:d}).then(function(a){return e=e.concat(a._items),a._links.next?(d++,c(d,e)):e})}}function b(){var a=this;a.TEMPLATES_DIR="scripts/superdesk-content-filters/views",a.activeTab="filters",a.changeTab=function(b){a.activeTab=b}}function c(a,b,c,d,e){a.filterConditions=null,a.filterCondition=null,a.origFilterCondition=null,a.filterConditionParameters=null,a.operatorLookup={},a.valueLookup={},a.valueFieldLookup={},a.loadedFilters=!1,a.edit=function(b){if(a.origFilterCondition=b||{},a.filterCondition=_.create(a.origFilterCondition),a.filterCondition.values=[],a.isListValue()){var c=a.filterCondition.value.split(","),d=a.valueLookup[a.filterCondition.field],e=a.valueFieldLookup[a.filterCondition.field];_.each(c,function(b){var c=_.find(d,function(a){return a[e].toString()===b});a.filterCondition.values.push(c)})}},a.isListValue=function(){return _.contains(["in","nin"],a.filterCondition.operator)&&a.valueLookup[a.filterCondition.field]},a.cancel=function(){a.origFilterCondition=null,a.filterCondition=null},a.save=function(){a.filterCondition.value=f(),delete a.filterCondition.values,b.saveFilterCondition(a.origFilterCondition,a.filterCondition).then(function(){c.success(gettext("Filter condition saved.")),a.cancel()},function(a){angular.isDefined(a.data._issues)?a.data._issues.name&&a.data._issues.name.unique?c.error(gettext("Error: "+gettext("Name needs to be unique"))):c.error(gettext("Error: "+JSON.stringify(a.data._issues))):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to save filter condition."))}).then(g)},a.remove=function(e){d.confirm(gettext("Are you sure you want to delete filter condition?")).then(function(){return b.remove(e)}).then(function(b){_.remove(a.filterConditions,e)},function(a){angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("There is an error. Filter condition cannot be deleted."))})};var f=function(){if(a.isListValue()){var b=[];return _.each(a.filterCondition.values,function(c){b.push(c[a.valueFieldLookup[a.filterCondition.field]])}),b.join()}return a.filterCondition.value},g=function(){b.getAllFilterConditions().then(function(b){a.filterConditions=e("sortByName")(b)}),b.getFilterConditionParameters().then(function(b){a.filterConditionParameters=b,_.each(b,function(b){a.operatorLookup[b.field]=b.operators,a.valueLookup[b.field]=b.values,a.valueFieldLookup[b.field]=b.value_field}),a.loadedFilters=!0})};a.clearConditionValues=function(){a.filterCondition.value&&(a.filterCondition.value=null),a.filterCondition.values&&a.filterCondition.values.length>0&&(a.filterCondition.values.length=0)},g()}function d(a,b,c,d,e){a.filterConditions=null,a.contentFilters=null,a.contentFilter=null,a.origContentFilter=null,a.preview=null,a.filterConditionLookup={},a.contentFiltersLookup={},a.editFilter=function(b){a.origContentFilter=b||{},a.contentFilter=_.create(a.origContentFilter),a.contentFilter.name=a.origContentFilter.name,a.contentFilter.content_filter=_.cloneDeep(a.origContentFilter.content_filter),g(),a.previewContentFilter()},a.close=function(){a.previewContentFilter(),a.origContentFilter=null,a.contentFilter=null,a.test.test_result=null,a.test.article_id=null},a.saveFilter=function(){delete a.contentFilter.article_id,
b.saveContentFilter(a.origContentFilter,a.contentFilter).then(function(){c.success(gettext("Content filter saved.")),a.close()},function(a){angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues["validator exception"])?c.error(gettext("Error: "+a.data._issues["validator exception"])):angular.isDefined(a.data._issues)?a.data._issues.name&&a.data._issues.name.unique?c.error(gettext("Error: "+gettext("Name needs to be unique"))):c.error(gettext("Error: "+JSON.stringify(a.data._issues))):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):500===a.status?c.error(gettext("Error: Internal error in Filter testing")):c.error(gettext("Error: Failed to test content filter."))}).then(i)},a.remove=function(e){d.confirm(gettext("Are you sure you want to delete content filter?")).then(function(){return b.remove(e)}).then(function(b){_.remove(a.contentFilters,e)},function(a){angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("There is an error. Content filter cannot be deleted."))})},a.addStatement=function(){a.contentFilter.content_filter.push({expression:{}})},a.removeStatement=function(b){a.contentFilter.content_filter.splice(b,1),a.previewContentFilter()},a.addFilter=function(b,c){c in b.expression||(b.expression[c]=[]),b.selected&&!_.includes(b.expression[c],b.selected)&&(b.expression[c].push(b.selected),delete b.selected,a.previewContentFilter())},a.removeFilter=function(b,c,d){b.expression[d]=_.without(b.expression[d],c),a.previewContentFilter()},a.productionTest=function(b){a.$broadcast("triggerTest",b)},a.test=function(){return a.test.article_id?void b.testContentFilter({filter:a.contentFilter,article_id:a.test.article_id}).then(function(b){a.test.test_result=b.match_results?"Does Match":"Doesn't Match"},function(a){angular.isDefined(a.data._issues)?c.error(gettext("Error: "+a.data._issues)):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to save content filter."))}):void c.error(gettext("Please provide an article id"))},a.previewContentFilter=function(){a.preview=f(a.contentFilter.content_filter)};var f=function(b){var c=[];return _.each(b,function(b){var d=[];"pf"in b.expression&&_.each(b.expression.pf,function(b){var c=a.contentFiltersLookup[b];d.push(f(c.content_filter))}),"fc"in b.expression&&_.each(b.expression.fc,function(b){var c=a.filterConditionLookup[b];d.push("("+c.field+" "+c.operator+' "'+c.value+'")')}),d.length>0&&c.push("["+d.join(" AND ")+"]")}),c.length>0?c.join(" OR "):""},g=function(){a.contentFilter.content_filter&&0!==a.contentFilter.content_filter.length||(a.contentFilter.content_filter=[{expression:{}}])},h=function(){b.getAllFilterConditions().then(function(b){a.filterConditions=e("sortByName")(b),_.each(b,function(b){a.filterConditionLookup[b._id]=b})})},i=function(){b.getAllContentFilters().then(function(b){a.contentFilters=e("sortByName")(b),_.each(a.contentFilters,function(b){a.contentFiltersLookup[b._id]=b})})};h(),i()}function e(){return{templateUrl:"scripts/superdesk-content-filters/views/manage-filters.html",controller:d}}function f(a,b,c,d,e){function f(){a.selectedItem=_.find(a.testResult,{_id:d.search()._id})||null,a.selectedItem?a.selected.preview=a.selectedItem:a.selected.preview=null}function g(b,c){var d,e,f=_.findIndex(a.testResult,a.selectedItem);-1===f?d=a.testResult[0]:(e=Math.max(0,Math.min(a.testResult.length-1,f+b)),d=a.testResult[e]),i(a.testResult[e],c)}function h(b){a.selectedItem=b,d.search("_id",b?b._id:b)}function i(a,b){h(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}a.preview=null,a.selected={},a.selectedItem={},a.selectedfilter=null,a.testResult=null;var j=-1,k=1,l={38:j,40:k};a.resultType=[{id:"Matching",value:"true"},{id:"Non-Matching",value:"false"}],a.model={selectedType:"true"},a.close=function(){a.filter_test=null,a.testResult=null},a.preview=function(a){d.search("_id",a?a._id:a)},a.openView=function(b){a.openLightbox(b)},a.openLightbox=function(b){a.selected.view=b},a.closeLightbox=function(){a.selected.view=null},a.hideActions=function(){return!0},a.$on("$routeUpdate",f),a.handleKeyEvent=function(a){var b=a.keyCode||a.which;l[b]&&(a.preventDefault(),a.stopPropagation(),g(l[b],a))},a.fetchResults=function(){m()},a.$on("triggerTest",function(b,c){a.productionTest=!0,a.testResult=null,a.selectedfilter=c._id,m()});var m=function(){b.testContentFilter({filter_id:a.selectedfilter,return_matching:a.$eval(a.model.selectedType)}).then(function(b){a.testResult=b.match_results},function(a){angular.isDefined(a.data._issues)?c.error(gettext("Error: "+a.data._issues)):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to fetch production test results."))})}}function g(a,b,c,d){function e(){b.getAllContentFilters().then(function(b){a.contentFilters=b,_.each(a.contentFilters,function(b){a.contentFiltersLookup[b._id]=b})})}function f(){return b.getFilterConditionParameters().then(function(b){a.filterConditionParameters=d("sortByName")(b,"field"),_.each(b,function(b){a.operatorLookup[b.field]=b.operators,a.valueLookup[b.field]=b.values,a.valueFieldLookup[b.field]=b.value_field}),a.origFilterCondition={},a.filterCondition=_.create(a.origFilterCondition),a.filterCondition.values=[],g()})}function g(){var b=null!=a.filterCondition.value?a.filterCondition.value.split(","):[],c=a.valueLookup[a.filterCondition.field],d=a.valueFieldLookup[a.filterCondition.field];_.each(b,function(b){var e=_.find(c,function(a){return a[d].toString()===b});a.filterCondition.values.push(e)})}function h(){if(a.isListValue()){var b=[];return _.each(a.filterCondition.values,function(c){b.push(c[a.valueFieldLookup[a.filterCondition.field]])}),b.join()}return a.filterCondition.value}a.filterCondition=null,a.operatorLookup={},a.valueLookup={},a.valueFieldLookup={},a.searchResult=null,a.contentFiltersLookup={},a.isListValue=function(){return null!=a.filterCondition?_.contains(["in","nin"],a.filterCondition.operator)&&a.valueLookup[a.filterCondition.field]:void 0},a.hideList=!0,a.handleKey=function(b){return a.filterCondition.values.length>0?(c.error(gettext("single value is required")),b.preventDefault(),b.stopPropagation(),!1):void 0},a.resetValues=function(){a.searchResult=null,a.filterCondition.values.length=0,a.filterCondition.value=null},a.getFilter=function(b){return _.find(a.contentFilters,{_id:b})},a.search=function(){if(!a.loading){a.searchResult=null,a.filterCondition.value=h();var d={field:a.filterCondition.field,operator:a.filterCondition.operator,value:a.filterCondition.value};a.loading=!0,b.getFilterSearchResults(d).then(function(b){0===b[0].filter_conditions.length&&0===b[0].content_filters.length&&0===b[0].selected_subscribers.length?c.error(gettext("no results found")):a.searchResult=b[0],a.filterCondition.value=null})["finally"](function(){a.loading=!1})}},f().then(function(){e()})}a.$inject=["api","$filter"],b.$inject=[],c.$inject=["$scope","contentFilters","notify","modal","$filter"],d.$inject=["$scope","contentFilters","notify","modal","$filter"],f.$inject=["$scope","contentFilters","notify","$location","$window"],g.$inject=["$scope","contentFilters","notify","$filter"];var h=angular.module("superdesk.content_filters",["superdesk.publish"]);h.config(["superdeskProvider",function(a){var c="scripts/superdesk-content-filters/views/settings.html";a.activity("/settings/content-filters",{label:gettext("Content Filters"),controller:b,controllerAs:"ctrl",templateUrl:c,category:a.MENU_SETTINGS,priority:-800,privileges:{dictionaries:1}})}]).service("contentFilters",a).controller("ContentFiltersConfigCtrl",b).controller("FilterConditionsCtrl",c).controller("ManageContentFiltersCtrl",d).controller("ProductionTestCtrl",f).controller("FilterSearchCtrl",g).directive("sdManageFiltersTab",e)}(),function(){"use strict";function a(a,b,c,d,e){function f(a){a.user&&(a.name=a.user+":"+a.language_id)}function g(b,d){function f(b){return a.find("dictionaries",b._id)}return c.getIdentity().then(function(c){var g=[{language_id:b}];return d&&g.push({language_id:d}),a.query("dictionaries",{projection:{content:0},where:{$and:[{$or:g},{is_active:{$in:["true",null]}},{$or:[{user:c._id},{user:{$exists:!1}}]}]}}).then(function(a){return e.all(a._items.map(f))})})}function h(b){return c.getIdentity().then(function(c){return a.query("dictionaries",{where:{language_id:b,user:c._id}}).then(function(a){return a._items.length?a._items[0]:{name:c._id+":"+b,content:{},language_id:b,user:c._id}})})}function i(b,c){return h(c).then(function(c){var d=c.content||{};return d[b]=d[b]?d[b]+1:1,c.content=d,a.save("dictionaries",c)})}this.dictionaries=null,this.currDictionary=null,this.getActive=g,this.getUserDictionary=h,this.addWordToUserDictionary=i,this.fetch=function(b,d){return c.getIdentity().then(function(c){return a.query("dictionaries",{projection:{content:0},where:{$or:[{user:{$exists:!1}},{user:c._id}]}}).then(b,d)})},this.open=function(b,c,d){return a.find("dictionaries",b._id).then(c,d)},this.upload=function(a,c,e,g,h,i){var j=_.has(a,"_id")&&null!==a._id,k=j?"PATCH":"POST",l=j?{"If-Match":a._etag}:{},m={};angular.forEach(c,function(a,b){"content"!==b&&(m[b]=null===a?a:a.toString())}),f(m),c.hasOwnProperty("content")&&(m.content_list=angular.toJson(c.content)),b.resource("dictionaries").then(function(b){return j&&(b+="/"+a._id),d.upload({url:b,method:k,data:m,file:e,headers:l}).then(g,h,i)},h)},this.update=function(b,c,d,e){var g={};return angular.forEach(c,function(a,b){g[b]="is_active"===b?a.toString():a}),f(g),a.save("dictionaries",b,g).then(d,e)},this.remove=function(b,c,d){return a.remove(b).then(c,d)}}function b(a,b,c,d,e,f){a.dictionaries=null,a.origDictionary=null,a.dictionary=null,a.fetchDictionaries=function(){b.fetch(function(b){a.dictionaries=b})},a.createDictionary=function(){a.dictionary={is_active:"true"},a.origDictionary={}},a.createPersonalDictionary=function(){return d.getIdentity().then(function(b){a.dictionary={is_active:"true",user:b._id,name:b._id},a.origDictionary={}})},a.openDictionary=function(c){b.open(c,function(b){a.origDictionary=b,a.dictionary=_.create(b),a.dictionary.content=_.create(b.content||{}),a.dictionary.is_active="false"!==a.dictionary.is_active})},a.closeDictionary=function(){a.dictionary=a.origDictionary=null},a.remove=function(d){e.confirm(c("Please confirm you want to delete dictionary.")).then(function(){b.remove(d,function(){_.remove(a.dictionaries._items,d),f.success(c("Dictionary deleted."),3e3)})})},a.fetchDictionaries()}function c(a,b,c,d,e,f){function g(b){return a.closeDictionary(),a.fetchDictionaries(),e.success(d("Dictionary saved succesfully")),a.progress=null,b}function h(b){angular.isDefined(b.data._issues)?angular.isDefined(b.data._issues["validator exception"])?e.error(d("Error: "+b.data._issues["validator exception"])):angular.isDefined(b.data._issues.name)&&(e.error(d("Error: The dictionary already exists.")),a._errorUniqueness=!0):e.error(d("Error. Dictionary not saved.")),a.progress=null}function i(a,b){return b.length>=a.length&&b.substr(0,a.length)===a}function j(a){k.hasOwnProperty(a[0])?k[a[0]].push(a):k[a[0]]=[a]}a.$on("fileSelected",function(b,c){a.$apply(function(){a.file=c.file})}),a.save=function(){a._errorUniqueness=!1,a.progress={width:1},a.file?b.upload(a.origDictionary,a.dictionary,a.file,g,h,function(b){a.progress.width=Math.round(b.loaded/b.total*100)}):b.update(a.origDictionary,a.dictionary,g,h)},a.cancel=function(){a._errorUniqueness=!1,a.closeDictionary()},a.addWord=function(b){a.dictionary.content.hasOwnProperty(b)||j(b),a.dictionary.content[b]=1,a.filterWords(b),a.wordsCount++},a.removeWord=function(b,c){a.dictionary.content[b]=0,a.filterWords(c),a.wordsCount--},a.filterWords=function(b){if(a.words=[],a.isNew=!!b,b&&k[b[0]]){for(var c,d=k[b[0]],e=d.length,f=[],g=0;e>g;g++)c=d[g],a.dictionary.content[c]>0&&i(b,c)&&(f.push(c),c.length===b.length&&(a.isNew=!1));var h=10;f.sort(),f.splice(h,f.length-h),a.words=f}};var k={};a.wordsCount=0;for(var l in a.dictionary.content)(a.dictionary.content.hasOwnProperty(l)||a.origDictionary.content.hasOwnProperty(l))&&(j(l),a.wordsCount++)}a.$inject=["api","urls","session","$upload","$q"],b.$inject=["$scope","dictionaries","gettext","session","modal","notify"],c.$inject=["$scope","dictionaries","upload","gettext","notify","modal"];var d=angular.module("superdesk.dictionaries",["superdesk.activity","superdesk.upload"]);d.config(["superdeskProvider",function(a){a.activity("/settings/dictionaries",{label:gettext("Dictionaries"),controller:b,templateUrl:"scripts/superdesk-dictionaries/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{dictionaries:1}})}]).service("dictionaries",a).controller("DictionaryEdit",c).directive("sdDictionaryConfig",function(){return{controller:b}}).directive("sdDictionaryConfigModal",function(){return{controller:"DictionaryEdit",require:"^sdDictionaryConfig",templateUrl:"scripts/superdesk-dictionaries/views/dictionary-config-modal.html"}}).directive("fileUpload",function(){return{scope:!0,link:function(a,b,c){b.bind("change",function(b){a.$emit("fileSelected",{file:b.target.files[0]})})}}})}(),function(){"use strict";function a(a,b,c){var d=this;this.getVocabularies=function(){return"undefined"==typeof d.vocabularies?a.query("vocabularies",{where:{type:"manageable"}}).then(function(a){return a._items=c("sortByName")(a._items,"display_name"),d.vocabularies=a,d.vocabularies}):b.when(d.vocabularies)}}function b(a,b){a.openVocabulary=function(b){a.vocabulary=b},b.getVocabularies().then(function(b){a.vocabularies=b})}function c(a,b,c,d,e,f){function g(){a.vocabulary=null}function h(a){return c.success(b("Vocabulary saved succesfully")),g(),a}function i(a){angular.isDefined(a.data._issues)&&(angular.isDefined(a.data._issues["validator exception"])?c.error(b("Error: "+a.data._issues["validator exception"])):c.error(b("Error. Vocabulary not saved.")))}var j=_.cloneDeep(a.vocabulary.items);a.save=function(){a._errorUniqueness=!1,d.save("vocabularies",a.vocabulary).then(h,i),f.loaded=null,f.initialize()},a.cancel=function(){a.vocabulary.items=j,g()},a.addItem=function(){var b={};_.extend(b,a.model),b.is_active=!0,a.vocabulary.items.push(b)};var k=_.mapValues(_.indexBy(_.uniq(_.flatten(_.map(a.vocabulary.items,function(a){return _.keys(a)})))),function(){return null});a.model=k}a.$inject=["api","$q","$filter"],b.$inject=["$scope","vocabularies"],c.$inject=["$scope","gettext","notify","api","vocabularies","metadata"];var d=angular.module("superdesk.vocabularies",["superdesk.activity"]);d.config(["superdeskProvider",function(a){a.activity("/settings/vocabularies",{label:gettext("Vocabularies"),templateUrl:"scripts/superdesk-vocabularies/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{vocabularies:1}})}]).service("vocabularies",a).controller("VocabularyEdit",c).controller("VocabularyConfig",b).directive("sdVocabularyConfig",function(){return{scope:{vocabulary:"="},controller:"VocabularyConfig",templateUrl:"scripts/superdesk-vocabularies/views/vocabulary-config.html"}}).directive("sdVocabularyConfigModal",function(){return{scope:{vocabulary:"="},controller:"VocabularyEdit",templateUrl:"scripts/superdesk-vocabularies/views/vocabulary-config-modal.html"}})}(),function(){"use strict";return angular.module("superdesk.archive.directives",["superdesk.filters","superdesk.authoring","superdesk.ingest","superdesk.workflow"]).directive("sdItemLock",["api","lock","privileges","desks",function(a,b,c,d){return{templateUrl:"scripts/superdesk-archive/views/item-lock.html",scope:{item:"="},link:function(e){function f(){e.privileges=c.privileges,e.lock={user:null,lockbyme:!1}}f(),e.$watch("item.lock_session",function(){f(),e.item&&b.isLocked(e.item)&&a("users").getById(e.item.lock_user).then(function(a){e.lock.user=a,e.lock.lockbyme=b.isLockedByMe(e.item)})}),e.unlock=function(){b.previewUnlock=!0,b.unlock(e.item).then(function(){e.item.lock_user=null,e.item.lock_session=null,e.lock=null,e.isLocked=!1})},e.can_unlock=function(){return b.can_unlock(e.item)?e.item.task&&e.item.task.desk&&d.userDesks?_.find(d.userDesks._items,{_id:e.item.task.desk}):!0:!1},e.$on("item:lock",function(a,b){e.item&&e.item._id===b.item&&(e.item.lock_user=b.user,e.item.lock_time=b.lock_time,e.item.lock_session=b.lock_session,e.$digest())}),e.$on("item:unlock",function(a,b){e.item&&e.item._id===b.item&&(e.item.lock_user=null,e.item.lock_session=null,e.$digest())})}}}]).directive("sdInlineMeta",function(){return{templateUrl:"scripts/superdesk-archive/views/inline-meta.html",scope:{placeholder:"@",showmeta:"=",item:"=",setmeta:"&"}}}).directive("sdMediaPreview",["api","$rootScope","desks",function(a,b,c){return{templateUrl:"scripts/superdesk-archive/views/preview.html",link:function(d){d.previewRewriteStory=function(){return a.find("archive",d.item.rewrite_id).then(function(a){b.$broadcast("broadcast:preview",{item:a})})},c.initialize().then(function(){d.userLookup=c.userLookup})}}}]).directive("sdMediaPreviewWidget",[function(){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/item-preview.html"}}]).directive("sdItemPreviewContainer",function(){return{template:'<div ng-if="item" sd-media-view data-item="item" data-close="close()"></div>',scope:{},link:function(a){a.item=null,a.$on("intent:preview:item",function(b,c){a.item=c.data}),a.close=function(){a.item=null}}}}).directive("sdMediaView",["keyboardManager","packages",function(a,b){return{templateUrl:"scripts/superdesk-archive/views/media-view.html",scope:{items:"=",item:"=",close:"&"},link:function(c,d){var e=[];c.singleItem=null,c.packageItem=null,c.prevEnabled=!0,c.nextEnabled=!0;var f=function(a){return _.findIndex(c.items,{_id:a._id})},g=function(a){i(),c.item=a,c.openItem(a);var b=f(c.item);c.prevEnabled=b>-1&&!!c.items[b-1],c.nextEnabled=b>-1&&!!c.items[b+1]};c.prev=function(){var a=f(c.item);a>0&&g(c.items[a-1])},c.next=function(){var a=f(c.item);-1!==a&&a<c.items.length-1&&g(c.items[a+1])},a.push("left",c.prev),a.push("right",c.next),c.$on("$destroy",function(){a.pop("left"),a.pop("right")}),c.setPackageSingle=function(a){b.fetchItem(a).then(function(a){c.openItem(a)})},c.openItem=function(a){"composite"===a.type&&(e.push(a),h()),c.setSingleItem(a)},c.setSingleItem=function(a){c.singleItem=a},c.nested=function(){return e.length>1},c.previousPackage=function(){_.remove(e,_.last(e)),h(),c.setSingleItem(c.packageItem)};var h=function(){c.packageItem=_.last(e)||null},i=function(){e=[],c.packageItem=null};g(c.item)}}}]).directive("sdMediaMetadata",["userList","archiveService",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/metadata-view.html",link:function(c,d){function e(){c.originalCreator=c.item.original_creator,c.versionCreator=c.item.version_creator,b.isLegal(c.item)||(c.item.original_creator&&a.getUser(c.item.original_creator).then(function(a){c.originalCreator=a.display_name}),c.item.version_creator&&a.getUser(c.item.version_creator).then(function(a){c.versionCreator=a.display_name}))}c.$watch("item",e)}}}]).directive("sdMediaRelated",["familyService","superdesk",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/related-view.html",link:function(c,d){function e(){a.fetchItems(c.item.family_id||c.item._id,c.item).then(function(a){c.relatedItems=a})}c.$on("item:duplicate",e),c.$watch("item",function(a,b){a!==b&&e()}),c.open=function(a){b.intent("view","item",a).then(null,function(){b.intent("edit","item",a)})},e()}}}]).directive("sdFetchedDesks",["desks","familyService","$location","superdesk",function(a,b,c,d){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/fetched-desks.html",link:function(e,f){e.$watchGroup(["item","item.archived"],function(){e.item&&b.fetchDesks(e.item,!1).then(function(a){e.desks=a})}),e.selectFetched=function(b){b.isUserDeskMember&&(a.setCurrentDeskId(b.desk._id),c.url("/workspace/monitoring"),1===b.count&&d.intent("edit","item",b.item))}}}}]).directive("sdMetaIngest",["ingestSources",function(a){return{scope:{item:"="},template:"{{ name }}",link:function(b){function c(){!b.item.ingest_provider&&"source"in b.item&&(b.name=b.item.source),a.initialize().then(function(){b.item.ingest_provider&&b.item.ingest_provider in a.providersLookup&&(b.name=a.providersLookup[b.item.ingest_provider].name)})}b.$watch("item",c),b.name=""}}}]).directive("sdSingleItem",[function(){return{templateUrl:"scripts/superdesk-archive/views/single-item-preview.html",scope:{item:"=",contents:"=",setitem:"&"}}}]).directive("sdMediaBoxGrid",function(){return{templateUrl:"scripts/superdesk-archive/views/media-box-grid.html"}}).directive("sdMediaBoxList",function(){return{templateUrl:"scripts/superdesk-archive/views/media-box-list.html"}}).directive("sdMediaBox",["$location","lock","multi","archiveService",function(a,b,c,d){return{restrict:"A",link:function(e,f,g){e.lock={isLocked:e.item&&(b.isLocked(e.item)||b.isLockedByMe(e.item))},e.$on("item:lock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!0,e.item.lock_user=b.user,e.item.lock_session=b.lock_session,e.item.lock_time=b.lock_time,e.$digest())}),e.$on("item:unlock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!1,e.item.lock_user=null,e.item.lock_session=null,e.item.lock_time=null,e.$digest())}),e.$on("task:progress",function(a,b){b.task===e.item.task_id&&(0===b.progress.total?e._progress=10:e._progress=Math.min(100,Math.round(100*b.progress.current/b.progress.total)),e.$digest())}),e.$on("item:highlight",function(a,b){e.item&&e.item._id===b.item_id&&(e.item.highlights?-1===e.item.highlights.indexOf(b.highlight_id)?e.item.highlights=[b.highlight_id].concat(e.item.highlights):e.item.multiSelect||(e.item.highlights=_.without(e.item.highlights,b.highlight_id)):e.item.highlights=[b.highlight_id])}),e.clickAction=function(b){return"function"==typeof e.preview?(a.search("fetch",null),e.preview(b)):!1},e.toggleSelected=function(a){c.toggle(a)},e.getType=function(a){return d.getType(a)}}}}]).directive("sdItemCrops",["metadata",function(a){return{templateUrl:"scripts/superdesk-archive/views/item-crops.html",scope:{item:"="},link:function(b,c){a.initialize().then(function(){b.crop_sizes=a.values.crop_sizes})}}}]).directive("sdItemRendition",function(){return{templateUrl:"scripts/superdesk-archive/views/item-rendition.html",scope:{item:"=",rendition:"@",ratio:"=?"},link:function(a,b){function c(){var c=b.find("figure");if(c&&a.ratio){var d=c.find("img")[0],e=d?d.naturalWidth/d.naturalHeight:1;a.ratio>e?c.parent().addClass("portrait"):c.parent().removeClass("portrait")}}a.$watch("item.renditions[rendition].href",function(a){var d=b.find("figure"),e=d.find("img").css("opacity",.5);if(a){var f=new Image;f.onload=function(){e.length?e.replaceWith(f):d.html(f),c()},f.onerror=function(){d.html("")},f.src=a}});var d=a.$watch("ratio",function(a){void 0===a&&d(),_.debounce(c,150)})}}}).directive("sdRatioCalc",["$window",function(a){return{link:function(b,c){function d(){b.ratio=c.outerWidth()/c.outerHeight()}function e(){d(),b.$apply()}var f=angular.element(a);d(),f.bind("resize",e),b.$on("$destroy",function(){f.unbind("resize",e)})}}}]).directive("sdHtmlPreview",["$sce",function(a){return{scope:{sdHtmlPreview:"="},template:'<div ng-bind-html="html"></div>',link:function(b,c,d){b.$watch("sdHtmlPreview",function(c){b.html=a.trustAsHtml(c)})}}}]).directive("sdProviderMenu",["$location",function(a){return{scope:{items:"="},templateUrl:"scripts/superdesk-archive/views/provider-menu.html",link:function(b,c,d){b.setProvider=function(c){b.selected=c,a.search("provider",b.selected)},b.$watchCollection(function(){return a.search()},function(a){a.provider&&(b.selected=a.provider)})}}}]).directive("sdGridLayout",function(){return{templateUrl:"scripts/superdesk-items-common/views/grid-layout.html",scope:{items:"="},link:function(a,b,c){a.view="mgrid",a.preview=function(b){a.previewItem=b}}}}).directive("sdContentResults",["$location","preferencesService","packages","tags","asset","search",function(a,b,c,d,e,f){var g={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};return{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-results.html"),link:function(d,e,h,i){function j(a){d.view=a||"mgrid",g["archive:view"].view=a||"mgrid",b.update(g,"archive:view")}function k(){var a=d.view===m?l:m;return j(a)}var l="mgrid",m="compact",n=void 0===h.multiSelectable?!1:!0;d.flags=i.flags,d.selected=d.selected||{},d.preview=function(b){n&&(-1===_.findIndex(d.selectedList,{_id:b._id})?d.selectedList.push(b):_.remove(d.selectedList,{_id:b._id})),d.selected.preview=b,a.search("_id",b?b._id:null)},d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.openSingleItem=function(a){c.fetchItem(a).then(function(a){d.selected.view=a})},d.setview=j;var o;b.get("archive:view").then(function(a){o=a.view,d.view=o&&"undefined"!==o?o:"mgrid"}),d.$on("key:v",k),d.generateTrackByIdentifier=function(a){return f.generateTrackByIdentifier(a)}}}}]).directive("sdArchivedItemKill",["authoring","api","notify","gettext",function(a,b,c,d){return{templateUrl:"scripts/superdesk-archive/views/archived-kill.html",scope:{item:"="},link:function(e,f,g){e._editable=!0;var h={_id:e.item._id,_etag:e.item._etag};b.remove(h,{},"archived").then(function(f){var g=_.union(_.keys(a.getContentFieldDefaults()),["_id","versioncreated"]),h={template_name:"kill",item:_.pick(e.item,g)};b.save("content_templates_apply",{},h,{}).then(function(b){h=_.pick(b,_.keys(a.getContentFieldDefaults())),e.item=_.create(e.item),_.each(h,function(a,b){_.isUndefined(a)||_.isEmpty(a)||(e.item[b]=a)})},function(a){c.error(d("Failed to apply kill template to the item."))})},function(a){a.data._message?c.error(a.data._message):c.error(d("Unknown Error: Cannot kill the item"))}),e.kill=function(){b.save("archived",e.item,_.pick(e.item,["headline","abstract","body_html"])).then(function(a){c.success(d("Item has been killed.")),e.cancel()})},e.cancel=function(){delete e.item._initiateKill,e.item=null}}}}]).service("familyService",["api","desks",function(a,b){this.fetchItems=function(b,c){var d="archive,published",e=[{not:{term:{state:"spiked"}}},{term:{family_id:b}}];return c&&e.push({not:{term:{unique_id:c.unique_id}}}),a("search").query({repo:d,source:{query:{filtered:{filter:{and:e}}},sort:[{versioncreated:"desc"}],size:100,from:0}})},this.fetchDesks=function(a,c){return this.fetchItems("ingested"===a.state?a._id:a.family_id,c?a:void 0).then(function(a){var c=[],d=[];return _.each(a._items,function(a){if(a.task&&a.task.desk&&b.deskLookup[a.task.desk])if(d.indexOf(a.task.desk)<0){var e=!_.isEmpty(_.find(b.userDesks._items,{_id:a.task.desk}));c.push({desk:b.deskLookup[a.task.desk],count:1,itemId:a._id,isUserDeskMember:e,item:a}),d.push(a.task.desk)}else c[d.indexOf(a.task.desk)].count+=1}),c})}}])}(),function(){"use strict";function a(a,b,c){function d(a){return a&&a.indexOf("-")>0?a.split("-")[0]:null}function e(){if(!g)return a.reject();var b=d(g);return h||(h=c.getActive(g,b).then(function(a){return h.content={},b&&_.find(a,{language_id:g})&&_.find(a,{language_id:b})&&(a=_.filter(a,{language_id:g})),angular.forEach(a,f),h.content})),h}function f(a,b){angular.extend(h.content,a.content||{})}var g,h,i,j;j=this,this.setLanguage=function(a){g!==a&&(g=a,h=null)},this.errors=function(a){return e().then(function(b){for(var c,d=[],e=/[0-9a-zA-Z\u00C0-\u1FFF\u2C00-\uD7FF]+/g,f=0,g=document.createTreeWalker(a,NodeFilter.SHOW_TEXT);g.nextNode();){for(;null!=(c=e.exec(g.currentNode.textContent));){var j=c[0];isNaN(j)&&!h.content[j.toLowerCase()]&&d.push({word:j,index:f+c.index})}f+=g.currentNode.length}return i=d.length,d})},this.suggest=function(a){return b.save("spellcheck",{word:a,language_id:g}).then(function(a){return a.corrections||[]})},this.addWordToUserDictionary=function(a){a=a.toLowerCase(),c.addWordToUserDictionary(a,g),h.content[a]=h.content[a]?h.content[a]+1:1}}function b(a,b){function c(){a.setSettings({spellcheck:!0}),a.render(),a.setSettings({spellcheck:!1})}function d(){a.setSettings({spellcheck:e.isAuto}),a.render()}this.isAuto=a.settings.spellcheck,this.spellcheck=c,this.pushSettings=d;var e=this}a.$inject=["$q","api","dictionaries"],b.$inject=["editor","$rootScope"],angular.module("superdesk.editor.spellcheck",["superdesk.dictionaries","superdesk.editor"]).service("spellcheck",a).controller("SpellcheckMenu",b)}(),function(){"use strict";function a(a){a.activity("/workspace/monitoring",{label:gettext("Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function b(a){a.activity("/workspace/spike-monitoring",{label:gettext("Spike Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/spike-monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function c(a){a.activity("/workspace/personal",{label:gettext("Personal"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/personal.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function d(a,b,c,d){function e(a,e,f){var g={};"search"===a.type&&a.search&&a.search.filter.query?(angular.copy(a.search.filter.query,g),a.query&&(a.search.filter.query.q?g.q="("+a.query+") "+a.search.filter.query.q:g.q="("+a.query+") ")):g.q=a.query,g.spike="spike"===a.type||"spike-personal"===a.type;var h=b.query(g);switch(a.type){case"search":break;case"spike-personal":case"personal":h.filter({bool:{must:{term:{original_creator:c.identity._id}},must_not:{exists:{field:"task.desk"}}}});break;case"spike":h.filter({term:{"task.desk":a._id}});break;case"highlights":h.filter({and:[{term:{highlights:f.highlight}}]});break;case"deskOutput":var i=a._id.substring(0,a._id.indexOf(":")),j=d.deskLookup?d.deskLookup[i]:null;j&&("authoring"===j.desk_type?h.filter({or:[{term:{"task.last_authoring_desk":i}},{and:[{term:{"task.desk":i}},{terms:{state:["scheduled","published","corrected","killed"]}}]}]}):"production"===j.desk_type&&h.filter({and:[{term:{"task.desk":i}},{terms:{state:["scheduled","published","corrected","killed"]}}]}));break;default:null!=a.singleViewType&&"desk"===a.singleViewType?h.filter({term:{"task.desk":a.deskId}}):h.filter({term:{"task.stage":a._id}})}a.fileType&&h.filter({terms:{type:JSON.parse(a.fileType)}}),e&&h.filter({query:{query_string:{query:e,lenient:!1}}});var k={source:h.getCriteria()};return"search"===a.type&&a.search&&a.search.filter.query.repo?k.repo=a.search.filter.query.repo:"deskOutput"===a.type&&(k.repo="archive,published"),k.source.from=0,k.source.size=a.max_items||25,k}function f(a,b){switch(a.type){case"stage":return!!b.stages[a._id];case"personal":return b.user===c.identity._id;default:return!0}}this.criteria=e,this.shouldUpdate=f}function e(a,b){function c(a){h.previewItem=a,h.state["with-preview"]=!!a}function d(){c(null)}function e(a){h.editItem=a,h.state["with-authoring"]=!!a}function f(a,b){a.singleViewType=b,h.singleGroup=a}function g(){h.singleGroup.singleViewType=null,h.singleGroup=null}this.state={},this.preview=c,this.closePreview=d,this.previewItem=null,this.selectedGroup=null,this.bindedItems=[],this.singleGroup=null,this.viewSingleGroup=f,this.viewMonitoringHome=g,this.queryParam=a.search(),this.edit=e,this.editItem=null,this.totalItems="",this.isDeskChanged=function(){return b.changeDesk},this.highlightsDeskChanged=function(){b.changeDesk&&a.url("/workspace/monitoring")};var h=this}function f(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-view.html",
controller:"Monitoring",controllerAs:"monitoring",scope:{type:"=",state:"="}}}function g(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group-header.html"}}function h(a,b,c,d,e,f,g,h,i,j,k,l){var m=57,n=5,o=8,p=-1,q=1,r=13,s={38:p,40:q};return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group.html",require:["^sdMonitoringView"],scope:{group:"=",numItems:"=",viewType:"="},link:function(p,q,t,u){function v(a){N.bindedItems&&x();var b={action:"list"};e.findActivities(b,a).forEach(function(b){b.keyboardShortcut&&g.isActionAllowed(a,b.action)&&(N.bindedItems.push(b.keyboardShortcut),h.bind(b.keyboardShortcut,function(){"mark.item"===b._id?w():f.start(b,{data:{item:p.selected}})},{inputDisabled:!0}))})}function w(){q.find(".active .more-activity-toggle").click();var a=angular.element(".more-activity-menu.open .dropdown-noarrow");a.addClass("open"),a.find("button").length>0&&(a.find("button:not([disabled])")[0].focus(),h.push("up",function(){a.find("button:focus").parent("li").prev().children("button").focus()}),h.push("down",function(){a.find("button:focus").parent("li").next().children("button").focus()}))}function x(){N.bindedItems.forEach(function(a){h.unbind(a)}),N.bindedItems=[]}function y(){d.cancel(O),O=d(C,50,!1)}function z(a,b){if("spiked"!==a.state)if("ingest"===a._type){var d={action:"list",type:"ingest"},g=e.findActivities(d,a)[0];f.start(g,{data:{item:a}}).then(function(a){c.edit(a,!b),N.preview(null)})}else"composite"===a.type&&"takes"===a.package_type?(c.view(a),N.preview(null)):l.isPublished(a)?(c.view(a),N.preview(null)):(c.edit(a,!b),N.preview(null))}function A(a){p.selected=a,N.selectedGroup=p.group,N.preview(a),v(a)}function B(a){A(a)}function C(){return S=a.criteria(p.group,null,N.queryParam),S.source.size=0,p.total=null,i.changeDesk&&(i.changeDesk=!1,N.singleGroup=null,k.reset()),E().then(function(a){N.totalItems=a._meta.total,p.total=a._meta.total,p.$applyAsync(D)})}function D(){var a=R[0].scrollTop,b=Math.floor(a/m),c=Math.max(0,b-o),d=p.numItems||n,e=Math.min(p.total,b+d+o);parseInt(P.style.height,10)!==Math.min(d,p.total)*m&&(P.style.height=Math.min(d,p.total)*m+"px"),S.source.from=c,S.source.size=e-c;var f=k.getIds();return E().then(function(a){p.$on("multi:reset",function(b,c){f=null,_.merge(a._items,c)}),p.$applyAsync(function(){p.total!==a._meta.total&&(p.total=a._meta.total,P.style.height=p.total*m+"px"),Q.style.paddingTop=c*m+"px",p.items=I(a._items),null!=f&&_.filter(a._items,function(a){_.find(f,function(b){return b===a._id&&(a.selected=!0),b===a._id})})})})}function E(){var a="search";return"search"===p.group.type||"deskOutput"===p.group.type?S.repo&&-1===S.repo.indexOf(",")&&(a=S.repo,angular.isDefined(S.source.size)||(S.source.size=25)):a="archive",b.query(a,S)}function F(){p.total+=p.newItemsCount,p.newItemsCount=0,D()}function G(){return p.loading=!0,D().then(function(a){return p.loading=!1,a})}function H(a,b){N.viewSingleGroup(a,b)}function I(a){var b=[],c=p.items||[];return angular.forEach(a,function(a){var d="ingested"===a.state?{_id:a._id}:{_id:a._id,_current_version:a._current_version},e=_.find(c,d);b.push(e?angular.extend(e,a):a)}),b}function J(a){d.cancel(T),T=d(G,100,!1)}function K(a){var b=a.keyCode||a.which;s[b]?(a.preventDefault(),a.stopPropagation(),d.cancel(T),M(s[b],a),J()):b===r&&p.$applyAsync(function(){z(p.selected)})}function L(a,b){p.select(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}function M(a,b){var c,e,f=_.findIndex(p.items,p.selected),g=p.numItems||n;-1===f?c=p.items[0]:(e=Math.max(0,Math.min(p.items.length-1,f+a)),c=p.items[e],d.cancel(U),U=d(function(){var a=R[0].scrollTop,b=Math.ceil(a/m),c=Math.floor((a+R[0].clientHeight)/m),d=e+S.source.from;b>d?R[0].scrollTop=Math.max(0,d*m):d>=c&&(R[0].scrollTop=(d-g+1)*m)},50,!1)),p.$apply(function(){L(p.items[e],b)})}var N=u[0];p.view="compact",p.page=1,p.fetching=!1,p.previewingBroadcast=!1,p.loading=!1,p.cacheNextItems=[],p.cachePreviousItems=[],p.limited=N.singleGroup||"highlights"===p.group.type?!1:!0,p.generateTrackByIdentifier=function(a){return j.generateTrackByIdentifier(a)},p.edit=z,p.select=A,p.preview=B,p.renderNew=F,p.viewSingleGroup=H,p.$watchCollection("group",C),p.$on("task:stage",C),p.$on("ingest:update",C),p.$on("item:spike",C),p.$on("item:duplicate",C),p.$on("item:copy",C),p.$on("broadcast:created",function(a,b){p.previewingBroadcast=!0,C(),B(b.item)}),p.$on("item:unspike",C),p.$on("$routeUpdate",C),p.$on("broadcast:preview",function(a,b){p.previewingBroadcast=!0,null!=b.item?B(b.item):N.closePreview()}),p.$on("item:highlight",C),p.$on("content:update",function(b,c){a.shouldUpdate(p.group,c)&&y()}),p.$on("content:expired",C),p.$on("$destroy",x),p.$watch("selected",function(a,b){!a&&p.previewingBroadcast&&(p.previewingBroadcast=!1)}),h.bind("ctrl+g",function(){p.selected&&(null==N.singleGroup?N.viewSingleGroup(N.selectedGroup,"stage"):N.viewMonitoringHome())},{inputDisabled:!1}),h.bind("ctrl+alt+g",function(){p.selected&&(null==N.singleGroup?N.viewSingleGroup(N.selectedGroup,"desk"):N.viewMonitoringHome())},{inputDisabled:!1});var O,P=q[0].getElementsByClassName("stage-content")[0],Q=q[0].getElementsByClassName("inline-content-items")[0],R=q.find(".stage-content").first();R.on("keydown",K),R.on("scroll",J),p.$on("$destroy",function(){R.off()});var S,T,U}}}function i(a,b,c,d){return{scope:{stage:"=stage"},templateUrl:"scripts/superdesk-monitoring/views/desk-notifications.html",link:function(e){function f(){e.desk=a.stageLookup[e.stage].desk,e.notifications=b.getNotifications(e.desk),e.default_incoming=a.stageLookup[e.stage].default_incoming,e.notificationCount=b.getUnreadCount(e.desk)||0,e.deskLookup=a.deskLookup,e.stageLookup=a.stageLookup,e.default_incoming&&e.$on("desk:mention",function(){d(g,5e3,!0)})}function g(){b.reload(),f()}function h(a){return _.find(a.recipients,{desk_id:e.desk})}e.open=function(a){c.view(a.item)},e.acknowledge=function(a){b.markAsRead(a,e.desk),d(f,5e3)},e.isRead=function(a){var b=h(a);return b&&b.read},e.readBy=function(b){var c=h(b);return c&&c.read?a.userLookup[c.user_id].display_name:void 0},f()}}}function j(a,b,c,d,e){return{scope:{item:"=",active:"="},templateUrl:"scripts/superdesk-monitoring/views/item-actions-menu.html",link:function(f){function g(b){var d={action:"list",type:h(b)},e={};return a.findActivities(d,b).forEach(function(a){if(c.isActionAllowed(f.item,a.action)){var b=a.group||"default";e[b]=e[b]||[],e[b].push(a)}}),e}function h(a){return d.getType(a)}f.toggleActions=function(a){f.actions=a?g(f.item):f.actions,f.open=a,a||(angular.element(".media-text.selected").parents("li").focus(),angular.element(".dropdown-noarrow.open").removeClass("open"))},f.$on("item:lock",function(a,b){f.open&&f.item&&f.item._id===b.item&&(f.open=!1)}),f.stopEvent=function(a){a.stopPropagation()},f.run=function(a){return e.$broadcast("broadcast:preview",{item:null}),b.start(a,{data:{item:f.item}})}}}}angular.module("superdesk.monitoring",["superdesk.api","superdesk.aggregate","superdesk.search","superdesk.ui"]).service("cards",d).controller("Monitoring",e).directive("sdMonitoringView",f).directive("sdMonitoringGroup",h).directive("sdMonitoringGroupHeader",g).directive("sdDeskNotifications",i).directive("sdItemActionsMenu",j).config(a).config(b).config(c).run(["keyboardManager","gettext",function(a,b){a.register("Monitoring","ctrl + g",b("Switches between single/grouped stage view")),a.register("Monitoring","ctrl + alt + g",b("Switches between single/grouped desk view"))}]),a.$inject=["superdeskProvider"],b.$inject=["superdeskProvider"],c.$inject=["superdeskProvider"],d.$inject=["api","search","session","desks"],e.$inject=["$location","desks"],h.$inject=["cards","api","authoringWorkspace","$timeout","superdesk","activityService","workflowService","keyboardManager","desks","search","multi","archiveService"],i.$inject=["desks","deskNotifications","authoringWorkspace","$timeout"],j.$inject=["superdesk","activityService","workflowService","archiveService","$rootScope"]}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){if(p.groups.length>0&&(p.groups.length=0),a&&a.groups.length>0)_.each(a.groups,function(a){("stage"!==a.type||p.stageLookup[a._id])&&("search"!==a.type||p.searchLookup[a._id])&&p.groups.push(a)});else if(a&&0===a.groups.length&&"desk"===a.type){_.each(p.stageLookup,function(a){a.desk===c.getCurrentDeskId()&&p.groups.push({_id:a._id,type:"stage",header:a.name})});var b=c.getCurrentDesk();b&&p.groups.push({_id:b._id+":output",type:"deskOutput",header:b.name})}j(),l(),p.search(p.searchQuery)}function j(){var a={};p.spikeGroups.length>0&&(p.spikeGroups.length=0),0!==p.groups.length&&(_.each(p.groups,function(b,c){if("stage"===b.type){var d=p.stageLookup[b._id];a[d.desk]=p.deskLookup[d.desk]}else"personal"===b.type&&(a.personal={_id:"personal",name:"personal"})}),_.each(a,function(a){"personal"===a._id?p.spikeGroups.push({_id:a._id,type:"spike-personal",header:a.name}):p.spikeGroups.push({_id:a._id,type:"spike",header:a.name})}))}function k(){return p.loading?null:p.readSettings().then(function(a){i(a),m()})}function l(){var a=0===p.selectedFileType.length?null:JSON.stringify(p.selectedFileType);_.each(p.groups,function(b){b.fileType=a}),_.each(p.spikeGroups,function(b){b.fileType=a})}function m(){function a(a){if("stage"===a.type){var b=p.stageLookup[a._id],c=p.deskLookup[b.desk];a.deskId=b.desk,a.header=c.name,a.subheader=b.name}else if("deskOutput"===a.type){var d=a._id.substring(0,a._id.indexOf(":"));a.header=p.deskLookup[d].name}else"search"===a.type?(a.search=p.searchLookup[a._id],a.header=a.search.name):"personal"===a.type&&(a.header=g("Personal"))}var b=p.groups;angular.forEach(b,a),p.cards=b}var n="agg:view",o=10,p=this;this.loading=!0,this.selected=null,this.groups=[],this.spikeGroups=[],this.modalActive=!1,this.searchLookup={},this.deskLookup={},this.stageLookup={},this.fileTypes=["all","text","picture","composite","video","audio"],this.selectedFileType=[],this.monitoringSearch=!1,this.searchQuery=null,c.initialize().then(angular.bind(this,function(){return c.fetchCurrentUserDesks().then(angular.bind(this,function(a){this.desks=a._items,this.deskLookup=c.deskLookup,this.deskStages=c.deskStages,_.each(this.desks,function(a){_.each(p.deskStages[a._id],function(a){p.stageLookup[a._id]=a})})}))})).then(angular.bind(this,function(){return b.query("all_saved_searches",{max_results:200}).then(angular.bind(this,function(a){this.searches=a._items,_.each(this.searches,function(a){p.searchLookup[a._id]=a})}))})).then(angular.bind(this,function(){return this.readSettings().then(angular.bind(this,function(a){i(a),m(),this.loading=!1}))})),this.setWidget=function(a){this.widget=a},this.readSettings=function(){return p.widget?d.readActive().then(function(a){var b=[];return p.widget.configuration=p.widget.configuration||{groups:[],label:""},_.each(a.widgets,function(a){a.configuration&&p.widget._id===a._id&&p.widget.multiple_id===a.multiple_id&&(b=a.configuration.groups||b,p.widget.configuration.label=a.configuration.label||"")}),{type:"desk",groups:b}}):d.getActiveId().then(function(a){if("workspace"===a.type)return e.get(n).then(function(b){return b&&b[a.id]&&b[a.id].groups?{type:"workspace",groups:b[a.id].groups}:{type:"workspace",groups:[]}});if("desk"===a.type){var b=p.deskLookup[a.id];if(b&&b.monitoring_settings)return{type:"desk",groups:b.monitoring_settings}}return{type:"desk",groups:[]}})},this.refreshGroups=k,a.$watch(function(){return d.active},k),this.hasFileType=function(a){return"all"===a?0===this.selectedFileType.length:this.selectedFileType.indexOf(a)>-1},this.getSelectedFileTypes=function(){return 0===this.selectedFileType.length?null:JSON.stringify(this.selectedFileType)},this.setFileType=function(a){if(h.reset(),"all"===a)this.selectedFileType=[];else{var b=this.selectedFileType.indexOf(a);b>-1?this.selectedFileType.splice(b,1):this.selectedFileType.push(a)}l()},this.preview=function(a){this.selected=a},this.edit=function(){this.editGroups={},_.each(this.groups,function(a,b){if(p.editGroups[a._id]={_id:a._id,selected:!0,type:a.type,max_items:a.max_items||o,order:b},"stage"===a.type){var c=p.stageLookup[a._id];p.editGroups[c.desk]={_id:c._id,selected:!0,type:"desk",order:0}}else if("deskOutput"===a.type){var d=a._id.substring(0,a._id.indexOf(":"));p.editGroups[d]={_id:a._id,selected:!0,type:"desk",order:0}}}),this.modalActive=!0},this.search=function(a){this.searchQuery=a,_.each(this.groups,function(b){b.query=a}),_.each(this.spikeGroups,function(b){b.query=a})},this.state=f.getItem("agg:state")||{},this.state.expanded=this.state.expanded||{},this.switchExpandedState=function(a){this.state.expanded[a]=!this.getExpandedState(a),f.setItem("agg:state",this.state)},this.getExpandedState=function(a){return void 0===this.state.expanded[a]?!0:this.state.expanded[a]},this.setSoloGroup=function(a){this.state.solo=a,f.setItem("agg:state",this.state)},this.getMaxHeightStyle=function(a){var b=32*(a||o)+6;return{"max-height":b.toString()+"px"}}}function b(a,b,c,d,e,f){return{templateUrl:"scripts/superdesk-monitoring/views/aggregate-settings-configuration.html",scope:{modalActive:"=",desks:"=",deskStages:"=",searches:"=",deskLookup:"=",stageLookup:"=",searchLookup:"=",groups:"=",editGroups:"=",onclose:"&",widget:"="},link:function(g,h){var i="agg:view",j=10;g.showGlobalSavedSearches=!1,g.showPrivateSavedSearches=!0,g.privateSavedSearches=[],g.globalSavedSearches=[],g.step={current:"desks"},a.initialize().then(function(){g.userLookup=a.userLookup}),g.$watch("step.current",function(a){"searches"===a&&(b.getActiveId().then(function(a){"workspace"===a.type?g.showPrivateSavedSearches=!0:(g.showGlobalSavedSearches=!0,g.showPrivateSavedSearches=!1)}),g.initGlobalSavedSearches(),g.initPrivateSavedSearches())}),g.closeModal=function(){g.step.current="desks",g.modalActive=!1,g.showGlobalSavedSearches=!1,g.onclose()},g.previous=function(){e.wizard("aggregatesettings").previous()},g.next=function(){e.wizard("aggregatesettings").next()},g.cancel=function(){g.closeModal()},g.setDeskInfo=function(a){var b=g.editGroups[a];b._id=a,b.type="desk",b.order=0;var c=g.editGroups[a+":output"];c&&(c.selected=b.selected)},g.setStageInfo=function(a){var b=g.editGroups[a];b.type||(b._id=a,b.type="stage",b.max_items=j,b.order=_.size(g.editGroups))},g.setDeskOutputInfo=function(a){var b=g.editGroups[a];b._id=a,b.type="deskOutput",b.max_items=j,b.order=_.size(g.editGroups),g.editGroups[a]=b},g.setSearchInfo=function(a){var b=g.editGroups[a];b.type||(b._id=a,b.type="search",b.max_items=j,b.order=_.size(g.editGroups))},g.setPersonalInfo=function(){var a=g.editGroups.personal;a.type||(a._id="personal",a.type="personal",a.max_items=j,a.order=_.size(g.editGroups))},g.initPrivateSavedSearches=function(){var a=c.identity._id;g.privateSavedSearches.length>0&&(g.privateSavedSearches.length=0),_.each(f("sortByName")(g.searches),function(b){b.user!==a||b.is_global||g.privateSavedSearches.push(b)})},g.initGlobalSavedSearches=function(){g.globalSavedSearches.length>0&&(g.globalSavedSearches.length=0),_.each(f("sortByName")(g.searches),function(a){if(a.is_global){g.globalSavedSearches.push(a);var b=g.editGroups[a._id];b&&b.selected&&(g.showGlobalSavedSearches=!0)}})},g.getValues=function(){var b=Object.keys(g.editGroups).map(function(a){return g.editGroups[a]});return b=_.filter(b,function(a){if("desk"===a.type||!a.selected)return!1;if("stage"===a.type){var b=g.stageLookup[a._id];return g.editGroups[b.desk].selected}return"personal"===a.type?g.editGroups.personal.selected:!0}),b=_.sortBy(b,function(a){return a.order}),_.each(b,function(b){if("deskOutput"===b.type){var c=b._id.substring(0,b._id.indexOf(":"));b.name=a.deskLookup[c].name}}),b},g.reorder=function(a,b){var c=g.getValues();b.index!==a.index&&(c.splice(b.index,0,c.splice(a.index,1)[0]),_.each(c,function(a,b){a.order=b}))},g.save=function(){var c=[];_.each(g.getValues(),function(a,b){a.selected&&"desk"!==a.type&&c.push({_id:a._id,type:a.type,max_items:a.max_items})}),g.widget?b.getActive().then(function(a){var d=angular.copy(a.widgets);_.each(d,function(a){g.widget._id===a._id&&g.widget.multiple_id===a.multiple_id&&(a.configuration={},a.configuration.groups=c,g.widget.configuration.label&&(a.configuration.label=g.widget.configuration.label))}),b.save(a,{widgets:d}).then(function(){g.showGlobalSavedSearches=!1,g.onclose()})}):(b.getActiveId().then(function(b){"workspace"===b.type?d.get(i).then(function(a){var f={};a&&(f[i]=a),f[i][b.id]={groups:c},d.update(f,i).then(function(){e.wizard("aggregatesettings").finish()})}):"desk"===b.type&&a.save(g.deskLookup[b.id],{monitoring_settings:c}).then(function(){e.wizard("aggregatesettings").finish()})}),g.showGlobalSavedSearches=!1,g.onclose())}}}}function c(){return{link:function(a,b){var c=!1;b.sortable({items:".sort-item",cursor:"move",containment:".groups",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-20;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index")},f={index:d.item.parent().find("li.sort-item").index(d.item)};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}a.$inject=["$scope","api","desks","workspaces","preferencesService","storage","gettext","multi"],b.$inject=["desks","workspaces","session","preferencesService","WizardHandler","$filter"],angular.module("superdesk.aggregate",["superdesk.authoring.widgets","superdesk.desks","superdesk.workspace"]).controller("AggregateCtrl",a).directive("sdAggregateSettings",b).directive("sdSortGroups",c)}(),function(){"use strict";angular.module("superdesk.aggregate.widgets",["superdesk.aggregate","superdesk.dashboard.widgets"]).config(["dashboardWidgetsProvider",function(a){a.addWidget("aggregate",{label:"Monitoring",multiple:!0,icon:"archive",max_sizex:2,max_sizey:2,sizex:1,sizey:2,thumbnail:"scripts/superdesk-monitoring/aggregate-widget/thumbnail.svg",template:"scripts/superdesk-monitoring/aggregate-widget/aggregate-widget.html",configurationTemplate:"scripts/superdesk-monitoring/aggregate-widget/configuration.html",description:"This widget allows you to create literally any content view you may need in Superdesk, be it production or ingest. All you need is to select a desk, its stages or a saved search. Name your view once you are done. Enjoy!",custom:!0})}])}(),function(){"use strict";function a(a,b,c,d,e){function f(b,d){return d?a.save(t,b,d).then(j):(b.user=b.user||c.identity._id,a.save(t,b).then(j))}function g(b){return a.remove(b).then(function(){return u.active&&u.active._id===b._id?u.queryUserWorkspaces():e.when()}).then(function(a){a&&a.length?u.setActive(a[0]):u.setActive(null),u.getActive()})}function h(a){var b={};return b[s]={workspace:a._id},d.update(b,s),p(a._id).then(j)}function i(a){j(a);var b={};b[s]={workspace:a?a._id:""},d.update(b,s)}function j(a){return u.active=a||null,a}function k(){return d.get(s).then(function(a){return a&&a.workspace?a.workspace:null})}function l(){return b.initialize().then(k).then(function(a){var c=null,d=null;return b.activeDeskId&&b.deskLookup[b.activeDeskId]?(c="desk",d=b.activeDeskId):a&&b.deskLookup[a]?(c="desk",d=a,b.setCurrentDeskId(a)):a?(c="workspace",d=a):b.getCurrentDeskId()&&(c="desk",d=b.getCurrentDeskId()),u.workspaceType=c,{id:d,type:c}})}function m(){return l().then(function(a){return"desk"===a.type?p(a.id):"workspace"===a.type?o(a.id):void 0})}function n(){return l().then(function(a){return"desk"===a.type?p(a.id):"workspace"===a.type?o(a.id):q()}).then(j)}function o(b){return a.find(t,b)}function p(b){return a.query("workspaces",{where:{desk:b}}).then(function(a){return 1===a._items.length?a._items[0]:{desk:b,widgets:[]}})}function q(){return{user:c.identity._id,widgets:c.identity.workspace?c.identity.workspace.widgets:[]}}function r(){return c.getIdentity().then(function(b){return a.query(t,{where:{user:b._id}})}).then(function(a){return a._items})}this.active=null,this.save=f,this["delete"]=g,this.setActive=i,this.setActiveDesk=h,this.getActive=n,this.getActiveId=l,this.readActive=m,this.queryUserWorkspaces=r;var s="workspace:active",t="workspaces",u=this}function b(a,b,c,d,e,f,g){return{templateUrl:"scripts/superdesk-workspace/views/workspace-dropdown.html",link:function(c){function d(){a.changeDesk=!0,e.search("_id",null)}function g(){var d=null;b.getActiveId().then(function(a){d=a}).then(angular.bind(a,a.fetchCurrentUserDesks)).then(function(a){c.desks=a._items}).then(b.queryUserWorkspaces).then(function(a){c.wsList=a,c.workspaceType=d.type,"desk"===d.type?c.selected=_.find(c.desks,{_id:d.id}):"workspace"===d.type?c.selected=_.find(c.wsList,{_id:d.id}):c.selected=null})}c.workspaces=b,c.wsList=null,c.edited=null,c.afterSave=function(d){a.setCurrentDeskId(null),b.setActive(d),c.selected=d},c.selectDesk=function(e){d(),c.selected=e,c.workspaceType="desk",a.setCurrentDeskId(e._id),b.setActiveDesk(e),f.activeDesk=a.active.desk},c.selectWorkspace=function(e){d(),c.selected=e,c.workspaceType="workspace",a.setCurrentDeskId(null),b.setActive(e)},c.createWorkspace=function(){c.edited={}},c.$watch(function(){return b.active},g,!0)}}}function c(a,b,c,d){return{templateUrl:"scripts/superdesk-workspace/views/workspace-sidenav-items.html",link:function(d,e){d.hideMonitoring=function(b,c){a.flags.authoring&&b?(c.preventDefault(),a.flags.hideMonitoring=!a.flags.hideMonitoring):a.flags.hideMonitoring=!1},c.bind("alt+h",function(a){a.preventDefault(),b.url("/workspace")},{global:!0,inputDisabled:!1}),c.bind("alt+m",function(a){a.preventDefault(),b.url("/workspace/monitoring")},{global:!0,inputDisabled:!1}),c.bind("alt+d",function(a){a.preventDefault(),e.find(".highlights-dropdown .dropdown-toggle").click(),e.find(".dropdown-menu button")[0].focus(),c.push("up",function(){e.find(".dropdown-menu button:focus").parent("li").prev().children("button").focus()}),c.push("down",function(){e.find(".dropdown-menu button:focus").parent("li").next().children("button").focus()})},{global:!0,inputDisabled:!1}),c.bind("alt+t",function(a){a.preventDefault(),b.url("/workspace/tasks")},{global:!0,inputDisabled:!1}),c.bind("alt+x",function(a){a.preventDefault(),b.url("/workspace/spike-monitoring")},{global:!0,inputDisabled:!1}),c.bind("alt+p",function(a){a.preventDefault(),b.url("/workspace/personal")},{global:!0,inputDisabled:!1}),c.bind("alt+f",function(a){a.preventDefault(),b.url("search")},{global:!0,inputDisabled:!1})}}}function d(a){return{templateUrl:"scripts/superdesk-workspace/views/edit-workspace-modal.html",scope:{workspace:"=",done:"="},link:function(b){b.workspaces=a,b.save=function(){a.save(b.workspace).then(function(){b.errors=null;var a=b.workspace;return b.workspace=null,b.done?b.done(a):void 0},function(a){b.errors=a.data._issues})},b.cancel=function(){b.workspace=null}}}}angular.module("superdesk.workspace",["superdesk.workspace.content"]).service("workspaces",a).directive("sdDeskDropdown",b).directive("sdWorkspaceSidenav",c).directive("sdEditWorkspace",d).run(["keyboardManager","gettext",function(a,b){a.register("General","alt + h",b("Opens workspace")),a.register("General","alt + m",b("Opens monitoring")),a.register("General","alt + d",b("Opens highlights")),a.register("General","alt + t",b("Opens tasks")),a.register("General","alt + x",b("Opens spike")),a.register("General","alt + p",b("Opens personal")),a.register("General","alt + f",b("Opens search"))}]),a.$inject=["api","desks","session","preferencesService","$q"],b.$inject=["desks","workspaces","$route","preferencesService","$location","reloadService","notifyConnectionService"],c.$inject=["superdeskFlags","$location","keyboardManager","gettext"],d.$inject=["workspaces"]}(),function(){"use strict";return angular.module("superdesk.settings",[]).config(["superdeskProvider",function(a){a.activity("/settings",{label:gettext("Settings"),description:gettext("Do some admin chores"),controller:angular.noop,templateUrl:"scripts/superdesk-settings/views/main.html",category:a.MENU_MAIN,priority:1e3,adminTools:!0,_settings:1})}]).directive("sdSettingsView",["$route","superdesk",function(a,b){return{scope:{},transclude:!0,templateUrl:"scripts/superdesk-settings/views/settings-view.html",link:function(c,d,e){b.getMenu(b.MENU_SETTINGS).then(function(a){c.settings=a}),c.currentRoute=a.current}}}]).directive("sdDateParam",["$location",function(a){return{scope:!0,link:function(b,c,d){var e=a.search();e[d.location]&&(b.date=e[d.location]),b.$watch("date",function(b){a.search(d.location,b)})}}}]).directive("sdValidError",function(){return{link:function(a,b){b.addClass("validation-error")}}}).directive("sdRoleUnique",["api","$q",function(a,b){return{require:"ngModel",link:function(c,d,e,f){function g(d,e){var f=d||e;if(f){var g={where:{name:f}};return null!=c.editRole&&null!=c.editRole._id&&(g.where._id={$ne:c.editRole._id}),a.roles.query(g).then(function(a){return a._items.length?b.reject(a):a})}return b.when()}f.$asyncValidators.unique=g}}}])}(),BaseListController.$inject=["$scope","$location","superdesk","api","search","desks","preferencesService","notify"],function(){"use strict";angular.module("superdesk.widgets.base",["superdesk.itemList"]).factory("BaseWidgetController",function(){return function(a){a.options=a.options||{},a.itemListOptions=a.itemListOptions||{},a.actions=a.actions||{},a.$watch("widget.configuration",function(b){b&&(a.itemListOptions.savedSearch=b.savedSearch,a.itemListOptions.pageSize=b.maxItems)},!0),a.item&&(a.options.item=a.item)}})}(),function(){"use strict";angular.module("superdesk.widgets.ingeststats",[]).factory("colorSchemes",["$resource",function(a){return a("scripts/superdesk-ingest/static-resources/color-schemes.json")}]).config(["dashboardWidgetsProvider",function(a){a.addWidget("ingest-stats",{label:"Ingest Stats",multiple:!0,icon:"signal",max_sizex:1,max_sizey:1,sizex:1,sizey:1,thumbnail:"scripts/superdesk-ingest/ingest-stats-widget/thumbnail.svg",template:"scripts/superdesk-ingest/ingest-stats-widget/widget-ingeststats.html",configurationTemplate:"scripts/superdesk-ingest/ingest-stats-widget/configuration.html",configuration:{source:"provider",colorScheme:"superdesk",updateInterval:5},description:"Displaying news ingest statistics. You have ability to switch color themes or graph sources."})}]).controller("IngestStatsController",["$scope","$timeout","api",function(a,b,c){function d(){c.ingest.query().then(function(c){a.items=c,b(function(){d()},1e3*a.widget.configuration.updateInterval*60)})}d()}]).controller("IngestStatsConfigController",["$scope","colorSchemes",function(a,b){b.get(function(b){a.schemes=b.schemes})}])}(),function(){"use strict";function a(a,b){_.each(x,function(c,d){_.has(b,d)?a[d]=b[d]:a[d]=x[d]})}function b(b,c,d){var e={providers:null,providersLookup:{},fetched:null,fetchProviders:function(){var a=this;return b.ingestProviders.query().then(function(b){a.providers=b._items})},generateLookup:function(){var a=this;return this.providersLookup=_.indexBy(a.providers,"_id"),c.when()},initialize:function(){return this.fetched||(this.fetched=this.fetchProviders().then(angular.bind(this,this.generateLookup))),this.fetched},fetchDashboardProviders:function(){var e=c.defer();return b.ingestProviders.query({max_results:500}).then(function(b){var c=b._items;d.get("dashboard:ingest").then(function(b){_.isArray(b)||(b=[]),_.forEach(c,function(c){var d=_.find(b,function(a){return a._id===c._id});c.dashboard_enabled=d?!0:!1,a(c,d?d:x)}),e.resolve(c)},function(a){e.reject(a)})},function(a){e.reject(a)}),e.promise}};return e}function c(a){var b={rawSubjects:null,qcodeLookup:{},subjects:[],fetched:null,fetchSubjects:function(){var b=this;return a.get("/subjectcodes").then(function(a){b.rawSubjects=a})},process:function(){var a=this;return _.each(this.rawSubjects._items,function(b){a.qcodeLookup[b.qcode]=b}),_.each(this.rawSubjects._items,function(b){a.subjects.push({qcode:b.qcode,name:b.name,path:a.getPath(b)})}),this.subjects},getPath:function(a){var b="";return a.parent&&(b=this.getPath(this.qcodeLookup[a.parent])+this.qcodeLookup[a.parent].name+" / "),b},initialize:function(){return this.fetched||(this.fetched=this.fetchSubjects().then(angular.bind(this,this.process))),this.fetched}};return b}function d(a,b,c,d,e){b.invoke(v,this,{$scope:a}),a.type="ingest",a.loading=!1,a.repo={ingest:!0,archive:!1},a.api=d.ingest,e.currentModule="ingest",this.fetchItems=function(b){a.loading=!0,d.ingest.query(b).then(function(b){a.items=b})["finally"](function(){a.loading=!1})},this.fetchItem=function(a){return d.ingest.getById(a)};var f=_.omit(c.search(),"_id"),g=angular.bind(this,function(){var a=_.omit(c.search(),"_id");_.isEqual(_.omit(a,"page"),_.omit(f,"page"))||c.search("page",null);var b=this.getQuery(c.search());this.fetchItems({source:b}),f=a});a.$on("ingest:update",g),a.$on("item:fetch",g),a.$watchCollection(function(){return _.omit(c.search(),"_id")},g)}function e(a,b){var c=b.privileges;a.showIngest=Boolean(c.ingest_providers),a.showRuleset=Boolean(c.rule_sets),a.showRouting=Boolean(c.routing_rules)}function f(a){return{replace:!0,scope:{terms:"=",theme:"@",colors:"="},link:function(b,c,d){var e=c[0],f=d.x?parseInt(d.x,10):1,g=d.y?parseInt(d.y,10):1,h={blockWidth:300,blockHeight:197,mergeSpaceLeft:60,mergeSpaceBottom:99},i=h.blockWidth*f+h.mergeSpaceLeft*(f-1),j=h.blockHeight*g+h.mergeSpaceBottom*(g-1),k=Math.min(i,j)/2;a.get(function(a){function c(){function a(){var a=this,c=a.getBoundingClientRect();m.selectAll(".place-label").each(function(){if(this!==a){var d=this.getBoundingClientRect();if(2*Math.abs(c.left-d.left)<c.width+d.width&&2*Math.abs(c.top-d.top)<c.height+d.height){var e=.01*(Math.max(0,c.right-d.left)+Math.min(0,c.left-d.right)),f=.02*(Math.max(0,c.bottom-d.top)+Math.min(0,c.top-d.bottom)),g=d3.transform(d3.select(this).attr("transform")),h=d3.transform(d3.select(a).attr("transform"));b+=Math.abs(e)+Math.abs(f),h.translate=[h.translate[0]+e,h.translate[1]+f],g.translate=[g.translate[0]-e,g.translate[1]-f],d3.select(this).attr("transform","translate("+g.translate+")"),d3.select(a).attr("transform","translate("+h.translate+")"),c=this.getBoundingClientRect()}}})}for(var b=1;b>0;)b=0,m.selectAll(".place-label").each(a)}var f=a.schemes[0],g=d3.svg.arc().outerRadius(k).innerRadius(8*k/13/2),h=d.sort||null,l=d3.layout.pie().value(function(a){return a.doc_count}).sort(h?function(a,b){return d3.ascending(a[h],b[h])}:null),m=d3.select(e).append("svg").attr("width",i).attr("height",j).append("g").attr("transform","translate("+i/2+","+j/2+")");b.$watchGroup(["terms","colors"],function(b){if(null!=b[0]){null!==b[1]&&(f=a.schemes[_.findKey(a.schemes,{name:b[1]})]);var d=d3.scale.ordinal().range(f.charts);m.selectAll(".arc").remove();var e=m.selectAll(".arc").data(l(b[0])).enter().append("g").attr("class","arc");e.append("path").attr("d",g).style("fill",function(a){return d(a.data.key)}),e.append("text").attr("class","place-label").attr("transform",function(a){return"translate("+g.centroid(a)+")"}).style("text-anchor","middle").style("fill",f.text).text(function(a){return a.data.key}),c()}})})}}}function g(a,b,c,d,e,f,g,h){return{templateUrl:"scripts/superdesk-ingest/views/settings/ingest-sources-content.html",link:function(i){function j(){return e.ingestProviders.query({max_results:200}).then(function(a){a._items=h("sortByName")(a._items),i.providers=a})}function k(){var a,b=f.search()._id;b&&(i.providers&&i.providers._items&&(a=_.find(i.providers._items,function(a){return a._id===b})),null==a&&e.ingestProviders.getById(b).then(function(b){a=b}),a&&i.edit(a))}i.provider=null,i.origProvider=null,i.feedingServices=h("sortByName")(a,"label"),i.feedParsers=h("sortByName")(b),i.fileTypes=["text","picture","composite","video","audio"],i.minutes=[0,1,2,3,4,5,8,10,15,30,45],i.seconds=[0,5,10,15,30,45],i.hours=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24],
i.contentFields=["body_text","guid","published_parsed","summary","title","updated_parsed"],i.fieldsNotSelected=angular.copy(i.contentFields),i.fieldAliases=[],j().then(function(){k()}),e("rule_sets").query().then(function(a){i.rulesets=h("sortByName")(a._items)}),e("routing_schemes").query().then(function(a){i.routingScheme=h("sortByName")(a._items)}),i.fetchSourceErrors=function(){return i.provider&&i.provider.feeding_service?e("io_errors").query({source_type:i.provider.feeding_service}).then(function(a){i.provider.source_errors=a._items[0].source_errors,i.provider.all_errors=a._items[0].all_errors}):void 0},i.remove=function(a){g.confirm(c("Are you sure you want to delete Ingest Source?")).then(function(){e.ingestProviders.remove(a).then(function(){d.success(c("Ingest Source deleted."))},function(a){angular.isDefined(a.data._message)?d.error(a.data._message):d.error(c("Error: Unable to delete Ingest Source"))}).then(j)})},i.edit=function(a){var b;i.origProvider=a||{},i.provider=_.create(i.origProvider),i.provider.update_schedule=i.origProvider.update_schedule||y,i.provider.idle_time=i.origProvider.idle_time||z,i.provider.notifications=i.origProvider.notifications,i.provider.config=i.origProvider.config,i.provider.critical_errors=i.origProvider.critical_errors,i.provider._id=i.origProvider._id,i.fieldAliases=[],b=angular.isDefined(i.origProvider.config)&&i.origProvider.config.field_aliases||[];var c={};b.forEach(function(a){_.extend(c,a)}),Object.keys(c).forEach(function(a){i.fieldAliases.push({fieldName:a,alias:c[a]})}),i.fieldsNotSelected=i.contentFields.filter(function(a){return!(a in c)})},i.cancel=function(){i.origProvider=null,i.provider=null},i.setConfig=function(a){i.provider.config=a.config},i.setRssConfig=function(a){a.config.auth_required||(a.config.username=null,a.config.password=null),i.provider.config=a.config},i.addFieldAlias=function(){i.fieldAliases.push({fieldName:null,alias:""})},i.removeFieldAlias=function(a){var b=i.fieldAliases.splice(a,1);b[0].fieldName&&i.fieldsNotSelected.push(b[0].fieldName)},i.fieldSelectionChanged=function(){var a={};i.fieldAliases.forEach(function(b){b.fieldName&&(a[b.fieldName]=!0)}),i.fieldsNotSelected=i.contentFields.filter(function(b){return!(b in a)})},i.availableFieldOptions=function(a){var b=angular.copy(i.fieldsNotSelected);return a&&b.push(a),b},i.save=function(){var a=[];i.fieldAliases.forEach(function(b){if(b.fieldName&&b.alias){var c={};c[b.fieldName]=b.alias,a.push(c)}}),"undefined"!=typeof i.provider.config&&(i.provider.config.field_aliases=a),delete i.provider.all_errors,delete i.provider.source_errors,e.ingestProviders.save(i.origProvider,i.provider).then(function(){d.success(c("Provider saved!")),i.cancel()}).then(j)},i.gotoIngest=function(a){f.path("/search").search({repo:"ingest",source:angular.toJson([a])})},i.addOrRemoveFileType=function(a){i.provider.content_types||(i.provider.content_types=[]);var b=i.provider.content_types.indexOf(a);b>-1?i.provider.content_types.splice(b,1):i.provider.content_types.push(a)},i.hasFileType=function(a){return i.provider&&i.provider.content_types&&i.provider.content_types.indexOf(a)>-1},i.initProviderConfig=function(){"reuters_http"!==i.provider.feeding_service||i.provider.config||(i.provider.config={url:"http://rmb.reuters.com/rmd/rest/xml",auth_url:"https://commerce.reuters.com/rmd/rest/xml/login"})},i.getConfigTemplateURL=function(){var a=_.find(i.feedingServices,function(a){return a.value===i.provider.feeding_service});return a?a.templateUrl:""}}}}function h(a,b,c,d,e){return{templateUrl:"scripts/superdesk-ingest/views/settings/ingest-rules-content.html",link:function(f){function g(){return d.confirm(b("Are you sure you want to delete rule set?"))}var h=null;f.editRuleset=null,a("rule_sets").query().then(function(a){f.rulesets=e("sortByName")(a._items)}),f.edit=function(a){f.editRuleset=_.create(a),f.editRuleset.rules=a.rules||[],h=a},f.save=function(d){var g=d._id?!1:!0;a("rule_sets").save(h,d).then(function(){g&&f.rulesets.push(h),f.rulesets=e("sortByName")(f.rulesets),c.success(b("Rule set saved.")),f.cancel()},function(a){c.error(b("I'm sorry but there was an error when saving the rule set."))})},f.cancel=function(){f.editRuleset=null},f.remove=function(d){g().then(function(){a("rule_sets").remove(d).then(function(a){_.remove(f.rulesets,d)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("There is an error. Rule set cannot be deleted."))})})},f.removeRule=function(a){_.remove(f.editRuleset.rules,a)},f.addRule=function(){f.editRuleset.rules||(f.editRuleset.rules=[]),f.editRuleset.rules.push({old:null,"new":null})},f.reorder=function(a,b){f.editRuleset.rules.splice(b,0,f.editRuleset.rules.splice(a,1)[0])}}}}function i(a,b,c,d,e,f){return{templateUrl:"scripts/superdesk-ingest/views/settings/ingest-routing-content.html",link:function(g){function h(a){return"scheme"===a?d.confirm(b("Are you sure you want to delete this scheme?")):"rule"===a?d.confirm(b("Are you sure you want to delete this scheme rule?")):void 0}var i=1,j=null;g.editScheme=null,g.rule=null,g.ruleIndex=null,g.schemes=[],a("routing_schemes").query().then(function(a){g.schemes=f("sortByName")(a._items)}),g.contentFilters=[],e.getAllContentFilters(i,g.contentFilters).then(function(a){g.contentFilters=a}),g.edit=function(a){g.editScheme=_.clone(a),g.editScheme.rules=g.editScheme.rules||[],j=a},g.save=function(){g.rule&&(delete g.rule.filterName,-1===g.ruleIndex?g.editScheme.rules.push(g.rule):g.editScheme.rules[g.ruleIndex]=g.rule),g.editScheme.rules=_.reject(g.editScheme.rules,{name:null});var d=g.editScheme._id?!1:!0;a("routing_schemes").save(j,g.editScheme).then(function(){d&&g.schemes.push(j),g.schemes=f("sortByName")(g.schemes),c.success(b("Routing scheme saved.")),g.cancel()},function(a){c.error(b("I'm sorry but there was an error when saving the routing scheme."))})},g.cancel=function(){g.editScheme=null,g.rule=null},g.remove=function(d){h("scheme").then(function(){a("routing_schemes").remove(d).then(function(a){_.remove(g.schemes,d)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("There is an error. Routing scheme cannot be deleted."))})})},g.removeRule=function(a){h("rule").then(function(){a===g.rule&&(g.rule=null),_.remove(g.editScheme.rules,a)})},g.addRule=function(){var a={name:null,filter:null,actions:{fetch:[],publish:[],exit:!1},schedule:{day_of_week:["MON","TUE","WED","THU","FRI","SAT","SUN"],hour_of_day_from:"0000",hour_of_day_to:"2355"}};g.editScheme.rules.push(a),g.editRule(a)},g.editRule=function(a){var b;g.rule=a,b=_.find(g.contentFilters,{_id:a.filter}),b&&(g.rule.filterName=b.name)},g.reorder=function(a,b){g.editScheme.rules.splice(b,0,g.editScheme.rules.splice(a,1)[0])}}}}function j(a,b,c){return{scope:{rule:"=",removeAction:"="},templateUrl:"scripts/superdesk-ingest/views/settings/ingest-routing-general.html",link:function(d){d.dayLookup=a,d.macroLookup={},b.initialize().then(function(){d.deskLookup=b.deskLookup,d.stageLookup=b.stageLookup}),d.remove=function(){return"function"==typeof d.removeAction?d.removeAction(d.rule):void 0},c.get().then(function(a){_.transform(a,function(a,b,c){d.macroLookup[b.name]=b})})}}}function k(){return RegExp.escape=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},{scope:{rule:"=",filters:"=contentFilters"},templateUrl:"scripts/superdesk-ingest/views/settings/ingest-routing-filter.html",link:function(a){function b(){a.matchingFilters=[],a.filterSearchTerm=null,c=_.find(a.filters,{_id:a.rule.filter}),c?a.selectedFilter=c:a.selectedFilter=null}var c;b(),a.$watch("rule",function(){b()}),a.searchFilters=function(b){var c=new RegExp(RegExp.escape(b),"i");a.matchingFilters=_.filter(a.filters,function(a){return c.test(a.name)})},a.selectFilter=function(b){a.selectedFilter=b,a.rule.filter=b._id,a.rule.filterName=b.name,a.filterSearchTerm=null},a.clearSelectedFilter=function(){a.selectedFilter=null,a.rule.filter=null,a.rule.filterName=null}}}}function l(a,b){return{scope:{rule:"="},templateUrl:"scripts/superdesk-ingest/views/settings/ingest-routing-action.html",link:function(c){c.newFetch={},c.newPublish={},c.deskLookup={},c.stageLookup={},c.macroLookup={},a.initialize().then(function(){c.deskLookup=a.deskLookup,c.stageLookup=a.stageLookup}),b.get().then(function(a){_.transform(a,function(a,b,d){c.macroLookup[b.name]=b})}),c.addFetch=function(){c.newFetch.desk&&c.newFetch.stage&&(c.rule.actions.fetch.push(c.newFetch),c.newFetch={})},c.removeFetch=function(a){_.remove(c.rule.actions.fetch,function(b){return b===a})},c.addPublish=function(){c.newPublish.desk&&c.newPublish.stage&&(c.rule.actions.publish.push(c.newPublish),c.newPublish={})},c.removePublish=function(a){_.remove(c.rule.actions.publish,function(b){return b===a})}}}}function m(a){return{scope:{rule:"="},templateUrl:"scripts/superdesk-ingest/views/settings/ingest-routing-schedule.html",link:function(b,c,d){b.timeZones=[],b.tzSearchTerm="",b.matchingTimeZones=[],a.$promise.then(function(){b.timeZones=a.getTzNames()}),b.searchTimeZones=function(a){var c;return b.tzSearchTerm=a,a?(c=a.toLowerCase(),void(b.matchingTimeZones=_.filter(b.timeZones,function(a){return a.toLowerCase().indexOf(c)>=0}))):void(b.matchingTimeZones=[])},b.selectTimeZone=function(a){b.rule.schedule.time_zone=a,b.tzSearchTerm=""},b.clearSelectedTimeZone=function(){b.rule.schedule.time_zone=null}}}}function n(){return{link:function(a,b){b.sortable({items:"li",connectWith:".rule-list",cursor:"move",start:function(a,b){b.item.data("start",b.item.index())},stop:function(b,c){var d=c.item.data("start"),e=c.item.index();a.reorder(d,e),a.$apply()}})}}}function o(){return function(a,b,c){return b=b||a.length,c=c||"",a.substr(0,b)+c+a.substr(b)}}function p(a,b,c,d,e,f){a.items=[],a.dashboard_items=[],a.fetchItems=function(){c.fetchDashboardProviders().then(function(b){a.items=b,a.dashboard_items=_.filter(b,{dashboard_enabled:!0})})},a.setUserPreferences=function(b){var c=[],g={};_.forEach(_.filter(a.items,{dashboard_enabled:!0}),function(a){c.push(_.pick(a,_.union(["_id"],_.keys(x))))}),g["dashboard:ingest"]=c,d.update(g).then(function(c){b&&a.fetchItems()},function(a){e.error(f("Ingest Dashboard preferences could not be saved."),2e3)})},a.fetchItems()}function q(a,b,c){return{templateUrl:"scripts/superdesk-ingest/views/dashboard/ingest-dashboard-widget.html",scope:{item:"=",setUserPreferences:"&"},link:function(d){function e(){var b={source:{query:{filtered:{filter:{and:[{term:{ingest_provider:d.item._id}},{range:{versioncreated:{gte:"now-24h"}}}]}}},size:0,from:0}};a.ingest.query(b).then(function(a){d.ingested_count=a._meta.total})}function f(){a.ingestProviders.getById(d.item._id).then(function(a){angular.extend(d.item,a),i()},function(a){404===a.status&&(d.item.dashboard_enabled=!1,d.setUserPreferences())})}function g(){var b={max_results:5,sort:"[('_created',-1)]",embedded:{user:1}},c=[{resource:"ingest_providers"},{"data.provider_id":d.item._id}];"error"===d.item.log_messages&&c.push({name:"error"}),b.where=JSON.stringify({$and:c}),a.query("activity",b).then(function(a){d.log_messages=a._items})}function h(a){a.provider_id===d.item._id&&(e(),f(),g())}function i(){d.item.is_closed&&d.item.last_closed&&d.item.last_closed.closed_by?b.getUser(d.item.last_closed.closed_by).then(function(a){d.item.last_closed.display_name=a.display_name}):!d.item.is_closed&&d.item.last_opened&&d.item.last_opened.opened_by&&b.getUser(d.item.last_opened.opened_by).then(function(a){d.item.last_opened.display_name=a.display_name})}function j(){d.showIngest=Boolean(c.privileges.ingest_providers),d.ingested_count=0,e(),i(),g()}j(),d.isIdle=function(){if(d.item.last_item_update&&!d.item.is_closed){var a=d.item.idle_time||z,b=moment(d.item.last_item_update);if(a&&!angular.equals(a,z))return b.add(a.hours,"h").add(a.minutes,"m"),moment()>b?!0:!1}return!1},d.filterLogMessages=function(){d.setUserPreferences(),g()},d.$on("ingest:update",function(a,b){h(b)}),d.$on("ingest_provider:update",function(a,b){h(b)})}}}function r(){return{templateUrl:"scripts/superdesk-ingest/views/dashboard/ingest-dashboard-widget-list.html",scope:{items:"=",setUserPreferences:"&"}}}function s(a){return{templateUrl:"scripts/superdesk-ingest/views/dashboard/ingest-sources-list.html",scope:{items:"=",setUserPreferences:"&"},link:function(b){b.showIngest=Boolean(a.privileges.ingest_providers)}}}function t(){return function(a){var b="";return _.isPlainObject(a)&&(b+=a.minutes&&a.minutes>0?a.minutes+(a.minutes>1?" minutes":" minute"):"",b+=b.length>0?" ":"",b+=a.seconds&&a.seconds>0?a.seconds+(a.seconds>1?" seconds":" second"):""),b}}function u(a,b,c,d,e,f){function g(c){return b.save("fetch",{},{desk:a.getCurrentDeskId()},c).then(function(a){return c.task_id=a.task_id,c.archived=a._created,f.reset(),a},function(a){var b="Failed to fetch the item";angular.isDefined(a.data._message)&&(b=b+": "+a.data._message),d.error(gettext(b)),c.error=a})["finally"](function(){c.actioning&&(c.actioning.archive=!1)})}function h(a){angular.forEach(a,g)}function i(a,c){function d(a){var b={desk:a.desk};return a.stage&&(b.stage=a.stage),a.macro&&(b.macro=a.macro),b}var f=d(c);return"ingest"===a._type?b.save("fetch",{},f,a).then(function(b){return a.archived=b._created,c.open&&e.edit(b),b}):a.lock_user?void 0:b.save("move",{},{task:f},a).then(function(a){return a})}function j(a){return l.config=c.defer(),l.config.promise.then(function(b){return l.config=null,f.reset(),c.all(a.map(function(a){return i(a,b)}))})}function k(){return l.config}this.one=g,this.all=h,this.oneAs=i,this.allAs=j,this.config=null,this.getConfig=k;var l=this}var v=window.BaseListController;angular.module("superdesk.ingest.send",["superdesk.api","superdesk.desks"]).service("send",u);var w=angular.module("superdesk.ingest",["superdesk.search","superdesk.dashboard","superdesk.widgets.base","superdesk.widgets.ingeststats","superdesk.ingest.send"]);w.value("feedingServices",[{value:"file",label:"File Feed",templateUrl:"scripts/superdesk-ingest/views/settings/fileConfig.html"},{value:"reuters_http",label:"Reuters Feed API",templateUrl:"scripts/superdesk-ingest/views/settings/reutersConfig.html"},{value:"rss",label:"RSS",templateUrl:"scripts/superdesk-ingest/views/settings/rssConfig.html"},{value:"ftp",label:"FTP",templateUrl:"scripts/superdesk-ingest/views/settings/ftp-config.html"},{value:"email",label:"Email",templateUrl:"scripts/superdesk-ingest/views/settings/emailConfig.html"}]),w.value("feedParsers",[{value:"email_rfc822",name:"EMail RFC822 Parser"},{value:"nitf",name:"NITF Parser"},{value:"newsml12",name:"News ML 1.2 Parser"},{value:"afpnewsml12",name:"AFP News ML 1.2 Parser"},{value:"newsml2",name:"News ML-G2 Parser"},{value:"scoop_newsml2",name:"Scoop Media News ML-G2 Parser"},{value:"wenn",name:"WENN Parser"},{value:"anpa1312",name:"ANPA Parser"},{value:"iptc7901",name:"IPTC 7901 Parser"},{value:"dpa_iptc7901",name:"DPA IPTC 7901 Parser"},{value:"zczc",name:"ZCZC Parser"}]);var x={show_log_messages:!0,show_ingest_count:!0,show_time:!0,log_messages:"error",show_status:!0},y={minutes:5,seconds:0},z={hours:0,minutes:0};b.$inject=["api","$q","preferencesService"],c.$inject=["api"],d.$inject=["$scope","$injector","$location","api","$rootScope"],e.$inject=["$scope","privileges"],f.$inject=["colorSchemes"],g.$inject=["feedingServices","feedParsers","gettext","notify","api","$location","modal","$filter"],h.$inject=["api","gettext","notify","modal","$filter"],i.$inject=["api","gettext","notify","modal","contentFilters","$filter"],j.$inject=["weekdays","desks","macros"],k.$inject=[],l.$inject=["desks","macros"],m.$inject=["tzdata"],p.$inject=["$scope","api","ingestSources","preferencesService","notify","gettext"],q.$inject=["api","userList","privileges"],r.$inject=[],s.$inject=["privileges"],w.service("ingestSources",b).factory("subjectService",c).directive("sdIngestSourcesContent",g).directive("sdIngestRulesContent",h).directive("sdIngestRoutingContent",i).directive("sdIngestRoutingGeneral",j).directive("sdIngestRoutingFilter",k).directive("sdIngestRoutingAction",l).directive("sdIngestRoutingSchedule",m).directive("sdPieChartDashboard",f).directive("sdSortrules",n).directive("sdUserIngestDashboardDropDown",s).directive("sdUserIngestDashboardList",r).directive("sdUserIngestDashboard",q).filter("insert",o).filter("scheduleFilter",t),w.config(["superdeskProvider",function(a){a.activity("/workspace/ingest",{label:gettext("Workspace"),priority:100,controller:d,templateUrl:"scripts/superdesk-archive/views/list.html",category:"/workspace",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",privileges:{ingest:1}}).activity("/settings/ingest",{label:gettext("Ingest"),templateUrl:"scripts/superdesk-ingest/views/settings/settings.html",controller:e,category:a.MENU_SETTINGS,privileges:{ingest_providers:1}}).activity("/ingest_dashboard",{label:gettext("Ingest Dashboard"),templateUrl:"scripts/superdesk-ingest/views/dashboard/dashboard.html",controller:p,category:a.MENU_MAIN,priority:100,adminTools:!0,privileges:{ingest_providers:1}}).activity("fetchAs",{label:gettext("Fetch To"),icon:"fetch-as",controller:["data","send",function(a,b){b.allAs([a.item])}],filters:[{action:"list",type:"ingest"}],privileges:{fetch:1}}).activity("archive",{label:gettext("Fetch"),icon:"archive",monitor:!0,controller:["send","data",function(a,b){return a.one(b.item)}],filters:[{action:"list",type:"ingest"}],privileges:{fetch:1},key:"f",additionalCondition:["desks",function(a){return null!=a.getCurrentDeskId()}]}).activity("externalsource",{label:gettext("Get from external source"),icon:"archive",monitor:!0,controller:["api","data","desks",function(a,b,c){c.fetchCurrentDeskId().then(function(c){a(b.item.fetch_endpoint).save({guid:b.item.guid,desk:c}).then(function(a){b.item.error=a})["finally"](function(){b.item.actioning.externalsource=!1})})}],filters:[{action:"list",type:"externalsource"}],privileges:{fetch:1}})}]),w.config(["apiProvider",function(a){a.api("fetch",{type:"http",backend:{rel:"fetch"}}),a.api("ingest",{type:"http",backend:{rel:"ingest"}}),a.api("ingestProviders",{type:"http",backend:{rel:"ingest_providers"}}),a.api("activity",{type:"http",backend:{rel:"activity"}})}]),u.$inject=["desks","api","$q","notify","authoringWorkspace","multi"]}(),function(){"use strict";function a(a){var b=[];this.isSelected=function(a){return a.selected},this.toggle=function(a){function c(b){return b._id===a._id&&b._current_version===a._current_version}b=_.without(b,_.find(b,c)),a.selected&&(b=_.union(b,[a])),this.count=b.length},this.getIds=function(){return _.map(b,"_id")},this.getItems=function(){return b},this.reset=function(){var c=[];_.each(b,function(a){a.selected=!1,c.push(a._id)}),a.$broadcast("multi:reset",b),b=[],this.count=0,a.$broadcast("multi:reset",{ids:c})},this.reset(),a.$on("$routeChangeStart",angular.bind(this,this.reset))}function b(a,b,c,d){var e="archive_spike",f="archive_unspike";this.spike=function(f){return b.update(e,f,{state:"spiked"}).then(function(){return a.search()._id===f._id&&a.search("_id",null),f},function(a){f.error=a,angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues["validator exception"])&&c.error(d(a.data._issues["validator exception"]))})},this.spikeMultiple=function(a){a.forEach(this.spike)},this.unspike=function(c){return b.update(f,c,{}).then(function(){return a.search()._id===c._id&&a.search("_id",null),c},function(a){c.error=a})},this.unspikeMultiple=function(a){a.forEach(this.unspike)}}function c(a,b,c,d,e,f){this.addTaskToArticle=function(c,d){d=d||a.getCurrentDesk(),c.task&&c.task.desk||!d||"/workspace/personal"===f.path()||(c.task={desk:d._id,stage:d.working_stage,user:b.identity._id})},this.getType=function(a){var b;return b=this.isLegal(a)?a._type:this.isArchived(a)?"archived":"externalsource"===a._type?"externalsource":"spiked"===a.state?"spike":"ingested"===a.state?"ingest":"archive"},this.isLegal=function(a){return"legal_archive"===a._type},this.isArchived=function(a){return"archived"===a._type},this.getRelatedItems=function(a){var b=moment().subtract(1,"days").format(),d={};d.q="slugline:("+a+")",d.ignoreKilled=!0,d.ignoreDigital=!0,d.afterversioncreated=b;var f=e.query(d);f.size(200);var g=f.getCriteria(!0);return g.repo="archive,published",c.query("search",g).then(function(a){return a})},this.isPublished=function(a){return _.contains(["published","killed","scheduled","corrected"],a.state)},this.getVersionHistory=function(a,b,e){return this.isLegal(a)?c.find("legal_archive",a._id,{version:"all"}).then(function(b){return _.each(b._items,function(b){b.desk=b.task.desk,b.stage=b.task.stage,b.creator=b.version_creator||b.original_creator,"text"===b.type?b.typeName="Story":b.typeName=_.capitalize(a.type)}),"versions"===e?d.when(_.sortBy(_.reject(b._items,{version:0}),"_current_version").reverse()):"operations"===e?d.when(_.sortBy(b._items,"_current_version")):void 0}):c.find("archive",a._id,{version:"all",embedded:{user:1}}).then(function(c){return _.each(c._items,function(c){if(c.task){if(c.task.desk){var d=b.deskLookup[c.task.desk];c.desk=d&&d.name}if(c.task.stage){var e=b.stageLookup[c.task.stage];c.stage=e&&e.name}}if(c.version_creator||c.original_creator){var f=b.userLookup[c.version_creator||c.original_creator];c.creator=f&&f.display_name}"text"===c.type?c.typeName="Story":c.typeName=_.capitalize(a.type)}),"versions"===e?d.when(_.sortBy(_.reject(c._items,{version:0}),"_current_version").reverse()):"operations"===e?d.when(_.sortBy(c._items,"_current_version")):void 0})},this.lastVersion=function(a,b){return a._latest_version?_.find(b,{_current_version:a._latest_version}):_.max(b,function(a){return a._current_version||a.version||a._updated})}}function d(a,b,c,d,e,f){a.items=[],a.saving=!1,a.failed=!1,a.enableSave=!1,a.currentUser=f.identity;var g=["headline","description","slugline"],h=function(e){var f=function(c){return e.model=!1,a.failed=!0,b.reject(c)};return e.upload||d.archive.getUrl().then(function(a){return e.upload=c.start({method:"POST",url:a,data:{media:e.file},headers:d.archive.getHeaders()}).then(function(a){return a.data._issues?f(a):(e.model=a.data,e)},f,function(a){e.progress=Math.round(a.loaded/a.total*100)}),e.upload})},i=function(){a.failed=_.some(a.items,{model:!1})},j=function(){a.errorMessage=null,_.isEmpty(a.items)||_.each(a.items,function(b){_.each(g,function(c){return null==b.meta[c]||_.isEmpty(b.meta[c])?(a.errorMessage="Required field(s) are missing",!1):void 0})})};a.setAllMeta=function(b,c){_.each(a.items,function(a){a.meta[b]=c})},a.addFiles=function(b){_.each(b,function(b){var c={file:b,meta:{byline:a.currentUser.byline},progress:0};c.cssType=c.file.type.split("/")[0],a.items.unshift(c),a.enableSave=!0})},a.upload=function(){var c=[];return _.each(a.items,function(a){a.model||a.progress||(a.upload=null,c.push(h(a)))}),c.length?b.all(c):b.when()},a.save=function(){return j(),null==a.errorMessage?(a.saving=!0,a.upload().then(function(c){b.all(_.map(a.items,function(a){return e.addTaskToArticle(a.meta),d.archive.update(a.model,a.meta)})).then(function(b){a.resolve(b)})})["finally"](function(){a.saving=!1,i()})):void 0},a.cancel=function(){_.each(a.items,a.cancelItem,a),a.reject()},a.tryAgain=function(){a.failed=null,a.upload()},a.cancelItem=function(b,c){null!=b&&(b.model?d.archive.remove(b.model):b.upload&&b.upload.abort&&b.upload.abort()),void 0!==c&&a.items.splice(c,1),_.isEmpty(a.items)&&(a.enableSave=!1),i()}}return a.$inject=["$rootScope"],b.$inject=["$location","api","notify","gettext"],c.$inject=["desks","session","api","$q","search","$location"],d.$inject=["$scope","$q","upload","api","archiveService","session"],angular.module("superdesk.archive",["superdesk.search","superdesk.archive.directives","superdesk.dashboard","superdesk.widgets.base","superdesk.widgets.relatedItem"]).service("spike",b).service("multi",a).service("archiveService",c).controller("UploadController",d).config(["superdeskProvider",function(a){a.activity("/workspace/content",{label:gettext("Workspace"),priority:100,controller:"ArchiveListController",templateUrl:"scripts/superdesk-archive/views/list.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",filters:[{action:"view",type:"content"}],privileges:{archive:1}}).activity("upload.media",{label:gettext("Upload media"),modal:!0,cssClass:"upload-media modal-responsive",controller:d,templateUrl:"scripts/superdesk-archive/views/upload.html",filters:[{action:"upload",type:"media"}],privileges:{archive:1}}).activity("spike",{label:gettext("Spike Item"),icon:"trash",monitor:!0,controller:["spike","data","$rootScope",function(a,b,c){return a.spike(b.item).then(function(a){return c.$broadcast("item:spike"),a})}],filters:[{action:"list",type:"archive"}],action:"spike",keyboardShortcut:"ctrl+x",condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).spike}]}).activity("unspike",{label:gettext("Unspike Item"),icon:"unspike",monitor:!0,controller:["spike","data","$rootScope",function(a,b,c){return a.unspike(b.item).then(function(a){return c.$broadcast("item:unspike"),a})}],filters:[{action:"list",type:"spike"}],action:"unspike",additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).unspike}]}).activity("duplicate",{label:gettext("Duplicate"),icon:"copy",monitor:!0,controller:["api","notify","$rootScope","data",function(a,b,c,d){a.save("duplicate",{},{desk:d.item.task.desk},d.item).then(function(){c.$broadcast("item:duplicate"),b.success(gettext("Item Duplicated"))})}],filters:[{action:"list",type:"archive"}],keyboardShortcut:"ctrl+d",privileges:{duplicate:1},condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).duplicate}]}).activity("createBroadcast",{label:gettext("Create Broadcast"),icon:"broadcast",monitor:!0,controller:["api","notify","$rootScope","data","desks","authoringWorkspace",function(a,b,c,d,e,f){a.save("archive_broadcast",{},{desk:e.getCurrentDeskId()},d.item).then(function(a){f.edit(a),c.$broadcast("broadcast:created",{item:d.item})})}],filters:[{action:"list",type:"archive"}],keyboardShortcut:"ctrl+b",privileges:{archive:1},condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).create_broadcast}]}).activity("copy",{label:gettext("Copy"),icon:"copy",monitor:!0,controller:["api","data","$rootScope",function(a,b,c){a.save("copy",{},{},b.item).then(function(a){b.item.task_id=a.task_id,b.item.created=a._created,c.$broadcast("item:copy")},function(a){b.item.error=a})["finally"](function(){b.item.actioning.archiveContent=!1})}],filters:[{action:"list",type:"archive"}],condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).copy}]}).activity("newtake",{label:gettext("New Take"),icon:"new-doc",filters:[{action:"list",type:"archive"}],keyboardShortcut:"ctrl+alt+t",privileges:{archive:1},condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).new_take}],controller:["data","$rootScope","desks","authoring","authoringWorkspace","notify","superdesk",function(a,b,c,d,e,f){var g=null;a.item.task&&a.item.task.desk&&(g=a.item.task.desk),d.linkItem(a.item,null,g).then(function(a){f.success(gettext("New take created.")),b.$broadcast("item:take"),e.edit(a)},function(b){a.item.error=b,f.error(gettext("Failed to generate new take."))})}]}).activity("rewrite",{label:gettext("Update"),icon:"edit-line",filters:[{action:"list",type:"archive"}],group:"corrections",privileges:{archive:1},condition:function(a){return null===a.lock_user||angular.isUndefined(a.lock_user)},additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).re_write}],controller:["data","$location","api","notify","session","authoringWorkspace","desks","superdesk",function(a,b,c,d,e,f,g,h){e.getIdentity().then(function(b){return c.save("archive_rewrite",{},{},a.item)}).then(function(a){d.success(gettext("Update Created.")),f.edit(a._id)},function(a){angular.isDefined(a.data._message)?d.error(gettext("Failed to generate update: "+a.data._message)):d.error(gettext("There is an error. Failed to generate update."))})}]})}]).config(["apiProvider",function(a){a.api("copy",{type:"http",backend:{rel:"copy"}}),a.api("duplicate",{type:"http",backend:{rel:"duplicate"}}),a.api("notification",{type:"http",backend:{rel:"notification"}}),a.api("archive",{type:"http",backend:{rel:"archive"}}),a.api("archive_rewrite",{type:"http",backend:{rel:"archive_rewrite"}})}])}(),function(){"use strict";var a=window.BaseListController;angular.module("superdesk.archive").controller("ArchiveListController",["$scope","$injector","$location","$q","$timeout","superdesk","session","api","desks","content","StagesCtrl","notify","multi",function(b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){q=j.active.desk?i(b.published?"published":"archive"):i("user_content",h.identity),r.refresh(!0)}function p(a,b){b&&b.item&&d.search()._id===b.item&&d.search("_id",null),t()}var q,r=this;c.invoke(a,this,{$scope:b}),b.currentModule="archive",b.stages=new l(b),b.content=k,b.type="archive",b.repo={ingest:!1,archive:!0},b.loading=!1,b.spike=!!d.search().spike,b.published=!!d.search().published,b.togglePublished=function(){b.spike&&b.toggleSpike(),b.published=!b.published,d.search("published",b.published?"1":null),d.search("_id",null),b.stages.select(null)},b.toggleSpike=function(){b.published&&b.togglePublished(),b.spike=!b.spike,d.search("spike",b.spike?1:null),d.search("_id",null),b.stages.select(null)},b.stageSelect=function(a){b.spike&&b.toggleSpike(),b.published&&b.togglePublished(),b.stages.select(a),n.reset()},this.fetchItems=function(a){null!=q&&(b.loading=!0,q.query(a).then(function(a){b.loading=!1,b.items=a},function(){b.loading=!1}))},this.fetchItem=function(a){return null==q?e.reject(a):q.getById(a)};var s,t=function(){f.cancel(s),s=f(o,100,!1)};b.$on("task:stage",function(a,c){!b.stages.selected||b.stages.selected._id!==c.new_stage&&b.stages.selected._id!==c.old_stage||t()}),b.$on("media_archive",t),b.$on("item:fetch",t),b.$on("item:copy",t),b.$on("item:take",t),b.$on("item:duplicate",t),b.$on("content:update",t),b.$on("content:expired",t),b.$on("item:deleted",t),b.$on("item:highlight",t),b.$on("item:spike",p),b.$on("item:unspike",p),j.fetchCurrentUserDesks().then(function(){b.$watch(function(){return j.active},function(a){return b.selected=a,d.search().page?void d.search("page",null):void t()})});var u=_.omit(d.search(),"_id","fetch");b.$on("$routeUpdate",function(a,b){var c=_.omit(d.search(),"_id","fetch");angular.equals(u,c)||t(),u=c})}])}(),function(){"use strict";angular.module("superdesk.widgets.relatedItem",["superdesk.widgets.base","superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("related-item",{label:gettext("Related Item"),icon:"related",template:"scripts/superdesk-archive/related-item-widget/widget-relatedItem.html",order:7,side:"right",display:{authoring:!0,packages:!1,killedItem:!0,legalArchive:!1,archived:!1}})}]).controller("relatedItemController",["$scope","api","BaseWidgetController","$location","notify","superdesk","$q",function(a,b,c,d,e,f,g){a.type="archiveWidget",a.itemListOptions={endpoint:"search",repo:["archive","published"],notStates:["spiked"],types:["text","picture","audio","video","composite","preformatted"],page:1,modificationDateAfter:"now-1d"},a.options={pinEnabled:!0,modeEnabled:!0,searchEnabled:!0,itemTypeEnabled:!0,mode:"basic",pinMode:"archive",related:!0,
itemTypes:["text","picture","audio","video","composite"]},a.actions={apply:{title:"Associate",method:function(c){a.origItem=a.options.item,a.options.item.subject=c.subject,a.options.item.anpa_category=c.anpa_category,a.options.item.headline=c.headline,a.options.item.urgency=c.urgency,a.options.item.priority=c.priority,a.options.item.slugline=c.slugline,a.options.item.related_to=c._id,b.save("archive",a.origItem,a.options.item).then(function(a){return e.success(gettext("item updated.")),c})},"class":"open",icon:"icon-expand"},open:{title:"Open",method:function(a){g.when(f.intent("edit","item",a)).then(null,function(b){f.intent("view","item",a)})},"class":"open",icon:"icon-external"}},c.call(this,a)}])}(),function(){"use strict";angular.module("superdesk.dashboard.widgets",[]).provider("dashboardWidgets",function(){var a={};this.addWidget=function(b,c,d){a[b]=_.extend({_id:b},c)},this.$get=function(){return _.values(a)}})}(),function(){"use strict";angular.module("superdesk.dashboard.world-clock",["superdesk.dashboard","ngResource"]).factory("tzdata",["$resource",function(a){var b="scripts/superdesk-dashboard/world-clock/timezones-all.json",c=a(b);return c.prototype.getTzNames=function(){return _.union(_.keys(this.zones),_.keys(this.links)).sort()},c.get()}]).directive("sdWorldclock",[function(){return{templateUrl:"scripts/superdesk-dashboard/world-clock/worldClock.html",replace:!0,restrict:"A",controller:"WorldClockController"}}]).controller("WorldClockConfigController",["$scope","notify","tzdata",function(a,b,c){a.availableZones=[],c.$promise.then(function(){a.availableZones=c.getTzNames()}),a.notify=function(a,c){"add"===a?b.success(gettext("World clock added:")+" "+c,3e3):"remove"===a&&b.success(gettext("World clock removed:")+" "+c,3e3)},a.notIn=function(a){return function(b){return-1===a.indexOf(b)}},a.configuration.zones=a.configuration.zones||[]}]).controller("WorldClockController",["$scope","$interval","tzdata",function(a,b,c){function d(){a.utc=moment(),a.$digest()}var e,f=500;this._moment=moment,c.$promise.then(function(){moment.tz.add(_.pick(c,["zones","links"]))}),e=b(d,f,0,!1),a.$on("$destroy",function(){b.cancel(e)})}]).directive("sdClock",function(){var a=Math.PI,b={s:d3.scale.linear().domain([0,59.999]).range([0,2*a]),m:d3.scale.linear().domain([0,59+59/60]).range([0,2*a]),h:d3.scale.linear().domain([0,11+59/60]).range([0,2*a])};return{scope:{utc:"=",tz:"@"},link:function(a,c,d){function e(a){var b=a.split(":");return[{unit:"h",val:parseInt(b[0],10)+parseInt(b[1],10)/60,r:.5},{unit:"m",val:parseInt(b[1],10),r:.8}]}var f=105,g=100,h=.8*Math.min(f,g)*.5,i="#d8d8d8",j="#313131",k="#a0a0a0",l="#313131",m="#e0e0e0",n="#848484",o=d3.select(c[0]).append("svg").attr("widgth",f).attr("height",g),p=o.append("g").attr("transform","translate("+f/2+","+g/2+")");p.append("circle").attr("r",h).attr("class","clock-outer").style("stroke-width",1.5),p.append("circle").attr("r",1.5).attr("class","clock-inner"),p.selectAll(".number-lines").data(_.range(0,59,5)).enter().append("path").attr("d",function(a){var c=b.m(a),d=d3.svg.arc().innerRadius(.7*h).outerRadius(.9*h).startAngle(c).endAngle(c);return d()}).attr("class","number-lines").style("stroke-width",1.5),a.$watch("utc",function(c){var d=c?c.tz(a.tz).format("HH:mm:ss"):"00:00:00",f=e(d),g=f[0].val>=8&&f[0].val<20;g?(p.selectAll(".clock-outer").style("fill",i),p.selectAll(".clock-inner").style("fill",i),p.selectAll(".number-lines").style("stroke",k)):(p.selectAll(".clock-outer").style("fill",l),p.selectAll(".clock-inner").style("fill",l),p.selectAll(".number-lines").style("stroke",n)),p.selectAll(".clockhand").remove(),p.selectAll(".clockhand").data(f).enter().append("path").attr("d",function(a){var c=b[a.unit](a.val),d=d3.svg.arc().innerRadius(0*h).outerRadius(h*a.r).startAngle(c).endAngle(c);return d()}).attr("class","clockhand").style("stroke-width",2).style("stroke",g?j:m)})}}}).config(["dashboardWidgetsProvider",function(a){a.addWidget("world-clock",{label:gettext("World Clock"),multiple:!0,icon:"time",max_sizex:2,max_sizey:1,sizex:1,sizey:1,thumbnail:"scripts/superdesk-dashboard/world-clock/thumbnail.svg",template:"scripts/superdesk-dashboard/world-clock/widget-worldclock.html",configurationTemplate:"scripts/superdesk-dashboard/world-clock/configuration.html",configuration:{zones:["Europe/London","Asia/Tokyo","Europe/Moscow"]},description:gettext("World clock widget")})}])}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(b){m.current=null,b&&a.$applyAsync(function(){m.current=b,m.widgets=k(b.widgets||[]),m.availableWidgets=c})}function j(a){return _.filter(c,function(b){return b.multiple||null==_.find(a,{_id:b._id})})}function k(a){return _.map(a,function(a){var b=_.find(c,{_id:a._id});return angular.extend({},b,a)})}function l(a){return _.map(a,function(a){return _.pick(a,["_id","configuration","sizex","sizey","col","row","active","multiple_id"])})}var m=this;a.edited=null,a.workspaces=f,a.$watch("workspaces.active",i),f.getActive(),this.addWidget=function(a){a.multiple&&(a=angular.copy(a),a.multiple_id=0,angular.forEach(this.widgets,function(b){b._id===a._id&&b.multiple_id>=a.multiple_id&&(a.multiple_id=b.multiple_id+1)})),a.active=!0,this.widgets.push(a),this.selectWidget(),this.save()},this.selectWidget=function(a){this.isSelected(a)||(this.selectedWidget=a||null)},this.isSelected=function(a){return a&&!_.find(j(this.widgets),a)},this.save=function(){this.edit=!1;var a=angular.extend({},this.current);this.widgets=_.where(this.widgets,{active:!0}),a.widgets=l(this.widgets),d.save("workspaces",this.current,a)},this["delete"]=function(){g.confirm(h("Are you sure you want to delete current workspace?")).then(function(){return f["delete"](m.current)})},this.rename=function(){a.edited=angular.copy(m.current)},this.afterRename=function(){f.getActive()}}return a.$inject=["$scope","desks","dashboardWidgets","api","session","workspaces","modal","gettext"],angular.module("superdesk.dashboard",["superdesk.activity","superdesk.dashboard.widgets","superdesk.dashboard.grid","superdesk.dashboard.world-clock","superdesk.workspace.tasks","superdesk.itemList","superdesk.legal_archive","superdesk.workspace"]).controller("DashboardController",a).filter("wcodeFilter",function(){return function(a,b){return _.pick(a,_.difference(_.keys(a),_.keys(b)))}}).config(["superdeskProvider",function(a){a.activity("/workspace",{label:gettext("Workspace"),description:gettext("Customize your widgets and views"),controller:"DashboardController",controllerAs:"dashboard",templateUrl:"scripts/superdesk-dashboard/views/workspace.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",priority:-1e3,adminTools:!1,category:a.MENU_MAIN})}])}(),function(){"use strict";function a(a){a.configuration=_.clone(a.widget.configuration),a.saveConfig=function(){a.widget.configuration=a.configuration,a.save(),a.$close()}}a.$inject=["$scope"],angular.module("superdesk.dashboard").directive("sdWidget",["$modal","asset",function(b,c){return{templateUrl:c.templateUrl("superdesk-dashboard/views/widget.html"),restrict:"A",replace:!0,transclude:!0,scope:{widget:"=",save:"&"},link:function(c,d,e){c.openConfiguration=function(){b.open({templateUrl:"scripts/superdesk-dashboard/views/configuration.html",controller:a,scope:c})}}}}])}(),function(){"use strict";angular.module("superdesk.dashboard.grid",[]).directive("sdGrid",function(){return{scope:{status:"=",widgets:"=",save:"&"},templateUrl:"scripts/superdesk-dashboard/grid/views/grid.html",controller:["$scope",function(a){this.addWidget=function(b,c){b.active=!0,b.el=a.gridster.add_widget(c,b.sizex,b.sizey,b.col,b.row)},this.removeWidget=function(b,c){a.gridster.remove_widget(c),b.active=!1,a.syncWidgets()},this.resizeWidget=function(b,c,d){a.gridster.resize_widget(b,c,d),a.syncWidgets()}}],link:function(a,b,c){a.syncWidgets=function(){angular.forEach(a.widgets,function(b){if(b.active){var c=a.gridster.serialize(b.el);angular.extend(b,{row:c[0].row,col:c[0].col,sizex:c[0].size_x,sizey:c[0].size_y})}})};var d=b.find("ul");a.gridster=d.gridster({widget_margins:[20,20],widget_base_dimensions:[320,250],min_rows:3,min_cols:3,draggable:{stop:function(b,c,d){a.syncWidgets()}}}).data("gridster"),a.$watch("status",function(b){a.gridster&&(b===!0?a.gridster.enable():a.gridster.disable())})}}}).directive("sdGridItem",function(){return{require:"^sdGrid",transclude:!0,templateUrl:"scripts/superdesk-dashboard/grid/views/grid-item.html",link:function(a,b,c,d){d.addWidget(a.widget,b),a.removeWidget=function(){d.removeWidget(a.widget,b)},a.resizeWidget=function(a,c){switch(c){case"left":1!==a.sizex&&a.sizex--;break;case"right":a.sizex!==a.max_sizex&&a.sizex++;break;case"up":1!==a.sizey&&a.sizey--;break;case"down":a.sizey!==a.max_sizey&&a.sizey++}d.resizeWidget(b,a.sizex,a.sizey)}}}})}(),function(){"use strict";function a(a){var b={getProviderTypes:function(){return a}};return b}function b(a,b){}function c(a,b,c,d,e,f){return{templateUrl:"scripts/superdesk-search-providers/views/search-provider-config.html",link:function(g){function h(){d.search_providers.query({}).then(function(a){g.providers=e("sortByName")(a._items,"search_provider")})}g.provider=null,g.origProvider=null,g.providers=null,g.newDestination=null,g.providerTypes=a,g.save=function(){d.search_providers.save(g.origProvider,g.provider).then(function(){c.success(b("Search Provider saved.")),g.cancel()},function(a){angular.isDefined(a.data._issues)?angular.isDefined(a.data._issues["validator exception"])?c.error(b("Error: "+a.data._issues["validator exception"])):angular.isDefined(a.data._issues.search_provider)&&angular.isDefined(a.data._issues.search_provider.unique)&&c.error(b("Error: A Search Provider with type "+g.providerTypes[g.provider.search_provider]+" already exists.")):c.error(b("Error: Failed to save Search Provider."))}).then(h)},g.edit=function(a){g.origProvider=a||{},g.provider=_.create(g.origProvider)},g.remove=function(a){f.confirm(b("Are you sure you want to delete Search Provider?")).then(function(){d.search_providers.remove(a).then(function(){c.success(b("Search Provider deleted."))},function(a){angular.isDefined(a.data._message)?c.error(a.data._message):c.error(b("Error: Unable to delete Search Provider."))}).then(h)})},g.cancel=function(){g.origProvider=null,g.provider=null},h()}}}var d=angular.module("superdesk.searchProviders",["superdesk.activity"]);return d.value("providerTypes",{aapmm:"AAP Multimedia"}),a.$inject=["providerTypes"],b.$inject=["$scope","privileges"],c.$inject=["providerTypes","gettext","notify","api","$filter","modal"],d.directive("sdSearchProviderConfig",c).service("searchProviderService",a).config(["superdeskProvider",function(a){a.activity("/settings/searchProviders",{label:gettext("Search Providers"),templateUrl:"scripts/superdesk-search-providers/views/settings.html",controller:b,category:a.MENU_SETTINGS,privileges:{search_providers:1},priority:2e3})}]).config(["apiProvider",function(a){a.api("search_providers",{type:"http",backend:{rel:"search_providers"}})}]),d}();